
<canvas id="textur" onclick="canvasClicked();" width="1888" height="700"></canvas>
<script>
  window.onbeforeunload = function(){
    console.log("Leave Website");
      sendJson('/Kaesekaestchen/logout', {clientId});
      return 'Are you sure you want to leave?';
  };

  async function sendJson(url = "/", body = {}) {
    const rawResponse = await fetch(url, {
      method: 'POST',
      headers: {
        'Accept': 'application/json',
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(body)
    });
    const content = await rawResponse.json();
    return content;
  }

  //let oldId = localStorage.getItem('CLIENTIDKaesekaestchen');
  const clientId = /*oldId ? oldId : */makeid(10);
//  localStorage.setItem('CLIENTIDKaesekaestchen', clientId);

  var messageListener = null;

  async function register() {
    let response = sendJson('/Kaesekaestchen/login', {
      clientId
    });
  }

  register();
  setInterval(getMessages, 1000);

  function getMessages() {
    sendJson('/Kaesekaestchen/message-queue', {
      clientId
    }).then(messages => {
      if (messages.length > 0) console.log("MESSAGES", messages);
      messages.forEach(msg => messageListener(msg));
    });
  }

  function sendMessage(obj) {
    sendJson('/Kaesekaestchen/message', {
      clientId,
      content: obj
    });
  }

  function makeid(length) {
    var result = '';
    var characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
    var charactersLength = characters.length;
    for (var i = 0; i < length; i++) {
      result += characters.charAt(Math.floor(Math.random() * charactersLength));
    }
    return result;
  }


  var room = {
    setOnMessageListener(listener) {
      messageListener = listener;
    },
    send(msg) {
      sendMessage(msg);
    }
  };

  var player = {colours: ["green", "blue", "red", "yellow"]};
  var field = [];
  var canvas = textur.getContext('2d'); //Dimension
  function completedCheck(message) {
    if (message.data.y > -1 && message.data.x > -1 && !field[message.data.x][message.data.y].completed && (!(isNaN("" + field[message.data.x][message.data.y].left)) || field[message.data.x][message.data.y].left == "border") && (!(isNaN("" + field[message.data.x][message.data.y].top)) || field[message.data.x][message.data.y].top == "border") && (field[message.data.x + 1] === undefined || !(isNaN("" + field[message.data.x + 1][message.data.y].left)) || field[message.data.x + 1][message.data.y].left == "border") && (field[message.data.x][message.data.y + 1] === undefined || !(isNaN("" + field[message.data.x][message.data.y + 1].top)) ||
    field[message.data.x][message.data.y + 1].top == "border")) {field[message.data.x][message.data.y].completed = message.player; player.gepunktet = true;}
    if (message.data.y > -1 && message.data.x > -1) console.log("completed: " + field[message.data.x][message.data.y].completed);
  }
  function spielerwechsel() {
    player.aktuell = playerAktuellAblage;
    player.aktuell++;
    if (player.aktuell == player.total) player.aktuell = 0;
    room.send({
      message: {
        "type": "Reihenfolge",
        "data": player.aktuell,
        alert: true
      }
    });
  }
  room.setOnMessageListener(function(message) {
    if (message.type == "gewonnen") showResult(message.data, 0);
    if (message.type == "sideAdded") {
      field[message.data.x][message.data.y][message.data.side] = message.player;
      player.gepunktet = false;
      completedCheck(message);
      message.data.x--;
      completedCheck(message);
      message.data.y--;
      message.data.x++;
      completedCheck(message);
      if (!player.gepunktet && player.myNumber == playerAktuellAblage) spielerwechsel();
      else  {player.aktuell = playerAktuellAblage; layout();}
  //    else layout();
    }
    if (message.type == "Reihenfolge") {
      player.aktuell = message.data;
      playerAktuellAblage = message.data;
      if (message.alert) layout();
    }
    if (message.type == "spielerDu") player.myNumber = message.data;
    if (message.type == "AnzahlSpieler") {
      player.total = message.data;
      for (var i = 0; i < 10 + 2*(message.data - 2); i++) {
        field[i] = [];
        for (var i1 = 0; i1 < 10 + 2*(message.data - 2); i1++) {
          field[i][i1] = {left: false/*, right: false*/, top: false/*, bottom: false*/, completed: false};
          if (i == 0) field[i][i1].left = "border";
          // if (i == 10 + 2*(message.data - 2) - 1) field[i][i1].right = "border";
          if (i1 == 0) field[i][i1].top = "border";
        //  if (i1 == 10 + 2*(message.data - 2) - 1) field[i][i1].bottom = "border";
        }
      }
      layout();
    }
  });
  function showResult(gewinner, times) {
    if (player.myNumber == gewinner) {
      console.log("Du hast gewonnen!!!");
      if (times == 0) {
          var audio = new Audio("https://adi.nicolaiweitkemper.de/Sounds/longEpicVictorySound.mp3");
          audio.currentTime = 9.0;
          audio.play();
      }//audio = new Audio(/*"https://soundbible.com/mp3/Ta Da-SoundBible.com-1884170640.mp3"*/"https://adi.nicolaiweitkemper.de/Sounds/old-victory-sound-roblox-youtubemp3free.org.mp3").play();
        canvas.fillStyle = "green";
        canvas.fillRect(0, 0, 1847, 973);
        var Bild = new Image();
        Bild.src = "https://adi.nicolaiweitkemper.de/Bilder/Gewinnerbildschirm.jpeg";
        canvas.drawImage(Bild, 260, 0);
    } else {
      console.log("Du hast verloren!!!");
      canvas.fillStyle = "red";
      canvas.fillRect(0, 0, 1847, 973)
      var Bild = new Image();
      Bild.src = "https://adi.nicolaiweitkemper.de/Bilder/Verloren%20Bildschirm.jpg"
      canvas.drawImage(Bild, 260, 0);
      if (times == 0)  {var audio = new Audio("https://adi.nicolaiweitkemper.de/Sounds/FAIL%20SOUND%20EFFECT.mp3").play(); reset();}
    }
    setTimeout(function () {
      if (times < 5) showResult(gewinner, times + 1,);
    }, 500);
  }
  function layout() {
    var freeFields = 0;
    var pointsPlayer = [];
    for (var i = 0; i < 10 + 2*(player.total - 2); i++) {
      for (var i1 = 0; i1 < 10 + 2*(player.total - 2); i1++) {
        if (field[i][i1].left == "border" || field[i][i1].left === false) canvas.fillStyle = "black";
        else canvas.fillStyle = player.colours[field[i][i1].left];
        canvas.fillRect(10 + 50*i, 10 + 50*i1, 10, 50);
        if (field[i][i1].top == "border" || field[i][i1].top === false) canvas.fillStyle = "black";
        else canvas.fillStyle = player.colours[field[i][i1].top];
        canvas.fillRect(10 + 50*i, 10 + 50*i1, 50, 10);
        // if (field[i][i1].right == "border" || !field[i][i1].right) canvas.fillStyle = "black";
        // else canvas.fillStyle = player.colours[field[i][i1].right];
        // canvas.fillRect(10 + 50*i + 50, 10 + 50*i1, 10, 50);
        // if (field[i][i1].bottom == "border" || !field[i][i1].bottom) canvas.fillStyle = "black";
        // else canvas.fillStyle = player.colours[field[i][i1].bottom];
        // canvas.fillRect(10 + 50*i, 10 + 50*i1 + 50, 50, 10);
        if (!(field[i][i1].completed === false)) {
          if (!pointsPlayer[field[i][i1].completed]) pointsPlayer[field[i][i1].completed] = 0;
          pointsPlayer[field[i][i1].completed]++;
          canvas.strokeStyle = player.colours[field[i][i1].completed];
          canvas.lineWidth = 7;
          canvas.beginPath();
          canvas.moveTo(10 + 50*i + 10, 10 + 50*i1 + 10);
          canvas.lineTo(10 + 50*i + 10 + 50, 10 + 50*i1 + 10 + 50);

          canvas.moveTo(10 + 50*i + 50, 10 + 10 + 50*i1);
          canvas.lineTo(10 + 50*i, 10 + 50*i1 + 10 + 50);
          canvas.stroke();
        }
        else {
          freeFields++;
        }
      }
    }
    canvas.fillStyle = "black";
    canvas.fillRect(10 + (10 + 2*(player.total - 2))*50, 10, 10, 50*(10 + 2*(player.total - 2)));
    canvas.fillStyle = "black";
    canvas.fillRect(10, 10 + (10 + 2*(player.total - 2))*50, 50*(10 + 2*(player.total - 2)) + 10, 10);
    // check winner
    var highest = {};
    for (var i = 0; i < Object.keys(pointsPlayer).length; i++) {
      if (!highest.number || pointsPlayer[Object.keys(pointsPlayer)[i]] > highest.number) {highest.number = pointsPlayer[Object.keys(pointsPlayer)[i]]; highest.player = Object.keys(pointsPlayer)[i];}
    }
    if (freeFields == 0) {
      room.send({
        message: {
          "type": "gewonnen",
          data: highest.player
        }
      });
    }
  }
  var playerAktuellAblage;
  function canvasClicked() {
    if (player.aktuell == player.myNumber && checkClicked() != undefined && field[checkClicked().x][checkClicked().y][checkClicked().side] === false) {
      room.send({
        message: {
          "type": "sideAdded",
          "data": checkClicked(),
          player: player.myNumber
        }
      });
      playerAktuellAblage = JSON.parse(JSON.stringify(player.aktuell))
      player.aktuell = -1;
    }
  }
  var xMaus;
  var yMaus;
  function readMouseMove(e) {
    xMaus = e.clientX + scrollX;
    yMaus = e.clientY + scrollY;
    //    console.log(xMaus + " - " + yMaus);
  }
  document.onmousemove = readMouseMove
  function checkClicked() {
    for (var i = 0; i < 10 + 2*(player.total - 2); i++) {
      for (var i1 = 0; i1 < 10 + 2*(player.total - 2); i1++) {
        if (xMaus > 9 + 50*i && xMaus < 9 + 50*i + 50 + 12 && yMaus > 9 + 50*i1 && yMaus < 9 + 50*i1 + 10 + 12) return {side: "top", x: i, y: i1}
        if (xMaus > 9 + 50*i && xMaus < 9 + 50*i + 10 + 12 && yMaus > 9 + 50*i1 && yMaus < 9 + 50*i1 + 50 + 12) return {side: "left", x: i, y: i1}
      }
    }
  }

</script>
