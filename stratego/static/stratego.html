<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
<meta charset="utf-8">
<canvas id="textur" width="1566" height="744"></canvas>
<input type="text" onfocus="console.log('Tesxtbox betreten'); textBoxSelected = true;" id="message" placeholder="message">
<button type="button" id="submit" onclick="submit()" name="button">send</button>
<input type="checkbox" id="zeichenZuEmogis" onchange="showChat();" checked="true"> <h3 id="zeichenZuEmogisT">Emojis aus Zeichen konvertieren</h3>
<div id="aufstellungDiv">
  <h1 id="aufstellungsText">gespeicherte Aufstellungen</h1>
  <div id="app">
  <li v-for="title in db" id="kathegorien">
    {{ title }}
  </li>
  </div>
</div>
<script>

  window.onbeforeunload = function() {
    console.log("Leave Website");
    sendJson('/stratego/logout', {
      clientId
    });
    return 'Are you sure you want to leave?';
  };
  document.getElementById('submit').style.position = "absolute";
  // anonymSchreiben.style.position = "absolute";
  document.getElementById('zeichenZuEmogis').style.position = "absolute";
  // anonymSchreibenT.style.position = "absolute";
  document.getElementById('zeichenZuEmogisT').style.position = "absolute";
  message.style.position = "absolute";
  message.style.top = "810";
  message.style.left = "10";
  document.getElementById('submit').style.top = "810";
  document.getElementById('submit').style.left = "185";
  // anonymSchreiben.style.top = "793";
  zeichenZuEmogis.style.top = "810";
  // anonymSchreiben.style.left = "233";
  zeichenZuEmogis.style.left = "233";
  // anonymSchreibenT.style.top = "773";
  zeichenZuEmogisT.style.top = "790";
  // anonymSchreibenT.style.left = "253";
  zeichenZuEmogisT.style.left = "257";
var links = {pictures: {bomb: "https://adi.nicolaiweitkemper.de/Bilder/bomb.png", redFlag: "https://adi.nicolaiweitkemper.de/Bilder/redFlag.png", blueFlag: "https://adi.nicolaiweitkemper.de/Bilder/blueFlag.png"}, sounds: {march: "https://adi.nicolaiweitkemper.de/Sounds/GERMAN%20TROOPS%20MARCH%20INTO%20RHINELAND%20-%20SOUND.mp3", swardFight: "https://soundbible.com/mp3/rage_of_blades-Blaga_Saun-1763516257.mp3", badLaugh: "https://soundbible.com/mp3/Jolly%20Laugh-SoundBible.com-874430997.mp3", crying: "https://soundbible.com/mp3/woman-crying-daniel_simon.mp3"}}
var Bild = new Image();
var canvas = document.getElementById('textur').getContext('2d'); //Dimension
var roundStatus = ["none"];
var koordinaten = [];
var myId;
var opponentId;
var idsBleibt = [];
var typed = "";
var audio;
var colorsModes = {normal: ["#BC750A", "green"], special: ["green", "#DF0174"]}
var colors = colorsModes.normal
var playerMoved = [false];
var xMaus = 0;
var yMaus = 0;
var hinzuf√ºgenX = 0;
var hinzuf√ºgenY = 0;
var player = [{number: 0, anzahl: 1}, {number: 1, anzahl: 1},{number: 2, anzahl: 8},{number: 3, anzahl: 5},{number: 4, anzahl: 4},{number: 5, anzahl: 4},{number: 6, anzahl: 4},{number: 7, anzahl: 3},{number: 8, anzahl: 2},{number: 9, anzahl: 1}, {number: 10, anzahl: 1}, {number: 11, anzahl: 6}];
var spielfeldList = [];
var spielfeld = [];
    spielfeld[0] = [["land", 5]];
    spielfeld[1] = [["land", 5]];
    spielfeld[2] = [["land", 4], ["water", 1]];
    spielfeld[3] = [["land", 4], ["water", 1]];
    spielfeld[4] = [["land", 5]];

// 1/4 (type, wie oft von links nach rechts)
var AblageListe = [];
    AblageListe[0] = [];
var z√§hlerListe = [];
var messages = [];
var viewingMessages = false;
if (localStorage.getItem("aufstellungenStratego") != undefined && localStorage.getItem("aufstellungenStratego") != "undefined") {
var app = new Vue({
  el: '#app',
  data: {
    db: Object.keys(JSON.parse(localStorage.getItem("aufstellungenStratego")))
  }
})
}
else {
  kathegorien.style.display = "none";
  aufstellungsText.innerHTML = "Keine gespeicherte Aufstellungen";
  var app = new Vue({
    el: '#app',
    data: {
      db: []
    }
  })
}
// Ausschreiben
for (var i = 0; i < spielfeld.length; i++) {
  AblageListe[0][i] = [];
  for (var i1 = 0; i1 < spielfeld[i].length; i1++) {
    for (var i2 = 0; i2 < spielfeld[i][i1][1]; i2++) {
      AblageListe[0][i][AblageListe[0][i].length] = {type: spielfeld[i][i1][0], player: false};
      // AblageListe[0][i].push(spielfeld[i][i1][0]);
    }
  }
}
// Spieglung nach unten
for (var i = spielfeld.length - 1; i > -1; i--) {
  AblageListe[0].push(AblageListe[0][i]);
}
spielfeld = JSON.parse(JSON.stringify(AblageListe[0]));
// Spieglung nach rechts
for (var i = 0; i < spielfeld.length - 5; i++) {
//  console.log(AblageListe[0]);
  for (var i1 = spielfeld[i].length - 1; i1 > -1; i1--) {
    AblageListe[0][i].push(spielfeld[i][i1]);
  }
}
console.log(AblageListe[0]);
spielfeld = JSON.parse(JSON.stringify(AblageListe[0]));

  async function sendJson(url = "/", body = {}) {
    const rawResponse = await fetch(url, {
      method: 'POST',
      headers: {
        'Accept': 'application/json',
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(body)
    });
    const content = await rawResponse.json();
    return content;
  }
  // sendJson('/logout', {
  //   clientId
  // });

  let oldId = localStorage.getItem('CLIENTIDStratego');
  const clientId = oldId ? oldId : makeid(10);
  localStorage.setItem('CLIENTIDStratego', clientId);
  var messageListener = null;

  async function register() {
    let response = sendJson('/stratego/login', {
      clientId
    });
  }

  register();
  setInterval(getMessages, 1000);

  function getMessages() {
    sendJson('/stratego/message-queue', {
      clientId
    }).then(messages => {
      if (messages.length > 0) {
        console.log("MESSAGES", messages);
      }
      messages.forEach(msg => messageListener(msg));
    });
  }

  function sendMessage(obj) {
    sendJson('/stratego/message', {
      clientId,
      content: obj
    });
  }

  function makeid(length) {
    var result = '';
    var characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
    var charactersLength = characters.length;
    for (var i = 0; i < length; i++) {
      result += characters.charAt(Math.floor(Math.random() * charactersLength));
    }
    return result;
  }


  var room = {
    setOnMessageListener(listener) {
      messageListener = listener;
    },
    send(msg) {
      sendMessage(msg);
    }
  };


  // listen to patches coming from the server
  room.setOnMessageListener(function(message) {
    if (message.type == "endGame" && message.alert != false) {removeGame(false, false); alert("somebody doesn't want to continue playing, so the game ends!")}
    if (message.type == "messages") {
      messages = message.data

      textur.height = 844 + messages.length*44;
      Layout(false, 0);
      if (!(myId == message.sender)) audio = new Audio("https://adi.nicolaiweitkemper.de/Sounds/ding-sound-effect-youtubemp3free.org.mp3").play();
      AblageListe[1] = "warten Message angucken";
      setTimeout(function () {
        AblageListe[1] = "beendet";
      }, 3777);
    };
    if (message.type == "gewonnen") {
      if (message.siegDurch == "Niederlage" && message.data != myId) {
        for (var i = 0; i < spielfeld.length; i++) {
          for (var i1 = 0; i1 < spielfeld[i].length; i1++) {
            if (spielfeld[i][i1].player.id == opponentId && spielfeld[i][i1].player.number == 0) {
              Bild.src = links.pictures["redFlag"];
              var flagCoordinates = {x: i, y: i1}
              canvas.drawImage(Bild, 477 + 70*i, 17 + 70*i1, 60, 60);
              setTimeout(function () {
                Bild.src = links.pictures["redFlag"];
                canvas.drawImage(Bild, 477 + 70*flagCoordinates.x, 17 + 70*flagCoordinates.y, 60, 60);
                setTimeout(function () {
                  Bild.src = links.pictures["redFlag"];
                  canvas.drawImage(Bild, 477 + 70*flagCoordinates.x, 17 + 70*flagCoordinates.y, 60, 60);
                }, 500);
              }, 500);
            }
          }
        }
        var messageAblage = {data: message.data, siegDurch: message.siegDurch}
        setTimeout(function () {
          showResults(messageAblage.data, 0, messageAblage.siegDurch); removeGame(true, false);
        }, 5000);
      }
      else showResults(message.data, 0, message.siegDurch);
    }
    if (message.type.includes("player") && message.rejoin && JSON.parse(localStorage.getItem('spielfeldStratego')) != undefined && JSON.parse(localStorage.getItem('spielfeldStratego')) != "undefined" &&  confirm("wollen sie die vorherige Runde weiterspielen?")) {
      spielfeld = JSON.parse(localStorage.getItem("spielfeldStratego"));
      player = JSON.parse(localStorage.getItem("playerStratego"));
      ids = JSON.parse(localStorage.getItem("idsStratego"));
      roundStatus = JSON.parse(localStorage.getItem("roundStatusStratego"));
      spielfeldList = JSON.parse(localStorage.getItem("spielfeldListStratego"));
      idsBleibt = JSON.parse(localStorage.getItem('idsBelibtStratego'));
      Layout();
    }
    else if (message.type.includes("player") && message.rejoin) {
      room.send({
        message: {
          "type": "endGame"
        }
      });
    }
    else if (message.type.includes("player")) {
      localStorage.setItem("roundStatusStratego", JSON.stringify(roundStatus/*message.data*/));
    }
    if (message.type == "player1") {myId = idsBleibt[0]; opponentId = idsBleibt[1];}
    if (message.type == "player2") {myId = idsBleibt[1]; opponentId = idsBleibt[0];}
    if (message.type == "positionBefore" && myId != ids[0]) {
      setTimeout(function () {
        if (spielfeldList.length == 0) spielfeldList.push(JSON.parse(JSON.stringify(spielfeld)));
        if (spielfeldList[spielfeldList.length - 1].after && !spielfeldList[spielfeldList.length - 1].before) spielfeldList[spielfeldList.length - 1].before = message.data;
        else spielfeldList.push(JSON.parse(JSON.stringify({before: message.data})));
        localStorage.setItem("spielfeldListStratego", JSON.stringify(spielfeldList));
        canvas.fillStyle = colors[1];
        canvas.globalAlpha = 0.5;
        canvas.fillRect(477 + 70*message.data[0], 17 + 70*message.data[1], 60, 60);
        canvas.globalAlpha = 1;
      }, 3333);
    }
    if (message.type == "onLeave") idsBleibt = [];
    if (message.type == "playerMoved" && spielfeldList.length == 0) spielfeldList.push(JSON.parse(JSON.stringify(spielfeld)));
    if (message.type == "playerMoved" && (!spielfeldList[spielfeldList.length - 1] || spielfeldList[spielfeldList.length - 1].after)) spielfeldList.push(JSON.parse(JSON.stringify({after: message.data})));
    else if (message.type == "playerMoved") spielfeldList[spielfeldList.length - 1].after = message.data;
    if (message.type == "playerMoved" && myId == ids[0]) {
      playerMoved = [true, message.data[0], message.data[1]];
      canvas.fillStyle = colors[1];
      canvas.fillRect(477 + 70*message.data[0], 17 + 70*message.data[1], 60, 60);
      audio = new Audio(links.sounds.march);
      audio.currentTime = 50;
      audio.play();
      setTimeout(function () {
        audio.pause();
      }, 333);
    }
    if (message.type == "spielerIds")  {
      setTimeout(function () {
        console.log(spielfeldList[spielfeldList.length - 1]);
      }, 3333);
       ids = message.data;
       localStorage.setItem("idsStratego", JSON.stringify(ids));
       positionShowed = false;
      if (idsBleibt.length == 0)  {
        idsBleibt = JSON.parse(JSON.stringify(ids));
        localStorage.setItem('idsBelibtStratego', JSON.stringify(idsBleibt));
      }
  //    if (playerMe == 1) myId = idsBleibt[0]
  //    if (playerMe == 2) myId = idsBleibt[1]
    }
    if (message.type == "spielfeldBottom") {
      for (var i = 0; i < spielfeld.length; i++) {
        for (var i1 = 6; i1 < spielfeld.length; i1++) {
          spielfeld[i][i1] = message.data[i][i1];
        }
      }
    }
    if (message.type == "spielfeldTop") {
      for (var i = 0; i < spielfeld.length; i++) {
      for (var i1 = 0; i1 < 4; i1++) {
        spielfeld[i][i1] = message.data[i][i1];
      }
    }
    }
    if (message.type == "spielfeld")  {
      if (!(myId == message.idSender))  {
        spielfeld = message.data;
        localStorage.setItem("spielfeldStratego",JSON.stringify(message.data));
        localStorage.setItem("roundStatusStratego", JSON.stringify(roundStatus/*message.data*/));
      }
  //    if (!(roundStatus[0] == "showRewardsAttack"))  Layout(false, 0);
      }
    if (message.type == "roundStatus"/* && myId == ids[1]*/) {
      // for (var i = 0; i < message.data.length; i++) {
      //   roundStatus[i] = message.data[i];
      // }
    //  Layout(false, 0);
    roundStatus = message.data;
    localStorage.setItem("roundStatusStratego", JSON.stringify(message.data));
    }
    if (message.type == "showNumber"/* && myId == ids[1]*/) {
      if (myId == ids[1])  canvas.fillStyle = "red";
      else canvas.fillStyle = colors[1];
      canvas.fillRect(477 + 70*message.data.oldSpot[0], 17 + 70*message.data.oldSpot[1], 60, 60);
      showIcon(message.data.oldSpot, message.data.numberOldSpot);
      if (myId == ids[1])  canvas.fillStyle = colors[1];
      else  canvas.fillStyle = "red";
      canvas.fillRect(477 + 70*message.data.newSpot[0], 17 + 70*message.data.newSpot[1], 60, 60);
      showIcon(message.data.newSpot, message.data.numberNewSpot);
      audio = new Audio(links.sounds.swardFight);
      audio.currentTime = 0;
      audio.volume = 0.5;
      audio.play();
      setTimeout(function () {
        audio.pause();
      }, 1033);
    }
    if (!(roundStatus[0] == "showRewardsAttack") && !(roundStatus[0] == "movePlayer") && !(roundStatus[0] == "playerMoved"))  Layout(false, 0)
  });
  function showResults(gewinner, times, siegDurch) {
    if (myId == gewinner) {
      console.log("Du hast gewonnen!!!");
      if (times == 0) audio = new Audio(/*"https://soundbible.com/mp3/Ta Da-SoundBible.com-1884170640.mp3"*/"https://adi.nicolaiweitkemper.de/Sounds/old-victory-sound-roblox-youtubemp3free.org.mp3").play();
        canvas.fillStyle = "green";
        canvas.fillRect(0, 0, 1847, 973);
        Bild.src = "https://adi.nicolaiweitkemper.de/Bilder/Gewinnerbildschirm.jpeg";
        canvas.drawImage(Bild, 260, 0);
    } else {
      console.log("Du hast verloren!!!");
      canvas.fillStyle = "red";
      canvas.fillRect(0, 0, 1847, 973)
      Bild.src = "https://adi.nicolaiweitkemper.de/Bilder/Verloren%20Bildschirm.jpg"
      canvas.drawImage(Bild, 260, 0);
      if (times == 0)  audio = new Audio("https://adi.nicolaiweitkemper.de/Sounds/FAIL%20SOUND%20EFFECT.mp3").play();
    }
    setTimeout(function () {
      if (times < 5) showResults(gewinner, times + 1, siegDurch);
      else if (myId == gewinner) alert("Sieg durch " + siegDurch);
    }, 500);
    if (times == 0) {
    setTimeout(function () {
      if (confirm("Wollen sie diese Runde als Replay festhalten? Sie k√∂nnen es sich sp√§ter auf ihrem Ger√§t unter express-games/playbacks/stratego.html angucken.")) {
        if (localStorage.getItem("playBacksStratego")) var replays = JSON.parse(localStorage.getItem("playBacksStratego"));
        else var replays = {};
        for (var i = 0; i < spielfeldList.length; i++) {
          if (spielfeldList[i].before && !spielfeldList.after) spielfeldList.splice(i,1);
        }
        replays[prompt("Wie wollen sie ihr Replay nennen?")] = {spielfeld: spielfeldList, idsBleibt: idsBleibt, myId: myId, opponentId: opponentId};
        localStorage.setItem("playBacksStratego", JSON.stringify(replays));
      }
    }, 2222);
  }
  }
roundStatus[0] = "placePlayer";
function submit() {
  messages.push(document.getElementById('message').value);
  room.send({
    message: {
    type: "messages",
    data: messages,
    sender: myId
  }
  });
  message.value = "";
  // setTimeout(function () {
  //     window.scroll(scrollX, 10000)
  //     document.getElementById('message').select();
  // }, 3000);
}
function removeGame(sendEnd, alert) {
  if (sendEnd) {
  room.send({
    message: {
      "type": "endGame",
      alert: alert
    }
  });
}
}
function Layout(sync, time) {
  canvas.fillStyle = "#FA9B0D";
  // background colour: #FA9B0D
  canvas.fillRect(0, 0, document.getElementById('textur').width, document.getElementById('textur').height);
  AblageListe[2] = {"land": /*"#BC750A" "green"*/colors[0], "water": "#0CD6E1"}; // colours ground types
  AblageListe[1] = [];
  if (!(roundStatus[0] == "placePlayer")) {
    AblageListe[3] = [[{number: 0, anzahl: 0}, {number: 1, anzahl: 0},{number: 2, anzahl: 0},{number: 3, anzahl: 0},{number: 4, anzahl: 0},{number: 5, anzahl: 0},{number: 6, anzahl: 0},{number: 7, anzahl: 0},{number: 8, anzahl: 0},{number: 9, anzahl: 0}, {number: 10, anzahl: 0}, {number: 11, anzahl: 0}], [{number: 0, anzahl: 0}, {number: 1, anzahl: 0},{number: 2, anzahl: 0},{number: 3, anzahl: 0},{number: 4, anzahl: 0},{number: 5, anzahl: 0},{number: 6, anzahl: 0},{number: 7, anzahl: 0},{number: 8, anzahl: 0},{number: 9, anzahl: 0}, {number: 10, anzahl: 0}, {number: 11, anzahl: 0}]];
  }
  for (var i1 = 0; i1 < spielfeld.length; i1++) {
    for (var i = 0; i < spielfeld.length; i++) {
      if (roundStatus[0] == "movePlayer" && i == roundStatus[1][0] && i1 == roundStatus[1][1]) {
        canvas.fillStyle = "#FC2600";
        canvas.fillRect(477 + 70*roundStatus[1][0] - 10, 17 + 70*roundStatus[1][1] - 10, 80, 80);
      }
    canvas.fillStyle = AblageListe[2][spielfeld[i][i1].type];
    if (!(spielfeld[i][i1].player == false)) {
      if (spielfeld[i][i1].player.id == myId/* || (roundStatus[0] == "movePlayer" && roundStatus[1][0] == i && roundStatus[1][1] == i1)*/) {
      if (roundStatus[0] == "showRewardsAttack" && roundStatus[1][0] == i && roundStatus[1][1] == i1) {
        canvas.fillStyle = "#FC2600";
      }
      else {
        canvas.fillStyle = "blue";
      }
      AblageListe[1].push([i, i1]);
      setTimeout(function () {
        if (AblageListe[1].length > 0/* && (spielfeld[AblageListe[1][0][0]][AblageListe[1][0][1]].player.number == 0 || spielfeld[AblageListe[1][0][0]][AblageListe[1][0][1]].player.number == 11)*/) {
          // setTimeout(function () {
          //   if (loadPicture == false) {
          //   Layout(true, 0)true);
          // }
          // }, 100);
          showIcon(AblageListe[1][0], spielfeld[AblageListe[1][0][0]][AblageListe[1][0][1]].player.number);
        AblageListe[1].shift();
    }
    }, 10);
  }
    else canvas.fillStyle = "#FC2600";
  }
    else if (!(spielfeld[i][i1].player == false))  canvas.fillStyle = "#FC2600";
    canvas.fillRect(477 + 70*i, 17 + 70*i1, 60, 60);
    if (!(roundStatus[0] == "placePlayer") && !(spielfeld[i][i1].player == false) && spielfeld[i][i1].player.id == myId) {
      AblageListe[3][0][spielfeld[i][i1].player.number].anzahl++;
    }
    else if (!(roundStatus[0] == "placePlayer") && !(spielfeld[i][i1].player == false)) {
      AblageListe[3][1][spielfeld[i][i1].player.number].anzahl++;
    }
  }
  }
  if (playerMoved[0] == true) {
    canvas.fillStyle = colors[1];
    canvas.fillRect(477 + 70*playerMoved[1], 17 + 70*playerMoved[2], 60, 60);
  }
  koordinaten[2] = 0;
  if (!(roundStatus[0] == "placePlayer")) player = AblageListe[3][0];
  showStats();
  koordinaten[2] = 1290;
  if (!(roundStatus[0] == "placePlayer")) player = AblageListe[3][1];
  if (!(roundStatus[0] == "placePlayer")) showStats();
  if (sync == true && !(roundStatus[0] == "showRewardsAttack")) {
    syncData();
  }
    Bild = new Image();
    if (roundStatus[0] != "placePlayer") {Bild.src = "https://adi.nicolaiweitkemper.de/Bilder/whiteFlag.png"; aufstellungDiv.style.display = "none";}
    else Bild.src = "https://adi.nicolaiweitkemper.de/Bilder/saveField.png";
    canvas.drawImage(Bild, 222, 300, 100, 100);
  showChat();
  // if (time < 2) {
  //   setTimeout(function () {
  //     Layout(sync, time + 1);
  //   }, 50);
  // }
}
function showChat() {
  // for (var i = 0; i < messages.length; i++) {
  //   // if (!(messages[messages.length - 1 - i] == undefined)) {
  //   canvas.fillStyle = "white";
  //   canvas.font = "33px Georgia";
  //   canvas.fillText(messages[messages.length - 1 - i], 33, 788 + 44*i);
  // }
  canvas.fillStyle = "#BC750A";
  canvas.fillRect(0, 822, 10000, 10000);
  for (var i = 0; i < messages.length; i++) {
  // if (!(messages[messages.length - 1 - i] == undefined)) {
  canvas.fillStyle = "white";
  canvas.font = "33px Georgia";
  var messagesBearbeitet = JSON.parse(JSON.stringify(messages[messages.length - 1 - i]));
  var emojiObj = {":)": "üòä", ":(": "üòû", ":p": "üòõ", "XD": "üòÜ", ":o": "üò≤"};
  if (zeichenZuEmogis.checked) {
    for (var i1 = 0; i1 < Object.keys(emojiObj).length; i1++) {
      messagesBearbeitet = messagesBearbeitet.replace(Object.keys(emojiObj)[i1], emojiObj[Object.keys(emojiObj)[i1]]);
    }
  }
  canvas.fillText(messagesBearbeitet, 33, 844 + 11 + 44*i);
}
  }
function showIcon(coordinates, number) {
  Bild = new Image();
  if (number == 0) {
  if (spielfeld[coordinates[0]][coordinates[1]].player.id == myId)  Bild.src = links.pictures["blueFlag"];
  else Bild.src = links.pictures["redFlag"];
    canvas.drawImage(Bild, 477 + 70*coordinates[0], 17 + 70*coordinates[1], 60, 60)
  }
  else if (number == 11) {
    Bild.src = links.pictures["bomb"];
    canvas.drawImage(Bild, 477 + 70*coordinates[0], 17 + 70*coordinates[1], 60, 60)
  }
  else {
    canvas.fillStyle = "white";
    canvas.font = "37px Georgia";
    canvas.fillText(number, 477 + 70*coordinates[0] + 22, 17 + 70*coordinates[1] + 40);
  }
}

function syncData() {
  var flaggsOnField = 0;
  for (var i = 0; i < spielfeld.length; i++) {
    for (var i1 = 0; i1 < spielfeld[i].length; i1++) {
      if (spielfeld[i][i1].player && spielfeld[i][i1].player.number == 0) flaggsOnField++;
    }
  }
  if (flaggsOnField == 2) {
  room.send({
    message: {
      "type": "spielfeld",
      "data": spielfeld,
      "idSender": myId
    }
  });
}
}
function aufstellungSpeichern() {
  // myId == idsBleibt[0]) canvas.fillText("your side: bottom", 157, 97);
  var i = 0;
  var fieldSave = {field: [], bottom: false};
  var minus = 0;
  var lowestPoint = 6;
  if (myId == idsBleibt[0]) {i = 6; minus = 6; fieldSave.bottom = true; lowestPoint = 0;}
  for (i; i < (10 - lowestPoint); i++) {
    for (var i1 = 0; i1 < 10; i1++) {
      if (!fieldSave.field[i1]) fieldSave.field[i1] = [];
      fieldSave.field[i1][i - minus] = spielfeld[i1][i];
    }
  }
  fieldSave.player = player;
  var aufstellungen = {};
  if (JSON.parse(localStorage.getItem("aufstellungenStratego")) != undefined) aufstellungen = JSON.parse(localStorage.getItem("aufstellungenStratego"));
  var name = selectNameFieldSave(0);
  if (name != "do not save") {
  aufstellungen[name/*prompt("Wie wollen sie die Aufstellung nennen?")*/] = fieldSave;
  localStorage.setItem('aufstellungenStratego', JSON.stringify(aufstellungen));
}
  return fieldSave;
}
var name;
function selectNameFieldSave(i) {
  name = prompt("Wie wollen sie die Aufstellung nennen?");
  if (app._data.db.includes(name)) {
    if (!confirm("Sie haben eine Aufstellung bereits so genannt! Sind sie sich sicher, dass sie die andere Aufstellung mit dieser √ºberschrieben wollen? Dann klicken sie bitte auf OK. Falls nicht, klicken sie bitte auf abbrechen/cancel!")) {
      if (confirm("Wollen sie die Aufstellung dennoch unter einem anderen Namen speichern?")) selectNameFieldSave(i + 1);
      else return "do not save";
    }
  }
  if (i == 0) return name;
}
function aufstellungLaden(aufstellung) {
  if ((aufstellung.bottom && myId == idsBleibt[0]) || (!aufstellung.bottom && myId == idsBleibt[1])) {
    var i = 0;
    if (aufstellung.bottom) i += 6;
    for (var i2 = 0; i2 < aufstellung.field[0].length; i2++) {
      for (i1 = 0; i1 < aufstellung.field.length; i1++) {
        spielfeld[i1][i] = aufstellung.field[i1][i2];
      }
      i++;
    }
  }
  else {
    var i2 = -1;
    if (myId == idsBleibt[0]) i2 += 6;
    // var i;
    // if (!aufstellung.bottom)
    for (var i = aufstellung.field[0].length - 1; i > -1; i--) {
      i2++;
      for (var i1 = 0; i1 < aufstellung.field.length; i1++) {
        spielfeld[i1][i2] = aufstellung.field[i1][i];
      }
    }
  }
  Layout(false, 0);
  setTimeout(function () {
    Layout();
  }, 500);
  player = aufstellung.player;
  var playerLeft = 0;
  for (var i = 0; i < player.length; i++) {
    if (player[i].anzahl != 0) playerLeft += player[i].anzahl;
  }
  if (playerLeft == 0) {
    setTimeout(function () {
      AblageListe[3] = player.length;
      aufstellungInRunde();
    }, 1777);
  }
}
function showStats() {
  koordinaten[1] = 37;
  koordinaten[0] = 17;
  canvas.fillStyle = "white";
  canvas.font = "47px Georgia";
  if (!(roundStatus[0] == "placePlayer")) {
    canvas.fillText("your remainings", 17, 37);
    canvas.font = "43px Georgia";
    canvas.fillText("opponents remainings", 1177, 37);
    if (ids[0] == myId) canvas.fillStyle = '#3ADF00';
    else canvas.fillStyle = 'red';
    canvas.beginPath();
    canvas.arc(373, 34, 30, 0, Math.PI * 2, false);
    canvas.fill();
    canvas.fillStyle = "white";
  }
  else {
    canvas.fillText("remaining to place", 17, 37);
    player.push({number: "delete", anzahl: 1});
  }

  canvas.font = "43px Georgia";
  canvas.fillText("starken Kontrast", 170, 179);
  if (colors[0] == "#BC750A")  canvas.fillText("aktivieren", 170, 230);
  else canvas.fillText("deaktivieren", 170, 230);
  if (!(myId == undefined) && myId == idsBleibt[0]) canvas.fillText("your side: bottom", 157, 97);
  else if (!(myId == undefined)) canvas.fillText("your side: top", 157, 97);
//  ( && AblageListe[0][1] > 5) || (myId == idsBleibt[1] && AblageListe[0][1] < 4)
  canvas.font = "37px Georgia";
  for (var i = 0; i < player.length; i++) {
    for (var i1 = 0;  !(i == player.length) && player[i].anzahl < 1; i++) {
      koordinaten[1] += 94;
      if (i == 6) {
        koordinaten[0] += 77;
        koordinaten[1] = 37;
      }
    }
    if (!(roundStatus[1] == undefined) && i == roundStatus[1])  canvas.fillStyle = "#FC2600";
    else canvas.fillStyle = "white";
  if (i == 0) {
    canvas.fillText("flag", koordinaten[0] + koordinaten[2], koordinaten[1] + 50)
  }
  else if (i == 10) {
    canvas.fillText(i, koordinaten[0] + koordinaten[2], koordinaten[1] + 50)
  }
  else if (i == 11) {
    canvas.fillText("bomb", koordinaten[0] + koordinaten[2] - 13, koordinaten[1] + 50)
  }
  else if (i == 12) {
    canvas.fillText("delete", koordinaten[0] + koordinaten[2] - 13, koordinaten[1] + 50)
  }
  else {
    canvas.fillText(i, koordinaten[0] + koordinaten[2] + 13, koordinaten[1] + 50)
  }
  koordinaten[1] += 37;
  if (!(i == 12)) canvas.fillText(player[i].anzahl + "X", koordinaten[0] + koordinaten[2], koordinaten[1] + 50)
  koordinaten[1] += 57;
  if (i == 6) {
    koordinaten[0] += 77;
    koordinaten[1]= 37;
  }
}
player.pop();
}

function attack() {
  spielfeld[roundStatus[3][0]][roundStatus[3][1]].player = false; playerMoved[0] = false;//roundStatus[0] = "ingame";
  canvas.fillStyle = colors[0];
  canvas.fillRect(477 + 70*roundStatus[3][0], 17 + 70*roundStatus[3][1], 60, 60);
  if (roundStatus[2][0] == 11 && roundStatus[2][1] == 3) {
    console.log("won");
    spielfeld[roundStatus[1][0]][roundStatus[1][1]].player.number = 3;
    spielfeld[roundStatus[1][0]][roundStatus[1][1]].player.id = JSON.parse(JSON.stringify(roundStatus[4][0]));
    if (myId == roundStatus[4][0]) audio = new Audio(links.sounds.badLaugh).play();
    else {
      audio = new Audio(links.sounds.crying);
      audio.currentTime = 10;
    audio.play();
    setTimeout(function () {
    audio.pause();
    }, 1333);
    }
  }
  else if (roundStatus[2][0] == 1 && roundStatus[2][1] == 10) {
    console.log("lost");
    if (myId == roundStatus[4][1]) audio = new Audio(links.sounds.badLaugh).play();
    else {
      audio = new Audio(links.sounds.crying);
      audio.currentTime = 10;
    audio.play();
    setTimeout(function () {
    audio.pause();
    }, 1333);
    }
  }
  else if (roundStatus[2][1] == 1 && roundStatus[2][0] == 10) {
    console.log("won");
    spielfeld[roundStatus[1][0]][roundStatus[1][1]].player.number = 1;
    spielfeld[roundStatus[1][0]][roundStatus[1][1]].player.id = JSON.parse(JSON.stringify(roundStatus[4][0]));
    if (myId == roundStatus[4][0]) audio = new Audio(links.sounds.badLaugh).play();
    else {
      audio = new Audio(links.sounds.crying);
      audio.currentTime = 10;
    audio.play();
    setTimeout(function () {
    audio.pause();
    }, 1333);
    }
  }
  else if (roundStatus[2][0] < roundStatus[2][1]) {
    console.log("won");
    if (roundStatus[2][0] == 0 && ids[0] == myId) {
      room.send({
        message: {
          type: "gewonnen",
          data: myId,
          siegDurch: "Niederlage"
        }
  //    }
      });
    }
    spielfeld[roundStatus[1][0]][roundStatus[1][1]].player.number = JSON.parse(JSON.stringify(roundStatus[2][1]));
    spielfeld[roundStatus[1][0]][roundStatus[1][1]].player.id = JSON.parse(JSON.stringify(roundStatus[4][0]));
    if (myId == roundStatus[4][0]) audio = new Audio(links.sounds.badLaugh).play();
    else {
      audio = new Audio(links.sounds.crying);
      audio.currentTime = 10;
    audio.play();
    setTimeout(function () {
    audio.pause();
    }, 1333);
    }
  }
  else if (roundStatus[2][0] > roundStatus[2][1]) {
    console.log("lost");
    spielfeld[roundStatus[1][0]][roundStatus[1][1]].player.id = JSON.parse(JSON.stringify(roundStatus[4][1]));
    if (myId == roundStatus[4][1]) audio = new Audio(links.sounds.badLaugh).play();
    else {
      audio = new Audio(links.sounds.crying);
      audio.currentTime = 10;
    audio.play();
    setTimeout(function () {
    audio.pause();
    }, 1333);
    }
  }
  else {
    console.log("draw");
    canvas.fillRect(477 + 70*roundStatus[1][0], 17 + 70*roundStatus[1][1], 60, 60);
    spielfeld[roundStatus[1][0]][roundStatus[1][1]].player = false; playerMoved[0] = false;
    audio = new Audio(links.sounds.crying);
    audio.currentTime = 10;
    audio.play();
    setTimeout(function () {
      audio.pause();
    }, 1333);
  }
  roundStatus[0] = "ingame";
  Layout(false, 0);
  if (myId == idsBleibt[0]) {
    room.send({
      message: "Spielerwechsel"
    });
    ids = "inProgress";
  }
  if (spielfeldList.length == 0) spielfeldList.push(JSON.parse(JSON.stringify(spielfeld)));
  spielfeldList.push(JSON.parse(JSON.stringify({positions: [roundStatus[1], roundStatus[3]], datas: [spielfeld[roundStatus[1][0]][roundStatus[1][1]], spielfeld[roundStatus[3][0]][roundStatus[3][1]]]})));
  localStorage.setItem("spielfeldListStratego", JSON.stringify(spielfeldList));
}
window.addEventListener("dblclick", dbClick)

function dbClick() {
  if (viewingMessages == false) {window.scroll(scrollX, 742); viewingMessages = true;}
  else {window.scroll(scrollX, 0); viewingMessages = false;}
}
var textBoxSelected = false;
document.onkeydown = function(event) {
  if (event.key == "Enter" && textBoxSelected) submit();
  AblageListe[3] = [event.keyCode, event.key];
  // ev.touches[0]["pageX"] + mausxScroll) + " - " + (ev.touches[0]["pageY"] + mausyScroll
//  if (ger√§t == "PC" || (ger√§t == "Handy" && roundStatus[0] == "movePlayer" && spielfeld[roundStatus[1][0]][roundStatus[1][1]].player.number == 2 && (swipeCoordinates.includes(swipeCoordinates[0] -300) || swipeCoordinates.includes(swipeCoordinates[0] +300) || swipeCoordinates.includes(swipeCoordinates[1] -300) || swipeCoordinates.includes(swipeCoordinates[1] +300))))    folgenKeyDown();
  if (event.key == "ArrowUp") window.scroll(scrollX, 0);
  if (event.key == "Enter" && !(AblageListe[1] == "beendet")) window.scroll(scrollX, 742);
    folgenKeyDown();
}
var positionShowed = false;
function showPlayerMovement() {
  if (roundStatus[0] == "movePlayer" && AblageListe[3][1].includes("Arrow") && !positionShowed) {
    positionShowed = true;
    room.send({
      message: {
        "type": "positionBefore",
        "data": roundStatus[1]
      }
    });
  }
}
function folgenKeyDown() {
//  swipeCoordinates = [];
  typed += AblageListe[3][1]
  setTimeout(function () {
    typed = "";
  }, 2000);
  if (roundStatus[0] == "showRewardsAttack" && ger√§t == "PC" && (spielfeld[roundStatus[1][0]][roundStatus[1][1]].player.number == 2 && AblageListe[3] == roundStatus[2][0])) {
    attack();
  }
    if (AblageListe[3][0] == 13 && roundStatus[0] == "movePlayer" && spielfeld[roundStatus[3][0]][roundStatus[3][1]].player.number == 2) FinishRound();
    if (typed.includes("10")) {
      roundStatus[1] = 10;
      console.log(roundStatus[1]);
    }
    if (roundStatus[0] == "placePlayer" && AblageListe[3][0] > 48 && AblageListe[3][0] < 58 && player[AblageListe[3][0] - 48].anzahl > 0) {
      roundStatus[1] = AblageListe[3][0] - 48;
      console.log(roundStatus[1]);
    }
    if (roundStatus[0] == "placePlayer" && AblageListe[3][0] == 66 && player[11].anzahl > 0) {
      roundStatus[1] = 11;
    }
    if (roundStatus[0] == "placePlayer" && AblageListe[3][0] == 68) {
      roundStatus[1] = 12;
    }
    if (roundStatus[0] == "placePlayer" && AblageListe[3][0] == 70 && player[0].anzahl > 0) {
      roundStatus[1] = 0;
    }
    if ((direction == "finished" || spielfeld[roundStatus[3][0]][roundStatus[3][1]].player.number != 2 || direction == "left") && roundStatus[0] == "movePlayer" && AblageListe[3][0] == 37 && roundStatus[1][0] - 1 > -1 && spielfeld[roundStatus[1][0] - 1][roundStatus[1][1]].type == "land" && (spielfeld[roundStatus[1][0] - 1][roundStatus[1][1]].player == false || !(spielfeld[roundStatus[1][0] - 1][roundStatus[1][1]].player.id == myId))) {  // left
      direction = "left";
      // attack
      if (!(spielfeld[roundStatus[1][0] - 1][roundStatus[1][1]].player.id == myId) && !(spielfeld[roundStatus[1][0] - 1][roundStatus[1][1]].player == false)) {
        roundStatus[2] = JSON.parse(JSON.stringify([spielfeld[roundStatus[1][0] - 1][roundStatus[1][1]].player.number, spielfeld[roundStatus[1][0]][roundStatus[1][1]].player.number]));
        roundStatus[4] = JSON.parse(JSON.stringify(spielfeld[roundStatus[1][0]][roundStatus[1][1]].player.id));
        console.log(spielfeld[roundStatus[1][0] - 1][roundStatus[1][1]]);
      //  spielfeld[roundStatus[1][0] - 1][roundStatus[1][1]] = JSON.parse(JSON.stringify(spielfeld[roundStatus[1][0]][roundStatus[1][1]]));
        console.log(spielfeld[roundStatus[1][0] - 1][roundStatus[1][1]]);
        console.log(spielfeld[roundStatus[1][0] - 1][roundStatus[1][1]].player.number);
        spielfeld[roundStatus[1][0] - 1][roundStatus[1][1]].player.number = JSON.parse(JSON.stringify(roundStatus[2][0]));
        console.log(spielfeld[roundStatus[1][0] - 1][roundStatus[1][1]].player.number);
        roundStatus[0] = "showRewardsAttack";
        roundStatus[3] = JSON.parse(JSON.stringify(roundStatus[1]));
        roundStatus[1][0]--;
        Layout(true, 0);
        room.send({
          message: {
            "type": "roundStatus",
            "data": [roundStatus[0], roundStatus[1], roundStatus[2], roundStatus[3], [myId, opponentId]]
          }
        });
        setTimeout(function () {
          room.send({
            message: {
              type: "showNumber",
            data: {
              oldSpot: roundStatus[3],
              newSpot: roundStatus[1],
              numberOldSpot: spielfeld[roundStatus[3][0]][roundStatus[3][1]].player.number,
              numberNewSpot: spielfeld[roundStatus[1][0]][roundStatus[1][1]].player.number
            }
          }
          });
        }, 1111);
      }
      else {
        showPlayerMovement();
        spielfeld[roundStatus[1][0] - 1][roundStatus[1][1]] = JSON.parse(JSON.stringify(spielfeld[roundStatus[1][0]][roundStatus[1][1]]));
        roundStatus[0] = "finished";
        roundStatus[3] = JSON.parse(JSON.stringify(roundStatus[1]));
        roundStatus[3][0]--;
      }
    }
    if ((direction == "finished" || spielfeld[roundStatus[3][0]][roundStatus[3][1]].player.number != 2 || direction == "up") && roundStatus[0] == "movePlayer" && AblageListe[3][0] == 38 && roundStatus[1][1] - 1 > -1 && spielfeld[roundStatus[1][0]][roundStatus[1][1] - 1].type == "land" && (spielfeld[roundStatus[1][0]][roundStatus[1][1] - 1].player == false || !(spielfeld[roundStatus[1][0]][roundStatus[1][1] - 1].player.id == myId))) {  // up
      direction = "up";
      // attack
      if (!(spielfeld[roundStatus[1][0]][roundStatus[1][1] - 1].player.id == myId) && !(spielfeld[roundStatus[1][0]][roundStatus[1][1] - 1].player == false)) {
        roundStatus[2] = [spielfeld[roundStatus[1][0]][roundStatus[1][1] - 1].player.number, spielfeld[roundStatus[1][0]][roundStatus[1][1]].player.number];
        roundStatus[4] = JSON.parse(JSON.stringify(spielfeld[roundStatus[1][0]][roundStatus[1][1] - 1].player.id));
      //  spielfeld[roundStatus[1][0]][roundStatus[1][1] - 1] = JSON.parse(JSON.stringify(spielfeld[roundStatus[1][0]][roundStatus[1][1]]));
        spielfeld[roundStatus[1][0]][roundStatus[1][1] - 1].player.number = JSON.parse(JSON.stringify(roundStatus[2][0]));
        roundStatus[0] = "showRewardsAttack";
        roundStatus[3] = JSON.parse(JSON.stringify(roundStatus[1]));
        roundStatus[1][1]--;
        Layout(true, 0);
        room.send({
          message: {
            "type": "roundStatus",
            "data": [roundStatus[0], roundStatus[1], roundStatus[2], roundStatus[3], [myId, opponentId]]
          }
        });
        setTimeout(function () {
          room.send({
            message: {
              type: "showNumber",
            data: {
              oldSpot: roundStatus[3],
              newSpot: roundStatus[1],
              numberOldSpot: spielfeld[roundStatus[3][0]][roundStatus[3][1]].player.number,
              numberNewSpot: spielfeld[roundStatus[1][0]][roundStatus[1][1]].player.number
            }
          }
          });
        }, 1111);
      }
      else {
        showPlayerMovement();
        console.log(spielfeld[roundStatus[1][0]][roundStatus[1][1] - 1]);
        spielfeld[roundStatus[1][0]][roundStatus[1][1] - 1] = JSON.parse(JSON.stringify(spielfeld[roundStatus[1][0]][roundStatus[1][1]]));
        console.log(spielfeld[roundStatus[1][0]][roundStatus[1][1] - 1]);
        roundStatus[0] = "finished";
        roundStatus[3] = JSON.parse(JSON.stringify(roundStatus[1]));
        roundStatus[3][1]--;
      }
    }
    if ((direction == "finished" || spielfeld[roundStatus[3][0]][roundStatus[3][1]].player.number != 2 || direction == "right") && roundStatus[0] == "movePlayer" && AblageListe[3][0] == 39 && roundStatus[1][0] - 1 < spielfeld.length && spielfeld[roundStatus[1][0] + 1][roundStatus[1][1]].type == "land" && (spielfeld[roundStatus[1][0] + 1][roundStatus[1][1]].player == false || !(spielfeld[roundStatus[1][0] + 1][roundStatus[1][1]].player.id == myId))) {  // right
      direction = "right";
      // attack
      if ( !(spielfeld[roundStatus[1][0] + 1][roundStatus[1][1]].player.id == myId) && !(spielfeld[roundStatus[1][0] + 1][roundStatus[1][1]].player == false)) {
        console.log(spielfeld[roundStatus[1][0] + 1][roundStatus[1][1]]);
        roundStatus[2] = [spielfeld[roundStatus[1][0] + 1][roundStatus[1][1]].player.number, spielfeld[roundStatus[1][0]][roundStatus[1][1]].player.number];
        console.log(spielfeld[roundStatus[1][0] + 1][roundStatus[1][1]]);
        roundStatus[4] = JSON.parse(JSON.stringify(spielfeld[roundStatus[1][0] + 1][roundStatus[1][1]].player.id));
        console.log(spielfeld[roundStatus[1][0] + 1][roundStatus[1][1]]);
      //  spielfeld[roundStatus[1][0] + 1][roundStatus[1][1]] = JSON.parse(JSON.stringify(spielfeld[roundStatus[1][0]][roundStatus[1][1]]));
        console.log(spielfeld[roundStatus[1][0] + 1][roundStatus[1][1]]);
        console.log(spielfeld[roundStatus[1][0] + 1][roundStatus[1][1]].player.number);
        spielfeld[roundStatus[1][0] + 1][roundStatus[1][1]].player.number = JSON.parse(JSON.stringify(roundStatus[2][0]));
        console.log(spielfeld[roundStatus[1][0] + 1][roundStatus[1][1]].player.number);
        roundStatus[0] = "showRewardsAttack";
        roundStatus[3] = JSON.parse(JSON.stringify(roundStatus[1]));
        roundStatus[1][0]++;
        Layout(true, 0);
        room.send({
          message: {
            "type": "roundStatus",
            "data": [roundStatus[0], roundStatus[1], roundStatus[2], roundStatus[3], [myId, opponentId]]
          }
        });
        setTimeout(function () {
          room.send({
            message: {
              type: "showNumber",
            data: {
              oldSpot: roundStatus[3],
              newSpot: roundStatus[1],
              numberOldSpot: spielfeld[roundStatus[3][0]][roundStatus[3][1]].player.number,
              numberNewSpot: spielfeld[roundStatus[1][0]][roundStatus[1][1]].player.number
            }
          }
          });
        }, 1111);
        Layout(true, 0);
      }
      else {
        showPlayerMovement();
        console.log(spielfeld[roundStatus[1][0] + 1][roundStatus[1][1]]);
        spielfeld[roundStatus[1][0] + 1][roundStatus[1][1]] = JSON.parse(JSON.stringify(spielfeld[roundStatus[1][0]][roundStatus[1][1]]));
        console.log(spielfeld[roundStatus[1][0] + 1][roundStatus[1][1]]);
        roundStatus[0] = "finished";
        roundStatus[3] = JSON.parse(JSON.stringify(roundStatus[1]));
        roundStatus[3][0]++;
      }
    }
    if ((direction == "finished" ||spielfeld[roundStatus[3][0]][roundStatus[3][1]].player.number != 2 || direction == "down") && roundStatus[0] == "movePlayer" && AblageListe[3][0] == 40 && roundStatus[1][1] + 1 < spielfeld.length && spielfeld[roundStatus[1][0]][roundStatus[1][1] + 1].type == "land" && (spielfeld[roundStatus[1][0]][roundStatus[1][1] + 1].player == false || !(spielfeld[roundStatus[1][0]][roundStatus[1][1] + 1].player.id == myId))) {  // down
      direction = "down";
      // attack
      if (!(spielfeld[roundStatus[1][0]][roundStatus[1][1] + 1].player.id == myId) && !(spielfeld[roundStatus[1][0]][roundStatus[1][1] + 1].player == false)) {
        roundStatus[2] = [spielfeld[roundStatus[1][0]][roundStatus[1][1] + 1].player.number, spielfeld[roundStatus[1][0]][roundStatus[1][1]].player.number];
        roundStatus[4] = JSON.parse(JSON.stringify(spielfeld[roundStatus[1][0]][roundStatus[1][1] + 1].player.id));
        console.log(spielfeld[roundStatus[1][0]][roundStatus[1][1] + 1]);
      //  spielfeld[roundStatus[1][0]][roundStatus[1][1] + 1] = JSON.parse(JSON.stringify(spielfeld[roundStatus[1][0]][roundStatus[1][1]]));
        console.log(spielfeld[roundStatus[1][0]][roundStatus[1][1] + 1]);
        console.log(spielfeld[roundStatus[1][0]][roundStatus[1][1] + 1].player.number);
        spielfeld[roundStatus[1][0]][roundStatus[1][1] + 1].player.number = JSON.parse(JSON.stringify(roundStatus[2][0]));
        console.log(spielfeld[roundStatus[1][0]][roundStatus[1][1] + 1].player.number);
        roundStatus[0] = "showRewardsAttack";
        roundStatus[3] = JSON.parse(JSON.stringify(roundStatus[1]));
        roundStatus[1][1]++;
        Layout(true, 0);
        room.send({
          message: {
            "type": "roundStatus",
            "data": [roundStatus[0], roundStatus[1], roundStatus[2], roundStatus[3], [myId, opponentId]]
          }
        });
        setTimeout(function () {
          room.send({
            message: {
              type: "showNumber",
            data: {
              oldSpot: roundStatus[3],
              newSpot: roundStatus[1],
              numberOldSpot: spielfeld[roundStatus[3][0]][roundStatus[3][1]].player.number,
              numberNewSpot: spielfeld[roundStatus[1][0]][roundStatus[1][1]].player.number
            }
          }
          });
        }, 1111);
        Layout(true, 0);
      }
      else {
        showPlayerMovement();
        console.log(spielfeld[roundStatus[1][0]][roundStatus[1][1] + 1]);
        spielfeld[roundStatus[1][0]][roundStatus[1][1] + 1] = JSON.parse(JSON.stringify(spielfeld[roundStatus[1][0]][roundStatus[1][1]]));
        console.log(spielfeld[roundStatus[1][0]][roundStatus[1][1] + 1]);
        roundStatus[0] = "finished";
        roundStatus[3] = JSON.parse(JSON.stringify(roundStatus[1]));
        roundStatus[3][1]++;
      }
    }
    if (roundStatus[0] == "finished" && spielfeld[roundStatus[1][0]][roundStatus[1][1]].player.number == 2) {
      if ((isNaN(roundStatus[2][0])))  roundStatus[2] = [AblageListe[3][0]];
      if (!(isNaN(roundStatus[2][0]))) roundStatus[2][1] = JSON.parse(JSON.stringify(roundStatus[2][0]));
      roundStatus[2][0] = AblageListe[3][0];
    }
    AblageListe[3] = {37: 39, 38: 40, 39: 37, 40: 38}
    if (roundStatus[0] == "finished" && spielfeld[roundStatus[1][0]][roundStatus[1][1]].player.number == 2 && !(roundStatus[2][0] == roundStatus[2][1] || roundStatus[2][0] == AblageListe[3][roundStatus[2][1]])) {
      console.log(spielfeld[roundStatus[1][0]][roundStatus[1][1]].player);
      spielfeld[roundStatus[1][0]][roundStatus[1][1]].player = JSON.parse(JSON.stringify(spielfeld[roundStatus[3][0]][roundStatus[3][1]].player));
      console.log(spielfeld[roundStatus[1][0]][roundStatus[1][1]].player);
      console.log(spielfeld[roundStatus[3][0]][roundStatus[3][1]].player);
      spielfeld[roundStatus[3][0]][roundStatus[3][1]].player = false; playerMoved[0] = false;
      canvas.fillStyle = colors[0];
      canvas.fillRect(477 + 70*roundStatus[3][0], 17 + 70*roundStatus[3][1], 60, 60);
      console.log(spielfeld[roundStatus[3][0]][roundStatus[3][1]].player);
      roundStatus[0] = "finishedPlayer2";
      roundStatus[2] = JSON.parse(JSON.stringify(roundStatus[1]));
      roundStatus[1] = JSON.parse(JSON.stringify(roundStatus[3]));
      roundStatus[3] = JSON.parse(JSON.stringify(roundStatus[2]));
      setTimeout(function () {
        roundStatus[2] = JSON.parse(JSON.stringify(roundStatus[1]));
        roundStatus[1] = JSON.parse(JSON.stringify(roundStatus[3]));
        roundStatus[3] = JSON.parse(JSON.stringify(roundStatus[2]));
      }, 100);
    }
    else if (roundStatus[0] == "finished" && spielfeld[roundStatus[1][0]][roundStatus[1][1]].player.number == 2) {
      roundStatus[0] = "movePlayer";
      console.log(spielfeld[roundStatus[1][0]][roundStatus[1][1]].player);
      spielfeld[roundStatus[1][0]][roundStatus[1][1]].player = false; playerMoved[0] = false;
      canvas.fillStyle = colors[0];
      canvas.fillRect(477 + 70*roundStatus[1][0], 17 + 70*roundStatus[1][1], 60, 60);
      console.log(spielfeld[roundStatus[1][0]][roundStatus[1][1]].player);
      roundStatus[1] = JSON.parse(JSON.stringify(roundStatus[3]));
      Layout(true, 0);
    }
    if ((roundStatus[0] == "finishedPlayer2" && spielfeld[roundStatus[3][0]][roundStatus[3][1]].player.number == 2) || (roundStatus[0] == "finished" && !(spielfeld[roundStatus[1][0]][roundStatus[1][1]].player.number == 2)))  FinishRound();
  if (roundStatus[0] == "placePlayer") {
  //  player = AblageListe[3][0];
    koordinaten[2] = 0;
    showStats();
  }
}
var direction = "finished";
  function FinishRound() {
    direction = "finished";
    if (roundStatus[0] == "finished") spielfeld[roundStatus[1][0]][roundStatus[1][1]].player = false;
    Layout(true, 0)/*;syncData()*/;roundStatus[0] = "ingame";
    setTimeout(function () {
      room.send({
        message: {
        type: "playerMoved",
        data: roundStatus[3]
      }
      });
    }, 777);
    localStorage.setItem('spielfeldStratego', JSON.stringify(spielfeld));
    localStorage.setItem('playerStratego', JSON.stringify(player));
  room.send({
    message: "Spielerwechsel"
  });
  ids = "inProgress";
}
  window.addEventListener('mousedown', function() {
    textBoxSelected = false;
    checkClickedField();
    // canvas.drawImage(Bild, 222, 300, 100, 100);
    if (roundStatus[0] == "placePlayer" && xMaus > 222 && xMaus < 322 && yMaus > 300 && yMaus < 400 && confirm("Wollen sie die Aufstellung wirklich speichern, obwohl sie noch nicht vollendet ist?")) aufstellungSpeichern();
    if (roundStatus[0] == "movePlayer" && spielfeld[AblageListe[0][0]][AblageListe[0][1]].player.number == 2 && roundStatus[1][0] == AblageListe[0][0] && roundStatus[1][1] == AblageListe[0][1]) FinishRound();
    if (!(roundStatus[1] == 12)) {
    if (roundStatus[0] == "placePlayer" && !(AblageListe[0] == "none") && !(roundStatus[1] == undefined) && player[roundStatus[1]].anzahl > 0 && ((myId == idsBleibt[0] && AblageListe[0][1] > 5) || (myId == idsBleibt[1] && AblageListe[0][1] < 4)) && spielfeld[AblageListe[0][0]][AblageListe[0][1]].player == false) {
      spielfeld[AblageListe[0][0]][AblageListe[0][1]].player = {id: myId, number: roundStatus[1]}
      player[roundStatus[1]].anzahl--;
      localStorage.setItem('spielfeldStratego', JSON.stringify(spielfeld));
      localStorage.setItem('playerStratego', JSON.stringify(player));
      Layout(false, 0);
    /*  syncData();*/
      AblageListe[3] = 0;
      for (var i = 0; i < player.length; i++) {
        if (player[i].anzahl < 1) AblageListe[3]++;
      }
      setTimeout(function () {
        if (AblageListe[3] == player.length) aufstellungInRunde();
      }, 500);
    }
  }
  else if (!(AblageListe[0] == "none") && !(spielfeld[AblageListe[0][0]][AblageListe[0][1]].player == false)) {

    player[spielfeld[AblageListe[0][0]][AblageListe[0][1]].player.number].anzahl++;


    spielfeld[AblageListe[0][0]][AblageListe[0][1]].player = false;
    Layout(false, 0);
  }
    if ((roundStatus[0] == "ingame" || (roundStatus[0] == "movePlayer" && !(spielfeld[AblageListe[0][0]][AblageListe[0][1]].player.number == 2))) && !(AblageListe[0] == "none") && spielfeld[AblageListe[0][0]][AblageListe[0][1]].player.id == myId && spielfeld[AblageListe[0][0]][AblageListe[0][1]].player.number > 0 && spielfeld[AblageListe[0][0]][AblageListe[0][1]].player.number < 11 && ids[0] == myId) {
      roundStatus[1] = AblageListe[0];
      roundStatus[2] = "NaN";
      roundStatus[0] = "movePlayer";
      Layout(true, 0);
    }
    if (roundStatus[0] == "showRewardsAttack") {
      attack();
    }

    // click player to place
    koordinaten[1] = 37;
    koordinaten[0] = 17;
  for (var i = 0; i < player.length + 1; i++) {
    if (xMaus > koordinaten[0] - 1 && xMaus < koordinaten[0] + 38 && yMaus > koordinaten[1] + 50 - 27 && yMaus < koordinaten[1] + 105 && roundStatus[0] == "placePlayer") {
      console.log(i);
      roundStatus[1] = i;
    }
    koordinaten[1] += 37;
  //  canvas.fillText(player[i].anzahl + "X", koordinaten[0], koordinaten[1] + 50)
  //  canvas.fillText("flag", koordinaten[0], koordinaten[1] + 50)
    koordinaten[1] += 57;
    if (i == 6) {
      koordinaten[0] += 77;
      koordinaten[1]= 37;
    }
    }
    if (roundStatus[0] == "placePlayer") {
    //  player = AblageListe[3][0];
      koordinaten[2] = 0;
      showStats();
    }
    if (xMaus > 178 && xMaus < 465 && yMaus > 154 && yMaus < 248) {
      if (colors[0] == "green") colors = colorsModes.normal
      else colors = colorsModes.special
      Layout(false, 0);
      localStorage.setItem("colors", JSON.stringify(colors));
    }
    // if (roundStatus[0] == "movePlayer" && spielfeld[roundStatus[3][0]][roundStatus[3][1]].player.number == 2) {
    //   FinishRound();
    // }
    // aufgeben
    //     canvas.drawImage(Bild, 222, 300, 100, 100);
    if (xMaus > 222 && xMaus < 322 && yMaus > 300 && yMaus < 400) {
      if (roundStatus[0] != "placePlayer" && confirm("Wollen sie wirklich aufgeben?")) {
        room.send({
          message: {
            type: "gewonnen",
            data: opponentId,
            siegDurch: "Aufgabe"
          }
        });
      }
    }
  });

  if (!(JSON.parse(localStorage.getItem("colors")) == null))  colors = JSON.parse(localStorage.getItem("colors"));
  function aufstellungInRunde() {
    if (AblageListe[3] == player.length && confirm("Sind sie mit ihrer Aufstellung zufrienden und wollen die Runde starten?")) {
      if (confirm("wollen sie diese Aufstellung auf ihrem Ger√§t speichern?")) aufstellungSpeichern();
      roundStatus[0] = "ingame";
      document.getElementById('textur').style = "touch-action: none";
      if (idsBleibt[0] == myId) {  // bottom
        room.send({
          message: {
            "type": "spielfeldBottom",
            "data": spielfeld
          }
        });
      }
      else {  // Top
        room.send({
          message: {
            "type": "spielfeldTop",
            "data": spielfeld
          }
        });
      }

    }
  }
function checkClickedField() {
  AblageListe[0] = "none";
  for (var i = 0; i < spielfeld.length; i++) {
    for (var i1 = 0; i1 < spielfeld.length; i1++) {
      if (xMaus > 476 + 70*i && xMaus < 476 + 70*i + 60 && yMaus > 17 + 70*i1 && yMaus < 17 + 70*i1 + 60) {
        console.log(1 + " - " + i1);
        AblageListe[0] = [i, i1];
      }
  }
  }
}


var f = function() {
  var eventHandler = function(event) {
    //    console.log(window.scrollX + " - " + window.scrollY);
    hinzuf√ºgenX = window.scrollX;
    hinzuf√ºgenY = window.scrollY;
//    Layout(true, 0);
  };
  window.addEventListener('scroll', eventHandler, false)
};
// canvas.fillRect(1330, 520, 200 + 18, 60);
window.addEventListener('DOMContentLoaded', f, false)
function readMouseMove(e) {
  xMaus = e.clientX + hinzuf√ºgenX;
  yMaus = e.clientY + hinzuf√ºgenY;
  //  console.log(xMaus + " - " + yMaus);
}
document.onmousemove = readMouseMove

// Tranzparentz: canvas.fillStyle = "rgba(0, 0, 210, 0.7)"; (blue)

// Handy swipe direction:

document.addEventListener('touchstart', handleTouchStart, false);
document.addEventListener('touchmove', handleTouchMove, false);
// var swipeCoordinatesX = [];
// var swipeCoordinatesY = [];
var xDown = null;
var yDown = null;

function getTouches(evt) {
return evt.touches ||             // browser API
       evt.originalEvent.touches; // jQuery
}

function handleTouchStart(evt) {
  swiped = false;
  const firstTouch = getTouches(evt)[0];
  xDown = firstTouch.clientX;
  yDown = firstTouch.clientY;
};
var swiped = false;
function handleTouchMove(evt) {
  var xUp = evt.touches[0].clientX;
  var yUp = evt.touches[0].clientY;
  var xDiff = xDown - xUp;
  var yDiff = yDown - yUp;
   swipeCoordinates = [evt.touches[0].clientX, evt.touches[0].clientY];
  if ( Math.abs( xDiff ) > Math.abs( yDiff ) && !swiped) {/*most significant*/
      if ( xDiff > 0 ) {
          /* left swipe */
          AblageListe[3] = [37, "Arrow"];
      } else {
          /* right swipe */
          AblageListe[3] = [39, "Arrow"];
      }
  } else if (!swiped) {
      if ( yDiff > 0 ) {
          /* up swipe */
          AblageListe[3] = [38, "Arrow"];
      } else {
          /* down swipe */
          AblageListe[3] = [40, "Arrow"];
      }
  }
  swiped = true;
  if (ger√§t == "Handy" && roundStatus[0] == "movePlayer" && spielfeld[roundStatus[1][0]][roundStatus[1][1]].player.number == 2 && (!((Math.round(swipeCoordinates[0])/10 + "").includes(".")) || !((Math.round(swipeCoordinates[1])/10 + "").includes(".")))) {
    folgenKeyDown();
  }
 if (ger√§t == "Handy" && !(roundStatus[0] == "movePlayer" && spielfeld[roundStatus[1][0]][roundStatus[1][1]].player.number == 2)) {
    folgenKeyDown();
  }
};

if (navigator.userAgent.match(/Android/i) ||
  navigator.userAgent.match(/webOS/i) ||
  navigator.userAgent.match(/iPhone/i) ||
  navigator.userAgent.match(/iPad/i) ||
  navigator.userAgent.match(/iPod/i) ||
  navigator.userAgent.match(/BlackBerry/i) ||
  navigator.userAgent.match(/Windows Phone/i)
) {
  ger√§t = "Handy"
  console.log("Handy");
} else {
  ger√§t = "PC"
  console.log("PC");
}

var items = document.querySelectorAll("#kathegorien"),
    tab = [], liIndex;


        for(i = 0; i < items.length; i++){
            tab.push(items[i].innerHTML);
        }


        for(var i = 0; i < items.length; i++){

            items[i].onclick = function(){

                liIndex = tab.indexOf(this.innerHTML);
                console.log(this.innerText + " INDEX = " + liIndex);
                if (roundStatus[0] == "placePlayer") aufstellungLaden(JSON.parse(localStorage.getItem("aufstellungenStratego"))[this.innerText]);
            };

        }
</script>
