<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
  <link rel="stylesheet" type="text/css" href="https://adi.nicolaiweitkemper.de/Tests/ThreeJS_Tutorial_BasicWorld-main/base.css">
</head>
<body>
</body>
</html>
<meta charset="utf-8">
<h2 id="info">klick to choose a field</h2>

<h2 id="Name"></h2>
<!-- <button id="B1" onclick='B("0-0")'>reinschmeißen</button>
<button id="B2" onclick='B("1-0")'>reinschmeißen</button>
<button id="B3" onclick='B("2-0")'>reinschmeißen</button>
<button id="B4" onclick='B("3-0")'>reinschmeißen</button>
<button id="B5" onclick='B("4-0")'>reinschmeißen</button>
<button id="B6" onclick='B("5-0")'>reinschmeißen</button>
<button id="B7" onclick='B("6-0")'>reinschmeißen</button>

<link href="https://adi.nicolaiweitkemper.de/JS_Grafik/TEST.css" rel="stylesheet" type="text/css"> -->

<canvas id="textur" width="1582" style="display:none" height="750"></canvas>
<select name="course" id="modi">
  <option value="Plätchen">Plätchen</option>
  <option value="runterrutschen" selected="">runterrutschen</option>
  <option value="3D" selected="">3D</option>
</select>


<script type = "module">
// 3D part
import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.118/build/three.module.js';

import {OrbitControls} from 'https://cdn.jsdelivr.net/npm/three@0.118/examples/jsm/controls/OrbitControls.js';


class BasicWorldDemo {
  constructor() {
    this._Initialize();
  }

  _Initialize() {
    this._threejs = new THREE.WebGLRenderer({
      antialias: true,
    });
    this._threejs.shadowMap.enabled = true;
    this._threejs.shadowMap.type = THREE.PCFSoftShadowMap;
    this._threejs.setPixelRatio(window.devicePixelRatio);
    this._threejs.setSize(window.innerWidth, window.innerHeight);

    document.body.appendChild(this._threejs.domElement);

    window.addEventListener('resize', () => {
      this._OnWindowResize();
    }, false);

    const fov = 60;
    const aspect = 1920 / 1080;
    const near = 1.0;
    const far = 1000.0;
    this._camera = new THREE.PerspectiveCamera(fov, aspect, near, far);
    this._camera.position.set(75, 20, 0);

    this._scene = new THREE.Scene();

    let light = new THREE.DirectionalLight(0xFFFFFF, 1.0);
    light.position.set(20, 100, 10);
    light.target.position.set(0, 0, 0);
    light.castShadow = true;
    light.shadow.bias = -0.001;
    light.shadow.mapSize.width = 2048;
    light.shadow.mapSize.height = 2048;
    light.shadow.camera.near = 0.1;
    light.shadow.camera.far = 500.0;
    light.shadow.camera.near = 0.5;
    light.shadow.camera.far = 500.0;
    light.shadow.camera.left = 100;
    light.shadow.camera.right = -100;
    light.shadow.camera.top = 100;
    light.shadow.camera.bottom = -100;
    this._scene.add(light);

    light = new THREE.AmbientLight(0x101010);
    this._scene.add(light);

    const controls = new OrbitControls(
      this._camera, this._threejs.domElement);
    controls.target.set(0, 20, 0);
    controls.update();

    const loader = new THREE.CubeTextureLoader();
    const texture = loader.load([
        'https://adi.nicolaiweitkemper.de/Tests/ThreeJS_Tutorial_BasicWorld-main/resources/posx.jpg',
        'https://adi.nicolaiweitkemper.de/Tests/ThreeJS_Tutorial_BasicWorld-main/resources/resources/negx.jpg',
        'https://adi.nicolaiweitkemper.de/Tests/ThreeJS_Tutorial_BasicWorld-main/resources/resources/posy.jpg',
        'https://adi.nicolaiweitkemper.de/Tests/ThreeJS_Tutorial_BasicWorld-main/resources/resources/negy.jpg',
        'https://adi.nicolaiweitkemper.de/Tests/ThreeJS_Tutorial_BasicWorld-main/resources/resources/posz.jpg',
        'https://adi.nicolaiweitkemper.de/Tests/ThreeJS_Tutorial_BasicWorld-main/resources/resources/negz.jpg',
    ]);
    this._scene.background = texture;

    // const plane = new THREE.Mesh(
    //     new THREE.PlaneGeometry(100, 100, 10, 10),
    //     new THREE.MeshStandardMaterial({
    //         color: 'rgb(201, 115, 60)',
    //       }));
    // plane.castShadow = false;
    // plane.receiveShadow = true;
    // plane.rotation.x = -Math.PI / 2;
    // this._scene.add(plane);

    const box = new THREE.Mesh(
      new THREE.BoxGeometry(4*13, 1.75, 4*13),
      new THREE.MeshStandardMaterial({
          color: 'rgb(201, 115, 60)',
      }));
    box.position.set(0, 0, 0);
    this._scene.add(box);

    // for (let x = -8; x < 8; x++) {
    //   for (let y = -8; y < 8; y++) {
    //     const box = new THREE.Mesh(
    //       new THREE.BoxGeometry(2, 2, 2),
    //       new THREE.MeshStandardMaterial({
    //           color: 0x808080,
    //       }));
    //     box.position.set(Math.random() + x * 5, Math.random() * 4.0 + 2.0, Math.random() + y * 5);
    //     box.castShadow = true;
    //     box.receiveShadow = true;
    //     this._scene.add(box);
    //   }
    // }

    // const box = new THREE.Mesh(
    //   new THREE.SphereGeometry(2, 32, 32),
    //   new THREE.MeshStandardMaterial({
    //       color: 0xFFFFFF,
    //       wireframe: true,
    //       wireframeLinewidth: 4,
    //   }));
    // box.position.set(0, 0, 0);
    // box.castShadow = true;
    // box.receiveShadow = true;
    // this._scene.add(box);

    this._RAF();
    // my code
    const sphereGeometry = new THREE.SphereGeometry( 5/*radius*/, 32, 16 );
    const cylinderGeometry = {PC: new THREE.CylinderGeometry( 0.6/*radius top*/, 0.6/*radius bottom*/, 40/*height*/, 32/*radialSegments*/ ), Handy: new THREE.CylinderGeometry( 2/*radius top*/, 2/*radius bottom*/, 40/*height*/, 32/*radialSegments*/ )};
    var materials = {blue: new THREE.MeshBasicMaterial( { color: 'hsl(205, 63%, 46%)' } ), red: new THREE.MeshBasicMaterial( { color: 'hsl(0, 80%, 55%)' } ), green: new THREE.MeshBasicMaterial( { color: 'hsl(113, 79%, 54%)' } ), brownIsh: new THREE.MeshBasicMaterial( {color: 'hsl(43, 62%, 46%)'} )};
    this.getMaterials = () => materials;
    var sphere;
    var direction = 1;
    setTimeout(function () {
      scrollY = 124.5
    }, 3000);
    this.load3dLayout = (Felder) => {
      for (var i = 0; i < Felder.length; i++) {
        // for (var i1 = 0; i1 < Felder[0].length; i1++) {
          for (var i2 = 0; i2 < Felder[0].length; i2++) {
            // if (!i1) {
            const cylinder = new THREE.Mesh( cylinderGeometry[gerät], materials.brownIsh);
            console.log(i + " - " + i2);
            cylinder.position.set(13*i - 13*1.5/*x*/, 20/*y*/, 13*i2 - 13*1.5/*z*/) /*position of middle*/;
            cylinder.selectable = true;
            this._scene.add( cylinder );
          // }
          }
        // }
      }
      // sphere = new THREE.Mesh( sphereGeometry, materials.blue );
      // sphere.position.set(0/*x*/, 5/*y*/, 0/*z*/);
      // // // sphere.castShadow = true;
      // // sphere.receiveShadow = true;
      // this._scene.add( sphere );
      // sphere = new THREE.Mesh( sphereGeometry, materials.blue );
      // sphere.position.set(0/*x*/, 25/*y*/, 0/*z*/);
      // this._scene.add( sphere );
      // sphere = new THREE.Mesh( sphereGeometry, materials.red );
      // sphere.position.set(0/*x*/, 15/*y*/, 0/*z*/);
      // this._scene.add( sphere );
      // sphere = new THREE.Mesh( sphereGeometry, materials.red );
      // sphere.position.set(0/*x*/, 35/*y*/, 0/*z*/);
      // this._scene.add( sphere );
      // const cylinder = new THREE.Mesh( cylinderGeometry, materials.brownIsh);
      // cylinder.position.set(0/*x*/, 20/*y*/, 0/*z*/) /*position of middle*/;
      // this._scene.add( cylinder );
    }
    this.objClicked = () => {
      if (Start && SpielerId == SpielerIds[0] && document.getElementById('modi').value == "3D") {
      clickMouse.x = (/*event.clientX*/(xMaus) / window.innerWidth) * 2 - 1;
      clickMouse.y = -(/*event.clientY*/(yMaus - scrollY) / window.innerHeight) * 2 + 1;

      raycaster.setFromCamera(clickMouse, _APP._camera);
      const found = raycaster.intersectObjects(_APP._scene.children);
      var stabPos = found[0]?.object.position;
      if (click.mouseMove < 5 && found[0]?.object.selectable && Felder[Math.abs(((stabPos.x - 13*1.5)/13))][Math.abs(((stabPos.z - 13*1.5)/13))]?.length < 4) {
      click = {state: "up", mouseMove: 0};
      if (selected.ball) {
        if (JSON.stringify(found[0]?.object.position) == JSON.stringify(selected.stab.position)) {
          room.send({
            type: '3DsetStone',
            stabPos: found[0]?.object.position,
            player: SpielerId
          });
        }
        else {
          _APP.destroySelected();
        }
      }
      if (!selected.stab || JSON.stringify(found[0]?.object.position) != JSON.stringify(selected.stab.position)) {
      selected.stab = found[0]?.object;
        selected.stab.material = materials.blue;
      selected.ball = new THREE.Mesh( sphereGeometry, materials.blue );
      selected.ball.position.set(stabPos.x/*x*/, 50/*y*/, stabPos.z/*z*/);
      this._scene.add( selected.ball );
    }
    }
    else click = {state: "up", mouseMove: 0};
    }
    }
    this.destroySelected = () => {
      selected.ball.geometry.dispose();
      selected.ball.material.dispose();
      this._scene.remove(selected.ball);
      selected.stab.material = materials.brownIsh;
    }
    this.stoneSelected = (stabPos, player) => {
      var field = Felder[Math.abs(((stabPos.x - 13*1.5)/13))][Math.abs(((stabPos.z - 13*1.5)/13))]
    if (SpielerId == SpielerIds[0]) {
      _APP.destroySelected();
      selected = {ball: null, stab: null};
      room.send({
        message: "Spielerwechsel"
      });
      sphere = new THREE.Mesh( sphereGeometry, materials.blue);
      field.push("blue");
    }
    else {
      sphere = new THREE.Mesh( sphereGeometry, materials.red);
      field.push("red");
    }
    objFelder[Math.abs(((stabPos.x - 13*1.5)/13))][Math.abs(((stabPos.z - 13*1.5)/13))].push(sphere);
    objFelder.forEach((objFeldX, i) => {
      objFeldX.forEach((objFeldZ, i1) => {
        objFeldZ.forEach((objFeld, i2) => {
          objFeld.winChecked = [];
        });
      });
    });
    checkWinning();
      sphere.position.set(stabPos.x/*x*/, 50/*y*/, stabPos.z/*z*/);
      this._scene.add( sphere );
      this.fallingStone(sphere, field);
    }
    this.fallingStone = (sphere, field) => {
      sphere.position.set(sphere.position.x/*x*/, sphere.position.y - 1/*y*/, sphere.position.z/*z*/);
      setTimeout(function () {
        if (sphere.position.y > -5 + 10*field.length) _APP.fallingStone(sphere, field);
      }, 10);
    }
  }

  _OnWindowResize() {
    this._camera.aspect = window.innerWidth / window.innerHeight;
    this._camera.updateProjectionMatrix();
    this._threejs.setSize(window.innerWidth, window.innerHeight);
  }

  _RAF() {
    requestAnimationFrame(() => {
      this._threejs.render(this._scene, this._camera);
      this._RAF();
    });
  }
}
// detect obj at mouse position
const raycaster = new THREE.Raycaster();
var clickMouse = new THREE.Vector2();
const moveMouse = new THREE.Vector2();
var click = {state: "up", mouseMove: 0};
window.addEventListener('mousedown', event => {
  click.state = "down";
});
// document.addEventListener('touchmove', touch);
// document.addEventListener('touchstart', touch);
document.addEventListener('touchstart', touch);
function touch(ev) {
  if (ev.type == "touchstart") {
    xMaus = ev.touches[0]["pageX"];
    yMaus = ev.touches[0]["pageY"];
    _APP.objClicked();
  }
}
window.addEventListener('click', event => {
  _APP.objClicked();
})
var selected = {stab: null, ball: null};
let _APP = null;

window.addEventListener('DOMContentLoaded', () => {
  _APP = new BasicWorldDemo();
  console.log(_APP);
});
setTimeout(function () {
Felder = [];
for (var i = 0; i < 4; i++) {
  Felder[i] = [];
  objFelder[i] = [];
  for (var i1 = 0; i1 < 4; i1++) {
    Felder[i][i1] = [];
    objFelder[i][i1] = [];
  }
}
_APP.load3dLayout(Felder);
}, 1000);
  var gerät = "";
  if (navigator.userAgent.match(/Android/i) ||
    navigator.userAgent.match(/webOS/i) ||
    navigator.userAgent.match(/iPhone/i) ||
    navigator.userAgent.match(/iPad/i) ||
    navigator.userAgent.match(/iPod/i) ||
    navigator.userAgent.match(/BlackBerry/i) ||
    navigator.userAgent.match(/Windows Phone/i)
  ) {
    gerät = "Handy"
    console.log("Handy");
  } else {
    gerät = "PC"
    console.log("PC");
  }
  document.getElementById('modi').style.display = "none";
  var textur = document.getElementById('textur');
  var canvas = textur.getContext('2d'); //Dimension
  var KoordinatenY = 65;
  var KoordinatenX = 300;
  var diff
  var zähler = 0;
  var zähler1 = 0;
  var zählerNummerierung = 0;
  var antwort;
  var SpielerIds = [];
  var Farben = ["red", "blue"]
  var Start = false;
  var eins;
  var Ablage;
  var TeileMarkierung = [];
  var Felder = ["-", "-", "-", "-", "-", "-", "-", "-", "-", "-", "-", "-", "-", "-", "-", "-", "-", "-", "-", "-", "-", "-", "-", "-", "-", "-", "-", "-", "-", "-", "-", "-", "-", "-", "-", "-", "-", "-", "-", "-", "-", "-"]
  var objFelder = [];
  var Koordinaten = ["00", 10, 20, 30, 40, 50, 60, "01", 11, 21, 31, 41, 51, 61, "02", 12, 22, 32, 42, 52, 62, "03", 13, 23, 33, 43, 53, 63, "04", 14, 24, 34, 44, 54, 64, "05", 15, 25, 35, 45, 55, 65]
  var Zustand = "none"
  var zählerM2 = ""
  var SpielerId;
  3
  async function sendJson(url = "/", body = {}) {
    const rawResponse = await fetch(url, {
      method: 'POST',
      headers: {
        'Accept': 'application/json',
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(body)
    });
    const content = await rawResponse.json();
    return content;
  }
  // sendJson('/logout', {
  //   clientId
  // });

  const clientId = makeid(10);
  var messageListener = null;

  async function register() {
    let response = sendJson('/vierGewinnt/login', {
      clientId
    });
  }

  register();
  setInterval(getMessages, 1000);

  function getMessages() {
    sendJson('/vierGewinnt/message-queue', {
      clientId
    }).then(messages => {
      if (messages.length > 0) console.log("MESSAGES", messages);
      messages.forEach(msg => messageListener(msg));
    });
  }

  function sendMessage(obj) {
    sendJson('/vierGewinnt/message', {
      clientId,
      content: obj
    });
  }

  function makeid(length) {
    var result = '';
    var characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
    var charactersLength = characters.length;
    for (var i = 0; i < length; i++) {
      result += characters.charAt(Math.floor(Math.random() * charactersLength));
    }
    return result;
  }


  var room = {
    setOnMessageListener(listener) {
      messageListener = listener;
    },
    send(msg) {
      sendMessage(msg);
    }
  };
  window.onbeforeunload = function() {
    console.log("Leave Website");
    sendJson('/vierGewinnt/logout', {
      clientId
    });
    return 'Are you sure you want to leave?';
  };
  room.setOnMessageListener(function(message) {
    if (message.type == "3DsetStone") _APP.stoneSelected(message.stabPos, message.player);
    else if (message.includes("player1")) {
      SpielerId = message.replace("player1", "");
      console.log(SpielerId);
    } else if (message.includes("player2")) {
      SpielerId = message.replace("player2", "");
      console.log(SpielerId);
    } else if (message.includes("player")) {
      if (SpielerIds.length == 0) {
        Ablage = message.toString().split('player');
        Ablage.shift();
        if (Ablage[0] == SpielerId) {
          Farben = ["red", "blue"];
        } else {
          Farben = ["blue", "red"];
        }
        KoordinatenY = 65;
        KoordinatenX = 300;
        canvas.fillStyle = 'white'; //Farbe
        canvas.fillRect(0, 0, 1800, 750);
        zähler = 0;
        zählerNummerierung = 0;
        Layout();
      }
      SpielerIds = message.toString().split('player');
      SpielerIds.shift();
      console.log(SpielerIds);
      KoordinatenY = 65;
      KoordinatenX = 300;
      if (SpielerIds[0] == SpielerId) {
        document.getElementById("Name").innerHTML = "Du bist dran" + " (" + Farben[0] + ")"
      } else {
        document.getElementById("Name").innerHTML = "Der Gegner ist dran" + " (" + Farben[1] + ")"
      }
    } else if (message.includes("Spielmodus:")) {
      document.getElementById('modi').value = message.replace("Spielmodus:", "");
      if (message == undefined) {
        document.getElementById('modi').value = "runterrutschen";
      }
      modi.value = "3D";
      selectedMode = [];
      room.send({
        message: "voteModeRutschen: " + confirm('Do you want to play "runterrutschen"?')
      });
      KoordinatenY = 65;
      KoordinatenX = 300;
      canvas.fillStyle = 'white'; //Farbe
      canvas.fillRect(0, 0, 1800, 750);
      zähler = 0;
      zählerNummerierung = 0;
      Layout();
    }
    else if (message.includes("voteModeRutschen")) {
      selectedMode.push(JSON.parse(message.replace("voteModeRutschen: ", "")));
      if (selectedMode.length > 1) {
        if (SpielerIds[0] == SpielerId) yourColour = "red";
        else yourColour = "blue";
        var i1 = 0;
        for (var i = 0; i < selectedMode.length; i++) {
          if (selectedMode[i]) i1++;
        }
        modeSelected = "";
        if (i1 - (selectedMode.length - i1) > 0) modeSelected = "runterrutschen";
        else if (i1 - (selectedMode.length - i1) < 0) modeSelected = "Plätchen";
        if (!modeSelected) alert("random gamemode selected (" + document.getElementById('modi').value + "), because the players wanted to play different modes!");
        else {
          alert("Voting results gamemode " + modeSelected);
          document.getElementById('modi').value = modeSelected;
          modi.value = '3D';
          if (modi.value != "3D") Felder = ["-", "-", "-", "-", "-", "-", "-", "-", "-", "-", "-", "-", "-", "-", "-", "-", "-", "-", "-", "-", "-", "-", "-", "-", "-", "-", "-", "-", "-", "-", "-", "-", "-", "-", "-", "-", "-", "-", "-", "-", "-", "-"]
          else {
            // objFelder = [];
            // Felder = [];
            // for (var i = 0; i < 4; i++) {
            //   Felder[i] = [];
            //   for (var i1 = 0; i1 < 4; i1++) {
            //     Felder[i][i1] = [];
            //   }
            // }
            // _APP.load3dLayout(Felder);
          }
          KoordinatenY = 65;
          KoordinatenX = 300;
          canvas.fillStyle = 'white'; //Farbe
          canvas.fillRect(0, 0, 1800, 750);
          zähler = 0;
          zählerNummerierung = 0;
          Layout();
          // room.send({
          //   message: "Spielmodus:" + modeSelected
          // });
        }
      }
    }
     else if (message.includes("koord:")) {
       placedList.push(JSON.parse(JSON.stringify(message)));
      if (document.getElementById('modi').value == "runterrutschen") {
        Ablage = message.replace("koord: ", "");
        PlazierungM2(true);
      } else {
        //    Felder[message.replace("koord: ", "")[0]]
        Felder[0 + JSON.parse(message.replace("koord: ", "")[0]) + JSON.parse(message.replace("koord: ", "")[2]) * 7] = Farben[1];
        KoordinatenY = 65;
        KoordinatenX = 300;
        canvas.fillStyle = 'white'; //Farbe
        canvas.fillRect(0, 0, 1800, 750);
        zählerNummerierung = 0;
        zähler = 0;
        Layout();
        LayoutZurrück();
      }
    } else if (message.includes(" hat gewonnen!")) {
      Start = false;
      audio = new Audio("http://adi.nicolaiweitkemper.de/Sounds/FAIL%20SOUND%20EFFECT.mp3").play();
      /*    Ablage = zuletztGelegt.replace(" - ", "");
          eins = Ablage.toString().split('');
          diff = ((1) * Math.PI * 2 * 10).toFixed(2)
          canvas.lineWidth = 95;
          canvas.fillStyle = 'green'
          canvas.strokeStyle = '#40FF00'
          canvas.textAlign = 'center'
          canvas.beginPath();
          canvas.arc(150 + 150 * JSON.parse(eins[0]), 65 + 120 * JSON.parse(eins[1]), 5, 4.72, diff / 10 + 4.72, false)
          canvas.stroke(); */
      setTimeout(function() {
        zähler1 = 0;
        Markierungen();
      }, 400);
      setTimeout(function() {
        canvas.font = "135px Arial";
        canvas.fillStyle = "#cc0000";
        canvas.fillText("Du hast Verloren!", 750, 370);
        askReplay();
      }, 1535);
    } else if (message.includes("Markierungen: ")) {
      markierungMessage = message;
      TeileMarkierung = message.replace("Markierungen: ").toString().split(',');
      TeileMarkierung[0] = TeileMarkierung[0].replace("undefined", "");
    }  /* else if (message.includes("left")) {
         location.reload();
    } */ else {
          // var p = document.createElement("p");
          // p.innerHTML = message;
          // document.querySelector("#messages").appendChild(p);
    }
  });
  var placedList = [];
  var modeSelected;
  var selectedMode = [];
  var yourColour;
  var markierungMessage;
  // send message to room on submit
  /*  document.querySelector("#form").onsubmit = function(e) {
      e.preventDefault();

      var input = document.querySelector("#input");

      console.log("input:", input.value);

      // send data to room
      room.send({
        message: input.value
      });

      // clear input
      input.value = "";
    } */

  verstecktAnfang();

  function verstecktAnfang() {


  }
  var winningDirec;
  function checkWinning() {
    objFelder.forEach((objFeldX, i) => {
      objFeldX.forEach((objFeldZ, i1) => {
        objFeldZ.forEach((objFeld, i2) => {
          if (!objFeld.winChecked.length) checkWinningLoop(i, i1, i2, "start");
        });
      });
    });
  }
  var keyDirectionBefore;
  function checkWinningLoop(i, i1, i2, direction) {
    if (direction == "start") winningDirec = {x: [{x: i, y: i2, z: i1}], y: [{x: i, y: i2, z: i1}], z: [{x: i, y: i2, z: i1}], xyRight: [{x: i, y: i2, z: i1}], xyLeft: [{x: i, y: i2, z: i1}], zyRight: [{x: i, y: i2, z: i1}], zyLeft: [{x: i, y: i2, z: i1}], xzRight: [{x: i, y: i2, z: i1}], xzLeft: [{x: i, y: i2, z: i1}], xyzRightUp: [{x: i, y: i2, z: i1}], xyzRightDown: [{x: i, y: i2, z: i1}], xyzLeftUp: [{x: i, y: i2, z: i1}], xyzLeftDown: [{x: i, y: i2, z: i1}]};
    else {
      console.log(direction);
      winningDirec[direction].push({x: i, y: i2, z: i1});
    }
    objFelder[i][i1][i2].winChecked.push(direction);
    var directions = {x: [1, 0, 0], y: [0, 0, 1], z: [0, 0, 1], xyRight: [1, 0, 1], xyLeft: [-1, 0, 1], zyRight: [0, 1, 1], zyLeft: [0, 1, - 1], xzRight: [1, 1, 0], xzLeft: [-1, 1, 0], xyzRightUp: [1, 1, 1], xyzRightDown: [1, 1, -1], xyzLeftUp: [-1, 1, 1], xyzLeftDown: [1, -1, 1]};
    for (var i3 = 0; i3 < Object.keys(directions).length; i3++) {
      var keyDirection = Object.keys(directions)[i3];
      if (!i3 && direction != "start" && keyDirectionBefore != direction) keyDirection = direction;
      if (!(keyDirection == direction && i3) || direction == "start") {
      var plus = directions[keyDirection];
      if (objFelder[i + plus[0]] && objFelder[i + plus[0]][i1 + plus[1]] && (!objFelder[i + plus[0]][i1 + plus[1]][i2 + plus[2]]?.winChecked.includes(keyDirection) && objFelder[i + plus[0]][i1 + plus[1]] && !objFelder[i + plus[0]][i1 + plus[1]][i2 + [i2 + plus[2]]]?.winChecked.includes("start")) && objFelder[i + plus[0]][i1 + plus[1]][i2 + plus[2]]?.material.color == objFelder[i][i1][i2]?.material.color) {
        if (direction != "start" && winningDirec[direction].length < 4 && keyDirection != direction) winningDirec[direction].length = 1;
        if (direction != "start" && keyDirection != direction) break;
        objFelder[i][i1][i2].winChecked.push(keyDirection);
        checkWinningLoop(i + plus[0], i1 + plus[1], i2 + plus[2], keyDirection);
      }
      if (objFelder[i + plus[0]*-1] && objFelder[i + plus[0]*-1][i1 + plus[1]*-1] && (!objFelder[i + plus[0]*-1][i1 + plus[1]*-1][i2 + plus[2]*-1]?.winChecked.includes(keyDirection) && !objFelder[i + plus[0]*-1][i1 + plus[1]*-1][i2 + plus[2]*-1]?.winChecked.includes("start")) && objFelder[i + plus[0]*-1][i1 + plus[1]*-1][i2 + plus[2]*-1]?.material.color == objFelder[i][i1][i2]?.material.color) {
        if (direction != "start" && winningDirec[direction].length < 4 && keyDirection != direction) winningDirec[direction].length = 1;
        if (direction != "start" && keyDirection != direction) break;
        objFelder[i][i1][i2].winChecked.push(keyDirection);
        checkWinningLoop(i + plus[0]*-1, i1 + plus[1]*-1, i2 + plus[2]*-1, keyDirection);
      }
      if (!i3 && direction != "start" && keyDirectionBefore != direction) i3 = -1;
      keyDirectionBefore = keyDirection;
    }
    }
    if (direction == "start") {
      console.log(winningDirec);
      for (var keyWinningDirec of Object.keys(winningDirec)) {
        var pWinningDirec = winningDirec[keyWinningDirec];
        if (pWinningDirec.length >= 4) {
          console.log("more than 3!!!");
          for (var ball of pWinningDirec) {
            objFelder[ball.x][ball.z][ball.y].material = _APP.getMaterials().green;
          }
        }
      }
      winningDirec = {x: [{x: i, y: i2, z: i1}], y: [{x: i, y: i2, z: i1}], z: [{x: i, y: i2, z: i1}], xyRight: [{x: i, y: i2, z: i1}], xyLeft: [{x: i, y: i2, z: i1}], zyRight: [{x: i, y: i2, z: i1}], zyLeft: [{x: i, y: i2, z: i1}], xzRight: [{x: i, y: i2, z: i1}], xzLeft: [{x: i, y: i2, z: i1}], xyzRightUp: [{x: i, y: i2, z: i1}], xyzRightDown: [{x: i, y: i2, z: i1}], xyzLeftUp: [{x: i, y: i2, z: i1}], xyzLeftDown: [{x: i, y: i2, z: i1}]};
    }
  }


  zähler = 1;
  // Buttons();
  //
  // function Buttons() {
  //
  //   Ablage = document.getElementById("B" + zähler)
  //   Ablage.style.display = Zustand;
  //   zähler++;
  //   if (zähler == 8) {
  //     zähler = 0;
  //   } else {
  //     Buttons();
  //   }
  // }

  function varZurrücksetzen() {
    KoordinatenY = 65;
    KoordinatenX = 300;
    diff
    zähler = 0;
    zähler1 = 0;
    zählerNummerierung = 0;
    antwort;
    SpielerIds[0] = "1";
    SpielerIds[1] = "2";
    Farben[0] = "red"
    Farben[1] = "blue"
    Start = false;
    eins;
    Ablage;
    TeileMarkierung = []
    Felder = ["-", "-", "-", "-", "-", "-", "-", "-", "-", "-", "-", "-", "-", "-", "-", "-", "-", "-", "-", "-", "-", "-", "-", "-", "-", "-", "-", "-", "-", "-", "-", "-", "-", "-", "-", "-", "-", "-", "-", "-", "-", "-"]
    objFelder = [];
    Felder = [];
    for (var i = 0; i < 4; i++) {
      Felder[i] = [];
      objFelder[i] = [];
      for (var i1 = 0; i1 < 4; i1++) {
        Felder[i][i1] = [];
        objFelder[i][i1] = [];
      }
    }
    Koordinaten = ["00", 10, 20, 30, 40, 50, 60, "01", 11, 21, 31, 41, 51, 61, "02", 12, 22, 32, 42, 52, 62, "03", 13, 23, 33, 43, 53, 63, "04", 14, 24, 34, 44, 54, 64, "05", 15, 25, 35, 45, 55, 65]
    Zustand = "none"
    zählerM2 = ""
  }

  function Layout() {
    Start = true;
    canvas.font = "20px Georgia";
    canvas.fillStyle = "brown"
    canvas.fillText(zählerNummerierung + "-" + zähler, 150, KoordinatenY);
    zähler++;
    diff = ((1) * Math.PI * 2 * 10).toFixed(2)
    canvas.lineWidth = 95;
    canvas.fillStyle = '#09F'
    canvas.strokeStyle = '#09F'
    canvas.textAlign = 'center'
    canvas.beginPath();
    canvas.arc(150, KoordinatenY, 5, 4.72, diff / 10 + 4.72, false)
    canvas.stroke();
    KoordinatenY = KoordinatenY + 120

    if (KoordinatenY > 784) {
      KoordinatenY = 65
      zählerNummerierung++;
      zähler = 0;
      Layout1();
    } else {

      Layout();
    }
  }


  function Layout1() {

    canvas.font = "20px Georgia";
    canvas.fillStyle = "brown"
    canvas.fillText(zählerNummerierung + "-" + zähler, KoordinatenX, KoordinatenY);

    diff = ((1) * Math.PI * 2 * 10).toFixed(2)
    canvas.lineWidth = 95;
    canvas.fillStyle = '#09F'
    canvas.strokeStyle = '#09F'
    canvas.textAlign = 'center'
    canvas.beginPath();
    canvas.arc(KoordinatenX, KoordinatenY, 5, 4.72, diff / 10 + 4.72, false)
    canvas.stroke();
    zähler++;
    KoordinatenY = KoordinatenY + 120;
    if (zähler == 6) {
      zählerNummerierung++;
      KoordinatenY = 65;
      KoordinatenX = KoordinatenX + 150
      zähler = 0;
    }

    if (KoordinatenX == 1200) {


      console.log("L. fertig!")

      if (document.getElementById('modi').value == "runterrutschen") {
        setTimeout(function() {
          //        window.scrollTo(0, 47);
        }, 100);
        zähler = 1;
        Zustand = "inline"
        // Buttons();
        document.getElementById('info').innerHTML = "click on the field, you want your stone to be. it will fall down as far as possible.";
      //  document.getElementById('info').style.display = "none";
      }
      else {
        zähler = 1;
        Zustand = "none"
        //Buttons();
        document.getElementById('info').innerHTML = "klick to choose a field";
  //      document.getElementById('info').style.display = "inline";
      }
    }
    else {
      Layout1();
    }
  }

  function Gewinncheck() {

    Ablage = zähler + 3
    Ablage = Ablage / 7
    Ablage = "" + Ablage + "";
    if (Ablage.length == 1) {
      zähler = zähler + 3

    }

    if (Felder[zähler] == Farben[0] && Felder[zähler + 1] == Farben[0] && Felder[zähler + 2] == Farben[0] && Felder[zähler + 3] == Farben[0]) {

      TeileMarkierung[0] = Koordinaten[zähler + 1]
      TeileMarkierung[1] = Koordinaten[zähler + 2]
      TeileMarkierung[2] = Koordinaten[zähler + 3]
      Endbildschirm();
    }

    if (zähler < 42 == false) {
      if (Start == true) {
        zähler = 0;
        Gewinncheck1();
      }
    } else {

      zähler++;
      Gewinncheck();
    }
  }


  function Gewinncheck1() {

    if (Felder[zähler] == Farben[0] && Felder[zähler + 7] == Farben[0] && Felder[zähler + 14] == Farben[0] && Felder[zähler + 21] == Farben[0]) {

      console.log("Spieler " + SpielerIds[0] + " hat gewonnen! (Var. 2)")
      TeileMarkierung[0] = Koordinaten[zähler + 7]
      TeileMarkierung[1] = Koordinaten[zähler + 14]
      TeileMarkierung[2] = Koordinaten[zähler + 21]
      Endbildschirm();

    } else if (zähler < 21) {

      zähler++;
      Gewinncheck1();
    } else if (Start == true) {
      zähler = 0;
      Gewinncheck2();
    }
  }


  document.onkeydown = function(event) {
    if (event.keyCode == 70) {
      FolgenMouseOrKeyDown();
    }
  }
  var xMaus;
  var yMaus;
  function readMouseMove(e) {
    if (click.state == "down") click.mouseMove++;
    xMaus = e.clientX + scrollX;
    yMaus = e.clientY + scrollY;
    if (gerät == "Handy") yMaus -= 10;
    //    console.log(xMaus + " - " + yMaus);
  }
  document.onmousemove = readMouseMove
  function checkfieldMouseDown() {
    for (var i = 0; i < 6; i++) {
      for (var i1 = 0; i1 < 7; i1++) {
        if (xMaus > 105 + 155*i1 && xMaus < 105 + 155*i1 + 100 && yMaus > 114 + 111*i && yMaus < 114 + 111*i + 100) {
          console.log(i1 + " - " + i);
          return i1 + "-" + i;
        }
      }
    }
  }
  function FolgenMouseOrKeyDown() {
    if (Start == true && SpielerId == SpielerIds[0] && document.getElementById('modi').value == "Plätchen") {
      antwort = checkfieldMouseDown();
      if (Felder[0 + JSON.parse(antwort[0]) + JSON.parse(antwort[2]) * 7] == "-") {
      JSON.parse(antwort[2]);
      Felder[0 + JSON.parse(antwort[0]) + JSON.parse(antwort[2]) * 7] = Farben[0];

      canvas.fillStyle = Farben[0];
      canvas.beginPath();
      canvas.arc(150 + 150 * JSON.parse(antwort[0]), 65 + 120 * JSON.parse(antwort[2]), 43, 10, 0, Math.PI * 2, true);
      canvas.fill();
      room.send({
        message: antwort
      });
      placedList.push(JSON.parse(JSON.stringify("koord: " + antwort)));
      zähler = 0;
      Gewinncheck();
    }
    }
    if (document.getElementById('modi').value == "runterrutschen" && checkfieldMouseDown() && Felder[JSON.parse(checkfieldMouseDown()[0])] == "-") B(checkfieldMouseDown()[0] + "-0")
  }

  window.addEventListener('mousedown', function() {
    FolgenMouseOrKeyDown();
  });

  function Gewinncheck2() {

    Ablage = zähler + 3
    Ablage = Ablage / 7
    Ablage = "" + Ablage + "";
    if (Ablage.length == 1) {
      zähler = zähler + 3
    }

    if (Felder[zähler] == Farben[0] && Felder[zähler + 8] == Farben[0] && Felder[zähler + 16] == Farben[0] && Felder[zähler + 24] == Farben[0]) {

      console.log("Spieler " + SpielerIds[0] + " hat gewonnen! (Var. 3)")
      TeileMarkierung[0] = Koordinaten[zähler + 8]
      TeileMarkierung[1] = Koordinaten[zähler + 16]
      TeileMarkierung[2] = Koordinaten[zähler + 24]
      Endbildschirm()
    } else if (zähler < 18) {

      zähler++;
      Gewinncheck2();
    } else if (Start == true) {
      zähler = 0;
      Gewinncheck3();
    }
  }

  function Gewinncheck3() {
    //[0 + JSON.parse(antwort[0]) + JSON.parse(antwort[2]) * 7]
    var i1 = 0;
    for (var i = zähler; (i/7 + "").includes("."); i--) {
      i1++;
    }
    console.log(i1);
    if (i1 > 2 && Felder[zähler] == Farben[0] && Felder[zähler + 6] == Farben[0] && Felder[zähler + 12] == Farben[0] && Felder[zähler + 18] == Farben[0]) {

      console.log("Spieler " + SpielerIds[0] + " hat gewonnen! (Var. 4)")
      TeileMarkierung[0] = Koordinaten[zähler + 6]
      TeileMarkierung[1] = Koordinaten[zähler + 12]
      TeileMarkierung[2] = Koordinaten[zähler + 18]
      Endbildschirm();
    } else if (zähler < 21) {

      zähler++;
      Gewinncheck3();
    } else if (Start == true) {

      console.log("Fertig!")
      /*    Ablage = SpielerIds[0]
          SpielerIds[0] = SpielerIds[1]
          SpielerIds[1] = Ablage */
      /*    Ablage = Farben[0]
          Farben[0] = Farben[1]
          Farben[1] = Ablage */
      zähler = 0;
      /*      if (SpielerIds[0] == SpielerId) {
        document.getElementById("Name").innerHTML = "Du bist dran" + " (" + Farben[0] + ")"
      }
      else {
        document.getElementById("Name").innerHTML = "Der Gegner ist dran" + " (" + Farben[1] + ")"
      } */
      console.log("Spielerwechsel");
      room.send({
        message: "Spielerwechsel"
      });
      KoordinatenY = 65;
      KoordinatenX = 300;
      canvas.fillStyle = 'white'; //Farbe
      canvas.fillRect(0, 0, 1800, 750);
      zähler = 0;
      zählerNummerierung = 0;
      Layout();
      LayoutZurrück();
    }
  }

  function Endbildschirm() {
    Start = false;
    audio = new Audio(/*"https://soundbible.com/mp3/Ta Da-SoundBible.com-1884170640.mp3"*/"https://adi.nicolaiweitkemper.de/Sounds/old-victory-sound-roblox-youtubemp3free.org.mp3").play();
    /*  Ablage = Koordinaten[zähler];
      eins = Ablage.toString().split('');
      diff = ((1) * Math.PI * 2 * 10).toFixed(2)
      canvas.lineWidth = 95;
      canvas.fillStyle = 'green'
      canvas.strokeStyle = '#40FF00'
      canvas.textAlign = 'center'
      canvas.beginPath();
      canvas.arc(150 + 150 * JSON.parse(eins[0]), 65 + 120 * JSON.parse(eins[1]), 5, 4.72, diff / 10 + 4.72, false)
      canvas.stroke(); */
    TeileMarkierung[3] = Koordinaten[zähler];
    zähler1 = 0;
    Markierungen();
    room.send({
      message: "Markierungen: " + TeileMarkierung
    });
    setTimeout(function() {
      canvas.font = "135px Arial";
      canvas.fillStyle = "green"
      canvas.fillText("Du hast gewonnen!", 750, 370);
    }, 1735);
    setTimeout(function() {
      room.send({
        message: SpielerIds[0] + " hat gewonnen!"
      });
    }, 200);
    askReplay();
  }
  function askReplay() {
    setTimeout(function () {
      if (confirm("Wollen sie die Runde als Replay speichern? Sie können es sich später auf ihrem Gerät unter express-games/playbacks/vierGewinnt.html angucken.")) {
        if (localStorage.getItem("playBacksVierGewinnt")) var replays = JSON.parse(localStorage.getItem("playBacksVierGewinnt"));
        else var replays = {};
        replays[prompt("Wie wollen sie ihr Replay nennen?")] = {movementList: placedList, selectedMode: modeSelected, farben: Farben, yourColour: yourColour, markierung: markierungMessage};
        localStorage.setItem("playBacksVierGewinnt", JSON.stringify(replays));
      }
    }, 2222);
  }
  function Markierungen() {
    Ablage = TeileMarkierung[zähler1]
    eins = Ablage.toString().split('');
    diff = ((1) * Math.PI * 2 * 10).toFixed(2)
    canvas.lineWidth = 95;
    canvas.fillStyle = 'green'
    canvas.strokeStyle = '#40FF00'
    canvas.textAlign = 'center'
    canvas.beginPath();
    canvas.arc(150 + 150 * JSON.parse(eins[0]), 65 + 120 * JSON.parse(eins[1]), 5, 4.72, diff / 10 + 4.72, false)
    canvas.stroke();
    zähler1++;

    if (zähler1 == TeileMarkierung.length == false) {
      Markierungen();
    }
  }


  function B(Position) {
    if (SpielerIds[0] == SpielerId) {
      Ablage = Position;
      room.send({
        message: Position
      });
      placedList.push(JSON.parse(JSON.stringify("koord: " + Position)));
      PlazierungM2(false);
    }
  }

  function PlazierungM2(nachSpielerwechsel) {

    if (zählerM2 == "") {
      antwort = JSON.parse(Ablage[0]);
      zählerM2 = JSON.parse(Ablage[2]);
    } else {
      KoordinatenY = 65;
      KoordinatenX = 300;
      canvas.fillStyle = 'white'; //Farbe
      canvas.fillRect(0, 0, 1800, 750);
      zähler = 0;
      zählerNummerierung = 0;
      Layout();

      LayoutZurrück();
    }
    if (nachSpielerwechsel == true) {
      canvas.fillStyle = Farben[1];
    } else {
      canvas.fillStyle = Farben[0];
    }
    canvas.beginPath();
    canvas.arc(150 + antwort * 150, 65 + zählerM2 * 120, 45, 0, Math.PI * 2, true);
    canvas.fill();
    canvas.stroke

    zählerM2 = zählerM2 + 1;
    if (Felder[antwort + 7 * JSON.parse(zählerM2)] == "-") {

      setTimeout(function() {

        PlazierungM2(nachSpielerwechsel);
      }, 37);
    } else {
      setTimeout(function() {
        if (nachSpielerwechsel == false) {
          Felder[0 + JSON.parse(antwort) + JSON.parse(zählerM2 - 1) * 7] = Farben[0];
        } else {
          Felder[0 + JSON.parse(antwort) + JSON.parse(zählerM2 - 1) * 7] = Farben[1];
        }
        KoordinatenY = 65;
        KoordinatenX = 300;
        canvas.fillStyle = 'white'; //Farbe
        canvas.fillRect(0, 0, 1800, 750);
        zähler = 0;
        zählerNummerierung = 0;
        Layout();
        LayoutZurrück();
        zählerM2 = "";
        if (nachSpielerwechsel == false) {
          zähler = 0;
          Gewinncheck();
        }
      }, 100);
    }
  }

  function LayoutZurrück() {
    zähler = 0;
    KoordinatenX = 150;
    KoordinatenY = 65;
    while (zähler < 42) {
      if (Felder[zähler] == "red") {

        canvas.fillStyle = "red";
        canvas.beginPath();
        canvas.arc(KoordinatenX, KoordinatenY, 43, 10, 0, Math.PI * 2, true);
        canvas.fill();
      } else if (Felder[zähler] == "blue") {
        canvas.fillStyle = "blue";
        canvas.beginPath();
        canvas.arc(KoordinatenX, KoordinatenY, 43, 10, 0, Math.PI * 2, true);
        canvas.fill();
      }

      KoordinatenX = KoordinatenX + 150;

      if (KoordinatenX == 150 + 150 * 7) {
        KoordinatenX = 150;
        KoordinatenY = KoordinatenY + 120;
      }
      zähler++;
    }
  }
</script>
