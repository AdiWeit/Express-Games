<meta charset="utf-8">
<button type="button" id="turnRight" style="font-size: 40px" onclick="folgenKeyDown({key: 'ArrowRight'});" name="button">⟳</button>
<button type="button" id="turnLeft" style="font-size: 40px" onclick="folgenKeyDown({key: 'ArrowLeft'});" name="button">⟲</button>
<canvas id="textur" style="touch-action: none" width="1565" height="1450" onclick="canvasClicked();"></canvas>
<script>
  window.onbeforeunload = function(){
    console.log("Leave Website");
      sendJson('/dasVerrueckteLabyrinth/logout', {clientId});
      return 'Are you sure you want to leave?';
  };

  async function sendJson(url = "/", body = {}) {
    const rawResponse = await fetch(url, {
      method: 'POST',
      headers: {
        'Accept': 'application/json',
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(body)
    });
    const content = await rawResponse.json();
    return content;
  }

  let oldId = localStorage.getItem('CLIENTIDdasVerrueckteLabyrinth');
  const clientId = oldId ? oldId : makeid(10);
  localStorage.setItem('CLIENTIDdasVerrueckteLabyrinth', clientId);

  var messageListener = null;

  async function register() {
    let response = sendJson('/dasVerrueckteLabyrinth/login', {
      clientId
    });
  }

  register();
  setInterval(getMessages, 1000);

  function getMessages() {
    sendJson('/dasVerrueckteLabyrinth/message-queue', {
      clientId
    }).then(messages => {
      if (messages.length > 0) console.log("MESSAGES", messages);
      messages.forEach(msg => messageListener(msg));
    });
  }

  function sendMessage(obj) {
    sendJson('/dasVerrueckteLabyrinth/message', {
      clientId,
      content: obj
    });
  }

  function makeid(length) {
    var result = '';
    var characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
    var charactersLength = characters.length;
    for (var i = 0; i < length; i++) {
      result += characters.charAt(Math.floor(Math.random() * charactersLength));
    }
    return result;
  }


  var room = {
    setOnMessageListener(listener) {
      messageListener = listener;
    },
    send(msg) {
      sendMessage(msg);
    }
  };
  turnLeft.style.position = "relative";
  turnRight.style.position = "relative";
  var canvas = textur.getContext('2d'); //Dimension
  canvas.fillStyle = "black";
  canvas.fillRect(0, 0, 2000, 2000);
  // var  spielerIch = -1;
  var allItems = {totenschaedel: {collected: false}/*, kaefer: {collected: false}*/, clownMuetze: {collected: false}, fledermaus: {collected: false}, gespenst: {collected: false}, cat: {collected: false}, kerze: {collected: false}, kuerbis: {collected: false}, ritter: {collected: false}, schwert: {collected: false}, ratte: {collected: false}, drache: {collected: false}/*, eule: {collected: false}*/, clownMuetze: {collected: false}, schatzkiste: {collected: false}};
  var player = {aktuell: -1, totalPlayer: -1, myNumber: -1, itemsEachPlayer: {}, selectedCard: {}, movement: "waitingForOpponent", items: {}};
  var fields = [
      {
        wallStructure: [
          {
            type: "wall",
            number: 3
          },
          {
            type: "way",
            number: 3,
          },
          {
            type: "wall",
            number: 3
          }
        ],
        number: 11
      },
      {
        wallStructure: [
          {
            type: "wall",
            number: 4
          },
          {
            type: "way",
            number: 2,
          },
          {
            type: "wall",
            number: 1
          },
          {
            type: "way",
            number: 1,
          },
          {
            type: "wall",
            number: 1
          }
        ],
        number: 16
      },
      {
        wallStructure: [
          {
            type: "wall",
            number: 1
          },
          {
            type: "way",
            number: 1,
          },
          {
            type: "wall",
            number: 1
          },
          {
            type: "way",
            number: 3
          },
          {
            type: "wall",
            number: 3
          }
        ],
        number: 11
      }

  ]
  var field = [];
  function showResult(gewinner, times) {
    if (player.myNumber == gewinner) {
      console.log("Du hast gewonnen!!!");
      if (times == 0) {
          var audio = new Audio("https://adi.nicolaiweitkemper.de/Sounds/longEpicVictorySound.mp3");
          audio.currentTime = 9.0;
          audio.play();
          reset();
      }//audio = new Audio(/*"https://soundbible.com/mp3/Ta Da-SoundBible.com-1884170640.mp3"*/"https://adi.nicolaiweitkemper.de/Sounds/old-victory-sound-roblox-youtubemp3free.org.mp3").play();
        canvas.fillStyle = "green";
        canvas.fillRect(0, 0, 1847, 973);
        var Bild = new Image();
        Bild.src = "https://adi.nicolaiweitkemper.de/Bilder/Gewinnerbildschirm.jpeg";
        canvas.drawImage(Bild, 260, 0);
    } else {
      console.log("Du hast verloren!!!");
      canvas.fillStyle = "red";
      canvas.fillRect(0, 0, 1847, 973)
      var Bild = new Image();
      Bild.src = "https://adi.nicolaiweitkemper.de/Bilder/Verloren%20Bildschirm.jpg"
      canvas.drawImage(Bild, 260, 0);
      if (times == 0)  {var audio = new Audio("https://adi.nicolaiweitkemper.de/Sounds/FAIL%20SOUND%20EFFECT.mp3").play(); reset();}
    }
    setTimeout(function () {
      if (times < 5) showResult(gewinner, times + 1,);
    }, 500);
  }
  room.setOnMessageListener(function(message) {
    if (message.type == "AnzahlSpieler") player.totalPlayer = message.data;
    if (message.type == "gewonnen") showResult(message.data, 0);
    if (message.type == "fieldMoved" && message.data && message.data.direction == "u") field[message.data.stein][6][0][0].movable = false;
    if (message.type == "fieldMoved" && message.data && message.data.direction == "o") field[message.data.stein][0][0][0].movable = false;
    if (message.type == "fieldMoved" && message.data && message.data.direction == "r") field[6][message.data.stein][0][0].movable = false;
    if (message.type == "fieldMoved" && message.data && message.data.direction == "l") field[0][message.data.stein][0][0].movable = false;
    if (message.type == "fieldMoved") player.moved = message.data;
    if (message.type == "fieldMoved" && !player.searchingCard) player.searchingCard = Object.keys(player.items)[Math.round(Math.random() *(Object.keys(player.items).length - 1))];
    if (message.type == "field") {
      field = message.data;
      Layout();
      setTimeout(function () {
        localStorage.setItem("fieldDasVerrueckteLabyrinth", JSON.stringify(field));
        localStorage.setItem("playerDasVerrueckteLabyrinth", JSON.stringify(player));
      }, 777);
    }
    if (message.type == "selectedCard") {
      player.selectedCard = message.data;
    }
    if (message.type == "endGame" && message.alert) alert("Das ein Spieler das Spiel nicht zu ende spielen will, wird das Spiel aufgelöst. Wenn sie ein neues starten wollen, laden sie bitte die Seite neu!");
    if (message.type == "spielerDu") {
      player.myNumber = message.data;
      if (!message.newRound && confirm("Sie haben das Spiel verlassen, bevor es beendet war. Wollen sie es weiterspielen?")) {
        field = JSON.parse(localStorage.getItem("fieldDasVerrueckteLabyrinth"));
        player = JSON.parse(localStorage.getItem("playerDasVerrueckteLabyrinth"));
        Layout();
      }
      else if (!message.newRound) {
        room.send({
          message: {
            "type": "endGame",
            alert: true
          }
        });
      }
      if (message.newRound) {
      setTimeout(function () {
        if ((player.totalPlayer < 3 && message.data == 0) || (message.data + 1 == player.totalPlayer)) {
          for (var i = 0; i < 7; i++) {
            field[i] = [];
            for (var i1 = 0; i1 < 7; i1++) {
              if (i == 0 && i1 == 0) field[i][i1] = newField(true, 0);
              else if (i == 6 && i1 == 0) field[i][i1] = newField(true, 1, "right");
              else if (i == 0 && i1 == 6) field[i][i1] = newField(true, 1, "left");
              else if (i == 6 && i1 == 6) field[i][i1] = newField(true, 2, "right");
              else if (!((i/2 + "").includes(".")) && i1 == 0) field[i][i1] = newField(false, 2, "right");
              else if (!((i/2 + "").includes(".")) && i1 == 6) field[i][i1] = newField(false, 0);
              else if (!((i1/2 + "").includes(".")) && i == 0) field[i][i1] = newField(false, 1, "right");
              else if (!((i1/2 + "").includes(".")) && i == 6) field[i][i1] = newField(false, 1, "left");
              else field[i][i1] = newField();
            }
          }
          for (var i = 0; i < Object.keys(allItems).length; i++) {
            var position = {x: Math.round(Math.random() *6), y: Math.round(Math.random() *6)}
            if (!field[position.x][position.y][1][1].item && !((position.x == 0 && position.y == 0) || (position.x == 0 && position.y == 6) || (position.x == 6 && position.y == 0) || (position.x == 6 && position.y == 6))) field[position.x][position.y][1][1].item = Object.keys(allItems)[i];
            else i--;
          }
          // player.selectedCard = newField();
          var coordSpawner = {0: "0-0", 1: "6-0", 2: "0-6", 3: "6-6"}
          for (var i = 0; i < player.totalPlayer; i++) {
            field[coordSpawner[i].toString().split('-')[0]][coordSpawner[i].toString().split('-')[1]][1][1].player = i;
          }
          player.selectedCard = newField();
            var itemsNichtVergeben = [];
            for (var i = 0; i < Object.keys(allItems).length; i++) {
              itemsNichtVergeben.push(i);
            }
            for (var i = 0; i < player.totalPlayer; i++) {
              var itemsForEachPlayer = {};
              for (var i1 = 0; i1 < Object.keys(allItems).length/player.totalPlayer; i1++) {
                var randomNumber = Math.round(Math.random() *(itemsNichtVergeben.length - 1));
                var randomItem = itemsNichtVergeben[randomNumber];
                itemsForEachPlayer[Object.keys(allItems)[randomItem]] = allItems[Object.keys(allItems)[randomItem]];
                itemsNichtVergeben.splice(randomNumber, 1);
              }
              room.send({
                message: {
                  "type": "items",
                  data: itemsForEachPlayer,
                  empfänger: i
                }
              });
            }
            spielerwechsel(false);
        }
      }, 1000);
    }
    }
    if (message.type == "items" && message.empfänger == player.myNumber && !message.sync) player.items = message.data;
    if (message.type == "items" && Object.keys(message.data).length > 0) player.itemsEachPlayer[message.empfänger] = message.data;
    if (message.type == "Reihenfolge") {
      player.aktuell = message.data;
      if (player.aktuell == player.myNumber) {
        player.movement = "moveField";
        if (gerät == "Handy") {
        textur.style.touchAction = "none";
        turnLeft.style.display = "inline";
        turnRight.style.display = "inline";
      }
      }
      if (field.length) Layout();
    }
  });

  function newField(spawnPoint, directionNumber, direction) {
    if (!spawnPoint) spawnPoint = false;
    var newField = [];
    var possibleStructure = [];
    for (var i = 0; i < fields.length; i++) {
      if (fields[i].number > 0) possibleStructure.push(i);
    }
    var selectedStructure = possibleStructure[Math.round(Math.random() *(possibleStructure.length - 1))];
    if (spawnPoint) selectedStructure = 1;
    else if (directionNumber != undefined) selectedStructure = 2;
    var i2 = 0;
    var i3 = 0;
    // try {
    //   console.log(fields[selectedStructure].wallStructure.length);
    // } catch (e) {
    //   console.log("please debug ;) ");
    // }
    for (var i = 0; i < fields[selectedStructure].wallStructure.length; i++) {
      for (var i1 = 0; i1 < fields[selectedStructure].wallStructure[i].number; i1++) {
        if (!newField[i2]) newField[i2] = [];
        newField[i2][i3] = {type: fields[selectedStructure].wallStructure[i].type, player: false, item: false, spawnPoint: spawnPoint, movable: directionNumber == undefined};
        i2++;
        if (i2 == 3) {i2 = 0; i3++;}
      }
    }

    if (directionNumber == undefined) fields[selectedStructure].number--;
    for (var i = 0; (directionNumber == undefined && i < Math.round(Math.random() * 11)) || (directionNumber != undefined && i < directionNumber); i++) {
      if ((Math.round(Math.random() *1) == 0 && directionNumber == undefined) || (directionNumber != undefined && direction == "right")) newField = turn("right", newField);
      else if (directionNumber == undefined || (directionNumber != undefined && direction == "left")) newField = turn("left", newField);
    }
    return newField
  }
  function turn(direction, officialCard) {
  var newField = [[], [], []];
  newField[1][1] = officialCard[1][1];
  if (direction == "right") {
    for (var i = 0; i < 3; i++) { // rechts --> unten works!
      newField[i][2] = officialCard[2][i];
    }
    for (var i = 0; i < 3; i++) { // unten --> links  works!
      newField[0][i] = officialCard[1 - 1 + i][1 + 1];
    }
    for (var i = 0; i < 3; i++) { // oben --> rechts works!
      newField[2][i] = officialCard[i][0];
    }
    var i1 = 0;
    for (var i = 2; i > -1; i--) { // links --> oben works!
      newField[i1][0] = officialCard[0][i];
      i1++;
    }
  }
  else {
    for (var i = 2; i > -1; i--) { // rechts --> oben
      newField[i][0] = officialCard[2][i];
    }
    var i1 = 0;
    for (var i = 3; i > 0; i--) { // unten --> rechts
      newField[2][i - 1] = officialCard[i1][2];
      i1++;
    }
    var i1 = 0;
    for (var i = 3; i > 0; i--) { // oben --> links
      newField[0][i1] = officialCard[i - 1][0];
      i1++;
    }
    for (var i = 0; i < 3; i++) { // links --> unten
      newField[i][2] = officialCard[0][i];
    }
  }

return newField;
}
  function Layout(times) {
    if (!times) times = 0;
    for (var i = 0; i < 7; i++) {
      for (var i1 = 0; i1 < 7; i1++) {
        displayCard(field, i, i1, 177 + 50*3*i, 177 + 50*3*i1, times);
      }
    }
    if (times < 5) {
      setTimeout(function () {
        Layout(times + 1);
      }, 70);
    }
  }

  function displayCard(field, i, i1, startx, starty, times) {
    canvas.globalAlpha = 1;//0.5
    if (isNaN(times)) canvas.globalAlpha = 0.5;
    for (var i2 = 0; i2 < 3; i2++) {
      for (var i3 = 0; i3 < 3; i3++) {
        if (field[i][i1][i2][i3].type == "wall") canvas.fillStyle = "brown";
        else canvas.fillStyle = "gray";
        if ((i2 == 2 && i3 == 2)) canvas.fillRect(startx + 50*i2, starty + 50*i3, 45, 45);
        else if (i2 == 2) canvas.fillRect(startx + 50*i2, starty + 50*i3, 45, 50);
        else if (i3 == 2) canvas.fillRect(startx + 50*i2, starty + 50*i3, 50, 45);
        else/* (i2 != 2 && i3 != 2)*/ canvas.fillRect(startx + 50*i2, starty + 50*i3, 50, 50);
        var itemsVerbleibend = 0;
        for (var i4 = 0; i4 < Object.keys(player.items).length; i4++) {
          if (!player.items[Object.keys(player.items)[i4]].collected) itemsVerbleibend++;
        }
        var colourPlayer = ["red", "blue", "green", "yellow"];
        if (field[i][i1][i2][i3].item == player.searchingCard && itemsVerbleibend > 0) {
          canvas.fillStyle = colourPlayer[player.myNumber];
          canvas.beginPath();
          canvas.arc(startx + 50*i2 + 50/2, starty + 50*i3 + 50/2, 27, 0, Math.PI * 2, false);
          canvas.fill();
          canvas.fillStyle = "gray";
          canvas.beginPath();
          canvas.arc(startx + 50*i2 + 50/2, starty + 50*i3 + 50/2, 23, 0, Math.PI * 2, false);
          canvas.fill();
        }
        if (field[i][i1][i2][i3].item && (/*!player.items[field[i][i1][i2][i3].item] || */!((player.itemsEachPlayer[0][field[i][i1][i2][i3].item] && player.itemsEachPlayer[0][field[i][i1][i2][i3].item].collected) || (player.itemsEachPlayer[1][field[i][i1][i2][i3].item] && player.itemsEachPlayer[1][field[i][i1][i2][i3].item].collected) || (player.itemsEachPlayer[2] && player.itemsEachPlayer[2][field[i][i1][i2][i3].item] && player.itemsEachPlayer[2][field[i][i1][i2][i3].item].collected)  || (player.itemsEachPlayer[3] && player.itemsEachPlayer[3][field[i][i1][i2][i3].item] && player.itemsEachPlayer[2][field[i][i1][i2][i3].item].collected)))) {
          var Bild = new Image();
          Bild.src = "https://adi.nicolaiweitkemper.de/Bilder/dasVerrueckteLabyrinth/" + field[i][i1][i2][i3].item + ".png";
          canvas.drawImage(Bild, startx + 50*i2, starty + 50*i3, 50, 50);
          if (!(isNaN(times))) canvas.globalAlpha = 1;
          else canvas.globalAlpha = 0.5;
        }
        var colourAndPlayerObj = {"0-0": {colour: "red", player: player.totalPlayer > 0}, "6-0": {colour: "blue", player: player.totalPlayer > 1}, "0-6": {colour: "green", player: player.totalPlayer > 2}, "6-6": {colour: "yellow", player: player.totalPlayer > 3}}
        if (field[i][i1][i2][i3].spawnPoint && i2 == 1 && i3 == 1 && colourAndPlayerObj[i + "-" + i1].player) {
          canvas.fillStyle = colourAndPlayerObj[i + "-" + i1].colour;
          canvas.beginPath();
          canvas.arc(startx + 50*i2 + 50/2, starty + 50*i3 + 50/2, 17, 0, Math.PI * 2, false);
          canvas.fill();
          canvas.fillStyle = "gray";
          canvas.beginPath();
          canvas.arc(startx + 50*i2 + 50/2, starty + 50*(i3) + 50/2, 17 - 5, 0, Math.PI * 2, false);
          canvas.fill();
        }
        itemsVerbleibend = [0, 0, 0, 0];
        for (var i4 = 0; i4 < player.totalPlayer; i4++) {
          for (var i5 = 0; i5 < Object.keys(player.items).length; i5++) {
            if (!player.itemsEachPlayer[i4][Object.keys(player.itemsEachPlayer[i4])[i5]].collected) itemsVerbleibend[i4]++;
          }
        }
        if (field[i][i1][i2][i3].player !== false) {
          canvas.fillStyle = colourPlayer[field[i][i1][i2][i3].player];
          if (player.movingPlayer && i == player.movingPlayer.x && i1 == player.movingPlayer.y) canvas.fillStyle = "#00FF00";
          canvas.beginPath();
          canvas.arc(startx + 50*i2 + 50/2, starty + 50*i3 + 50/2, 17, 0, Math.PI * 2, false);
          canvas.fill();
          canvas.fillStyle = "gray";
          canvas.font = "35px Georgia";
          if (itemsVerbleibend[field[i][i1][i2][i3].player] > 0) canvas.fillText(itemsVerbleibend[field[i][i1][i2][i3].player], startx + 50*i2 + 50/2 - 8, starty + 50*i3 + 50/2 + 10);
          else if (!field[i][i1][i2][i3].spawnPoint) {
            canvas.beginPath();
            canvas.arc(startx + 50*i2 + 50/2, starty + 50*i3 + 50/2, 13, 0, Math.PI * 2, false);
            canvas.fill();
            canvas.fillStyle = colourPlayer[field[i][i1][i2][i3].player];
            canvas.beginPath();
            canvas.arc(startx + 50*i2 + 50/2, starty + 50*i3 + 50/2, 7, 0, Math.PI * 2, false);
            canvas.fill();
          }
        }
      }
    }
    if (field[i][i1][0][0].movable/* && field[1] != undefined*/) canvas.fillStyle = "#40FF00";
    else /*if (field[1] != undefined) */canvas.fillStyle = "red";
    if (!(isNaN(times)) && times == 5 && player.movement == "moveField"/* && i2 == 0 && i3 == 0*/ && (i == 0 || i == 6 || i1 == 0 || i1 == 6) && field[1] != undefined) {
      canvas.globalAlpha = 0.5;
      canvas.fillRect(startx - 5, starty - 5, 45*3 + 20, 45*3 + 20);
      canvas.globalAlpha = 1;
    }
  }
  var xMaus;
  var yMaus;
  document.onmousemove = readMouseMove
  function readMouseMove(e) {
    xMaus = e.clientX + scrollX //- 10;
    yMaus = e.clientY + scrollY + 23//- 33;
    //    console.log(xMaus + " - " + yMaus);
    if (gerät == "PC" && (player.movement == "movingPlayer" || player.movement == "moveField")) folgenMouseMove();
  }
  function clearBorder() {
    canvas.fillStyle = "black";
    canvas.fillRect(0, 0, 173, 2000);
    canvas.fillRect(0, 1227, 2000, 1000);
    canvas.fillRect(0, 0, 2000, 173);
    canvas.fillRect(1227, 0, textur.width, 2050);
  }
  function canvasClicked() {
    var stein = -1;
    // possibleFields = [];
    if ((xMaus > 1230 || xMaus < 120) && yMaus > 130) {
      for (var i = 0; i < 7; i++) {
        if (yMaus > 205 + 50*3*i && yMaus < 205 + 50*3*i + 140) {console.log((i + 1) + ". Stein"); stein = i;}
      }
    }
    else if ((yMaus > 1230 || yMaus < 120) && xMaus > 130) {
      for (var i = 0; i < 7; i++) {
        if (xMaus > 205 + 50*3*i && xMaus < 205 + 50*3*i + 140) {console.log((i + 1) + ". Stein"); stein = i;}
      }
    }
    if (stein > -1 && stein < 7 && player.movement == "moveField") {
      moveField(stein);
    }
    if (player.movement == "movingPlayer") {
      if (playerAblage == undefined) {
      var itemsVerbleibend = [];
      if (field[player.movingPlayer.x][player.movingPlayer.y][player.movingPlayer.i2][player.movingPlayer.i3].item == player.searchingCard) player.items[player.searchingCard].collected = true;
      for (var i = 0; i < Object.keys(player.items).length; i++) {
        if (!player.items[Object.keys(player.items)[i]].collected) itemsVerbleibend.push(Object.keys(player.items)[i]);
      }
      var colourAndPlayerObj = {"0-0": {colour: "red", player: player.totalPlayer > 0}, "6-0": {colour: "blue", player: player.totalPlayer > 1}, "0-6": {colour: "green", player: player.totalPlayer > 2}, "6-6": {colour: "yellow", player: player.totalPlayer > 3}}
      var playerSpawnpoint = {"0-0": 0, "6-0": 1, "0-6": 2, "6-6": 3};
      if (itemsVerbleibend.length == 0 && playerSpawnpoint[player.movingPlayer.x + "-" + player.movingPlayer.y] == player.myNumber && field[player.movingPlayer.x][player.movingPlayer.y][1][1].spawnPoint) {
        console.log("gewonnen!!!");
        room.send({
          message: {
            type: "gewonnen",
            data: player.myNumber/*,
            siegDurch: "Niederlage"*/
          }
        });
      }
      if (field[player.movingPlayer.x][player.movingPlayer.y][player.movingPlayer.i2][player.movingPlayer.i3].item == player.searchingCard) {
        if (itemsVerbleibend.length > 0) player.searchingCard = itemsVerbleibend[Math.round(Math.random() *(itemsVerbleibend.length - 1))];
      }
      spielerwechsel(true);
    }
    else {
      alert("Sie dürfen ihre Figur nicht auf einem bereits besetzen Feld plazieren!");
    }
  }
    for (var i = 0; i < 7; i++) {
      for (var i1 = 0; i1 < 7; i1++) {
        // 177 + 50*3*i, 177 + 50*3*i1
        for (var i2 = 0; i2 < 3; i2++) {
          for (var i3 = 0; i3 < 3; i3++) {
            // if (xMaus > 177 + 50*i2*i && xMaus < 177 + 50*i2*i  + 130 && yMaus > 177 + 50*i3*i1  && yMaus < 177 + 50*i3*i1  + 130 && player.movement == "movingPlayer" && checkMovementPossibe(player.movingPlayer.x, player.movingPlayer.y, player.movingPlayer.i2, player.movingPlayer.i3)) {
            //       field[i][i1][i2][i3].player = player.myNumber
            //       field[player.movingPlayer.x][player.movingPlayer.y][i2][i3].player = false;
            //     }
            if ((/*gerät == "PC" && */xMaus > 177 + 50*3*i + 50*i2 && xMaus < 177 + 50*3*i + 50*i2 + 50 && yMaus > 177 + 50*3*i1 + 50*i3 && yMaus < 177 + 50*3*i1 + 50*i3 + 50) /*|| (gerät == "Handy" && xMaus > 177 + 50*3*i + 50*i2 && xMaus < 177 + 50*3*i + 50*i2 + 50 && yMaus - scrollY > 177 + 50*3*i1 + 50*i3 && yMaus - scrollY < 177 + 50*3*i1 + 50*i3 + 50)*/ && player.movement == "movePlayer" && field[i][i1][i2][i3].player === player.myNumber) {
              player.movingPlayer = {x: i, y: i1, i2: i2, i3: i3};
              // setTimeout(function () {
                player.movement = "movingPlayer";
                canvas.fillStyle = "black";
                canvas.fillRect(0, 0, textur.width, textur.height);
                Layout();
              // }, 1000);
             }
          }
        }
      }
    }
  }
var possibleFields = [];
  function moveField(stein) {
    var feldLegen = JSON.parse(JSON.stringify(player.selectedCard));
    feldLegen[0][0].movable = true;
    // click R
    if (xMaus > 1230 && yMaus > 130 && field[6][stein][0][0].movable) {
      player.selectedCard = JSON.parse(JSON.stringify(field[0][stein]));
      // field[stein].shift();
      // field[stein].push(feldLegen);
      for (var i = 0; i < 6; i++) {
        field[i][stein] = JSON.parse(JSON.stringify(field[i + 1][stein]));
      }
      field[6][stein] = JSON.parse(JSON.stringify(feldLegen));
      if (checkForPlayerOnRemovingCard()) field[6][stein][1][1].player = checkForPlayerOnRemovingCard(true).player;
      removePlayerMoved();
      player.moved = {direction: "l", stein: stein};
    }
    // L
    if (xMaus < 140 && yMaus > 130 && field[0][stein][0][0].movable) {
      player.selectedCard = JSON.parse(JSON.stringify(field[6][stein]));
      // field[stein].shift();
      // field[stein].push(feldLegen);
      for (var i = 6; i > 0; i--) {
        field[i][stein] = JSON.parse(JSON.stringify(field[i - 1][stein]));
      }
      field[0][stein] =JSON.parse(JSON.stringify(feldLegen));
      if (checkForPlayerOnRemovingCard()) field[0][stein][1][1].player = checkForPlayerOnRemovingCard(true).player;
      removePlayerMoved();
      player.moved = {direction: "r", stein: stein};
    }
    // U
    if (yMaus > 1230 && xMaus > 130 && field[stein][6][0][0].movable) {
      player.selectedCard = JSON.parse(JSON.stringify(field[stein][0]));
      field[stein].shift();
      field[stein].push(feldLegen);
      if (checkForPlayerOnRemovingCard()) field[stein][6][1][1].player = checkForPlayerOnRemovingCard(true).player;
      removePlayerMoved();
      player.moved = {direction: "o", stein: stein};
    }
    // O
    if (yMaus < 140 && xMaus > 130 && field[stein][0][0][0].movable) {
      player.selectedCard = JSON.parse(JSON.stringify(field[stein][6]));
      field[stein].pop();
      field[stein].unshift(feldLegen);
      if (checkForPlayerOnRemovingCard()) field[stein][0][1][1].player = checkForPlayerOnRemovingCard(true).player;
      removePlayerMoved();
      player.moved = {direction: "u", stein: stein}
    }
    if ((xMaus > 1230 && yMaus > 130 && field[6][stein][0][0].movable) || (xMaus < 140 && yMaus > 130 && field[0][stein][0][0].movable) || (yMaus > 1230 && xMaus > 130 && field[stein][6][0][0].movable) || (yMaus < 140 && xMaus > 130 && field[stein][0][0][0].movable)) {
      player.movement = "movePlayer";
      turnLeft.style.display = "none";
      turnRight.style.display = "none";
      clearBorder();
    }
    Layout();
  }

  function removePlayerMoved() {
    if (player.moved && player.moved.direction == "u") field[player.moved.stein][6][0][0].movable = true;
    if (player.moved && player.moved.direction == "o") field[player.moved.stein][0][0][0].movable = true;
    if (player.moved && player.moved.direction == "r") field[6][player.moved.stein][0][0].movable = true;
    if (player.moved && player.moved.direction == "l") field[0][player.moved.stein][0][0].movable = true;
  }

  function checkForPlayerOnRemovingCard(turnToFalse) {
    for (var i = 0; i < 3; i++) {
      for (var i1 = 0; i1 < 3; i1++) {
        if (player.selectedCard[i][i1].player !== false) {
          var localPlayer = player.selectedCard[i][i1].player;
          if (turnToFalse) player.selectedCard[i][i1].player = false;
          return {player: localPlayer, i2: i, i3: i1}
      }
    }
    }
  }

  function spielerwechsel(spielerwechsel) {
    if (spielerwechsel) {
    textur.style.touchAction = "";
    player.aktuell++;
    player.movement = "waitingForOpponent";
    if (player.aktuell == player.totalPlayer) player.aktuell = 0;
    player.movingPlayer = undefined;
  }
  setTimeout(function () {
    room.send({
      message: {
        "type": "fieldMoved",
        data: player.moved
      }
    });
    room.send({
      message: {
        "type": "Reihenfolge",
        data: player.aktuell
      }
    });
  }, 1000);
    room.send({
      message: {
        "type": "field",
        data: field
      }
    });
    room.send({
      message: {
        "type": "selectedCard",
        data: player.selectedCard
      }
    });
    room.send({
      message: {
        "type": "items",
        data: player.items,
        sync: true,
        empfänger: player.myNumber
      }
    });
  }
  // var gehabt = [[], [], [], []];
  // function checkMovementPossibe(x, y, i2, i3) {
  //   if (field[x][y][i2][i3].type == "way") possibleFields.push({x: x, y: y, i2: i2, i3: i3});
  //   if (field[x + 1] && field[x + 1][y][i2][i3].type == "way") {
  //     checkMovementPossibe(x + 1, y, i2, i3);
  //
  //   }
  //   if (!(gehabt.includes("" + x + y + i2 + i3)) && field[x][y + 1] && field[x][y + 1][i2] && field[x][y + 1][i2][i3].type == "way") {gehabt[0].push("" + x + y + i2 + i3); checkMovementPossibe(x, y + 1, i2, i3);}
  //   if (!(gehabt.includes("" + x + y + i2 + i3)) && field[x][y][i2 + 1] && field[x][y][i2 + 1][i3] && field[x][y][i2 + 1][i3].type == "way") {gehabt[0].push("" + x + y + i2 + i3); checkMovementPossibe(x, y, i2 + 1, i3);}
  //   if (!(gehabt.includes("" + x + y + i2 + i3)) && field[x][y][i2][i3 + 1] && field[x][y][i2][i3 + 1].type == "way") {gehabt[0].push("" + x + y + i2 + i3); checkMovementPossibe(x, y, i2, i3 + 1);}
  //
  //   if (!(gehabt.includes("" + x + y + i2 + i3)) && field[x - 1] && field[x - 1][y][i2][i3] && field[x - 1][y][i2][i3].type == "way") {gehabt[0].push("" + x + y + i2 + i3); checkMovementPossibe(x - 1, y, i2, i3);}
  //   if (!(gehabt.includes("" + x + y + i2 + i3)) && field[x][y][i2 - 1] && field[x][y][i2 - 1][i3] && field[x][y][i2 - 1][i3].type == "way") {gehabt[0].push("" + x + y + i2 + i3); checkMovementPossibe(x, y, i2 - 1, i3);}
  //   if (!(gehabt.includes("" + x + y + i2 + i3)) && field[x][y - 1] && field[x][y - 1][i2][i3] && field[x][y - 1][i2][i3].type == "way") {gehabt[0].push("" + x + y + i2 + i3); checkMovementPossibe(x, y - 1, i2, i3);}
  //   if (!(gehabt.includes("" + x + y + i2 + i3)) && field[x][y][i2][i3 - 1] && field[x][y][i2][i3 - 1] && field[x][y][i2][i3 - 1].type == "way") {gehabt[0].push("" + x + y + i2 + i3); checkMovementPossibe(x, y, i2, i3 - 1);}
  //
  //
  //   if (!(gehabt.includes("" + x + y + 0 + i3)) && field[x][y + 1] && field[x][y + 1][0] && field[x][y + 1][0][i3].type == "way") {gehabt[0].push("" + x + y + 0 + i3); checkMovementPossibe(x, y + 1, 0, i3);}
  //   if (!(gehabt.includes("" + x + y + 0 + i3)) && field[x][y][0][i3] && field[x][y][0][i3].type == "way") {gehabt[0].push("" + x + y + 0 + i3); checkMovementPossibe(x, y, 0 + 1, i3);}
  //   if (!(gehabt.includes("" + x + y + 0 + i3)) && field[x][y][0][i3 + 1] && field[x][y][0][i3 + 1].type == "way") {gehabt[0].push("" + x + y + 0 + i3); checkMovementPossibe(x, y, 0, i3 + 1);}
  //
  //   if (!(gehabt.includes("" + x + y + 0 + i3)) && field[x - 1] && field[x - 1][y][0][i3] && field[x - 1][y][0][i3].type == "way") {gehabt[0].push("" + x + y + 0 + i3); checkMovementPossibe(x - 1, y, 0, i3);}
  //   if (!(gehabt.includes("" + x + y + 0 + i3)) && field[x][y][0][i3] && field[x][y][0][i3].type == "way") {gehabt[0].push("" + x + y + 0 + i3); checkMovementPossibe(x, y, 0 - 1, i3);}
  //   if (!(gehabt.includes("" + x + y + 0 + i3)) && field[x][y - 1] && field[x][y - 1][0][i3] && field[x][y - 1][0][i3].type == "way") {gehabt[0].push("" + x + y + 0 + i3); checkMovementPossibe(x, y - 1, 0, i3);}
  //   if (!(gehabt.includes("" + x + y + 0 + i3)) && field[x][y][0][i3 - 1] && field[x][y][0][i3 - 1].type == "way") {gehabt[0].push("" + x + y + 0 + i3); checkMovementPossibe(x, y, 0, i3 - 1);}
  //
  //
  //   if (!(gehabt.includes("" + x + y + i2 + 0)) && field[x][y + 1] && field[x][y + 1][i2] && field[x][y + 1][i2][0].type == "way") {gehabt[0].push("" + x + y + i2 + 0); checkMovementPossibe(x, y + 1, i2, 0);}
  //   if (!(gehabt.includes("" + x + y + i2 + 0)) && field[x][y][i2 + 1] && field[x][y][i2 + 1][0] && field[x][y][i2 + 1][0].type == "way") {gehabt[0].push("" + x + y + i2 + 0); checkMovementPossibe(x, y, i2 + 1, 0);}
  //   if (!(gehabt.includes("" + x + y + i2 + 0)) && field[x][y][i2][0 + 1] && field[x][y][i2][0 + 1] && field[x][y][i2][0 + 1].type == "way") {gehabt[0].push("" + x + y + i2 + 0); checkMovementPossibe(x, y, i2, 0 + 1);}
  //
  //   if (!(gehabt.includes("" + x + y + i2 + 0)) && field[x - 1] && field[x - 1][y][i2][0] && field[x - 1][y][i2][0].type == "way") {gehabt[0].push("" + x + y + i2 + 0); checkMovementPossibe(x - 1, y, i2, 0);}
  //   if (!(gehabt.includes("" + x + y + i2 + 0)) && field[x][y][i2 - 1] && field[x][y][i2 - 1][0] && field[x][y][i2 - 1][0].type == "way") {gehabt[0].push("" + x + y + i2 + 0); checkMovementPossibe(x, y, i2 - 1, 0);}
  //   if (!(gehabt.includes("" + x + y + i2 + 0)) && field[x][y - 1] && field[x][y - 1][i2][0] && field[x][y - 1][i2][0].type == "way") {gehabt[0].push("" + x + y + i2 + 0); checkMovementPossibe(x, y - 1, i2, 0);}
  //   if (!(gehabt.includes("" + x + y + i2 + 0)) && field[x][y][i2][0] && field[x][y][i2][0].type == "way") {gehabt[0].push("" + x + y + i2 + 0); checkMovementPossibe(x, y, i2, 0 - 1);}
  //
  //
  //   if (!(gehabt.includes("" + x + y + 0 + 0)) && field[x][y + 1] && field[x][y + 1][0] && field[x][y + 1][0][0].type == "way") {gehabt[0].push("" + x + y + 0 + 0); checkMovementPossibe(x, y + 1, 0, 0);}
  //   if (!(gehabt.includes("" + x + y + 0 + 0)) && field[x][y][0 + 1] && field[x][y][0 + 1][0] && field[x][y][0 + 1][0].type == "way") {gehabt[0].push("" + x + y + 0 + 0); checkMovementPossibe(x, y, 0 + 1, 0);}
  //   if (!(gehabt.includes("" + x + y + 0 + 0)) && field[x][y][0][0 + 1] && field[x][y][0][0 + 1].type == "way") {gehabt[0].push("" + x + y + 0 + 0); checkMovementPossibe(x, y, 0, 0 + 1);}
  //
  //   if (!(gehabt.includes("" + x + y + 0 + 0)) && field[x - 1] && field[x - 1][y][0][0] && field[x - 1][y][0][0].type == "way") {gehabt[0].push("" + x + y + 0 + 0); checkMovementPossibe(x - 1, y, 0, 0);}
  //   if (!(gehabt.includes("" + x + y + 0 + 0)) && field[x][y][0] && field[x][y][0][0] && field[x][y][0][0].type == "way") {gehabt[0].push("" + x + y + 0 + 0); checkMovementPossibe(x, y, 0 - 1, 0);}
  //   if (!(gehabt.includes("" + x + y + 0 + 0)) && field[x][y - 1] && field[x][y - 1][0][0] && field[x][y - 1][0][0].type == "way") {gehabt[0].push("" + x + y + 0 + 0); checkMovementPossibe(x, y - 1, 0, 0);}
  //   if (!(gehabt.includes("" + x + y + 0 + 0)) && field[x][y][0][0] && field[x][y][0][0].type == "way") {gehabt[0].push("" + x + y + 0 + 0); checkMovementPossibe(x, y, 0, 0 - 1);}
  //   for (var i = 0; i < possibleFields; i++) {
  //     if (possibleFields[i].x == i && possibleFields[i].y == i1 && possibleFields[i].i2 == i2 && possibleFields[i].i3 == i3) return true;
  //   }
  //   return false;
  // }
function scrollDownFunction() {
  if (yMaus - scrollY > window.innerHeight - 10)  {
  window.scroll(0, scrollY + 3);
  yMaus += 3;
}
}
scrollDownInt = setInterval(scrollDownFunction, 10);
scrollUpInt = setInterval(function () {
  if ((yMaus - scrollY < 50/* && gerät == "PC"*/)/* || (yMaus - scrollY*2 < 160 && gerät == "Handy")*/) {
    window.scroll(0, scrollY - 3);
    yMaus -= 3;
}
}, 10);
function folgenMouseMove() {
  if (player.movement == "moveField" && Object.keys(player.selectedCard).length > 0 && !(xMaus > 200 - 88 && xMaus < 1222 + 88 && yMaus > 215 - 88 && yMaus < 1238 + 88)) {clearBorder(); displayCard([[player.selectedCard]], 0, 0, xMaus - 83, yMaus - 99, "Tranzparent");}
  for (var i = 0; i < 7 && player.movement == "movingPlayer"; i++) {
    for (var i1 = 0; i1 < 7; i1++) {
      // 177 + 50*3*i, 177 + 50*3*i1
      for (var i2 = 0; i2 < 3; i2++) {
        for (var i3 = 0; i3 < 3; i3++) {
          // if (xMaus > 177 + 50*i2*i && xMaus < 177 + 50*i2*i  + 130 && yMaus > 177 + 50*i3*i1  && yMaus < 177 + 50*i3*i1  + 130 && player.movement == "movingPlayer" && checkMovementPossibe(player.movingPlayer.x, player.movingPlayer.y, player.movingPlayer.i2, player.movingPlayer.i3)) {
          //       field[i][i1][i2][i3].player = player.myNumber
          //       field[player.movingPlayer.x][player.movingPlayer.y][i2][i3].player = false;
          //     }
          if (xMaus > 177 + 50*i2 + 50*3*i && xMaus < 177 + 50*i2 + 50*3*i + 50 && yMaus > 177 + 50*i3 + 50*3*i1 && yMaus < 177 + 50*i3 + 50*3*i1 + 50) {
            if (/*(((i == player.movingPlayer.x + 1 && i1 == player.movingPlayer.y && i2 == player.movingPlayer.i2 && i3 == player.movingPlayer.i3) || (i1 == player.movingPlayer.y + 1 && i == player.movingPlayer.x && i2 == player.movingPlayer.i2 && i3 == player.movingPlayer.i3) || ((i2 == player.movingPlayer.i2 + 1 || (player.movingPlayer.i2 == 2 && i2 == 0) || (player.movingPlayer.i2 == 0 && i2 == 2)) && (((player.movingPlayer.i2 == 2 && i2 == 0) || (player.movingPlayer.i2 == 0 && i2 == 2)) || (i == player.movingPlayer.x && i1 == player.movingPlayer.y && i3 == player.movingPlayer.i3))) || ((i3 == player.movingPlayer.i3 + 1 || (i3 == player.movingPlayer.i3 + 1 || (player.movingPlayer.i3 == 2 && i3 == 0) || (player.movingPlayer.i2 == 0 && i2 == 2))) && ((i3 == player.movingPlayer.i3 + 1 || (player.movingPlayer.i3 == 2 && i3 == 0) || (player.movingPlayer.i2 == 0 && i2 == 2)) || (i == player.movingPlayer.x && (i1 == player.movingPlayer.y) && i2 == player.movingPlayer.i2))) ||
            (i == player.movingPlayer.x - 1 && i1 == player.movingPlayer.y && i2 == player.movingPlayer.i2 && i3 == player.movingPlayer.i3) || (i1 == player.movingPlayer.y - 1 && i == player.movingPlayer.x && i2 == player.movingPlayer.i2 && i3 == player.movingPlayer.i3) || ((i2 == player.movingPlayer.i2 - 1 || (player.movingPlayer.i2 == 2 && i2 == 0) || (player.movingPlayer.i2 == 0 && i2 == 2)) && (((i2 == player.movingPlayer.i2 - 1 || (player.movingPlayer.i2 == 2 && i2 == 0) || (player.movingPlayer.i2 == 0 && i2 == 2))) || (i == player.movingPlayer.x && i1 == player.movingPlayer.y && i3 == player.movingPlayer.i3)))) || ((i3 == player.movingPlayer.i3 - 1 || (i3 == player.movingPlayer.i3 - 1 || (player.movingPlayer.i3 == 2 && i3 == 0) || (player.movingPlayer.i2 == 0 && i2 == 2))) && ((i3 == player.movingPlayer.i3 - 1 || (player.movingPlayer.i3 == 2 && i3 == 0) || (player.movingPlayer.i2 == 0 && i2 == 2)) || (i == player.movingPlayer.x && i1 == player.movingPlayer.y && i2 == player.movingPlayer.i2 && i3 == player.movingPlayer.i3))
          )) && */field[i][i1][i2][i3].type == "way" && ( /*links*/ (i3 == player.movingPlayer.i3 && i1 == player.movingPlayer.y && 177 + 50*i2 + 50*3*i < 177 + 50*player.movingPlayer.i2 + 50*3*player.movingPlayer.x && !(177 + 50*i2 + 50*3*i < 177 + 50*player.movingPlayer.i2 + 50*3*player.movingPlayer.x - 50)) || /*rechts*/(i3 == player.movingPlayer.i3 && i1 == player.movingPlayer.y && 177 + 50*i2 + 50*3*i > 177 + 50*player.movingPlayer.i2 + 50*3*player.movingPlayer.x && !(177 + 50*i2 + 50*3*i > 177 + 50*player.movingPlayer.i2 + 50*3*player.movingPlayer.x + 50)) ||  /*oben*/ (i2 == player.movingPlayer.i2 && i == player.movingPlayer.x && 177 + 50*i3 + 50*3*i1 < 177 + 50*player.movingPlayer.i3 + 50*3*player.movingPlayer.y && !(177 + 50*i3 + 50*3*i1 < 177 + 50*player.movingPlayer.i3 + 50*3*player.movingPlayer.y - 50)) || /*unten*/(i2 == player.movingPlayer.i2 && i == player.movingPlayer.x && 177 + 50*i3 + 50*3*i1 > 177 + 50*player.movingPlayer.i3 + 50*3*player.movingPlayer.y && !(177 + 50*i3 + 50*3*i1 > 177 + 50*player.movingPlayer.i3 + 50*3*player.movingPlayer.y + 50)))) {
              field[player.movingPlayer.x][player.movingPlayer.y][player.movingPlayer.i2][player.movingPlayer.i3].player = false;
              if (playerAblage != undefined) field[player.movingPlayer.x][player.movingPlayer.y][player.movingPlayer.i2][player.movingPlayer.i3].player = JSON.parse(JSON.stringify(playerAblage));
              if (playerAblage != undefined) playerAblage = undefined
              if (!(field[i][i1][i2][i3].player === false)) playerAblage = field[i][i1][i2][i3].player;
              field[i][i1][i2][i3].player = player.myNumber;
              Layout(0);
              player.movingPlayer = {x: i, y: i1, i2: i2, i3: i3};
            }
           }
        }
      }
    }
}
}
var playerAblage;
document.onkeydown = function(event) {
  folgenKeyDown(event);
}

function folgenKeyDown(event) {
  if (event.key == "ArrowRight" && player.movement == "moveField") {
    player.selectedCard = turn("right", player.selectedCard);
    if (gerät == "Handy") xMaus -= 97;
  }
  if (event.key == "ArrowLeft" && player.movement == "moveField") {
    player.selectedCard = turn("left", player.selectedCard);
    if (gerät == "Handy") xMaus += 97;
  }
  if (gerät == "Handy") yMaus -= 55;
  clearBorder();
  folgenMouseMove();
}
document.addEventListener('touchmove', touch);
document.addEventListener('touchstart', touch);
function touch(ev) {
  xMaus = ev.touches[0]["pageX"]// + scrollX;
  yMaus = ev.touches[0]["pageY"]// + scrollY;
  if (ev.type == "touchstart" && player.movement == "movePlayer") {
    canvasClicked();
  }
  if (ev.type == "touchmove") {
    //if (player.movement == "moveField") yMaus -= scrollY;
    folgenMouseMove();
    turnLeft.style.top = yMaus + 3 + "px";
    turnLeft.style.left = xMaus - /*153*/188 + "px";
    turnRight.style.left = xMaus + /*41*/61 + "px";
    turnRight.style.top = yMaus + 3 + "px";
  }
}
turnLeft.style.width = "50px";
turnLeft.style.height = "50px";
turnRight.style.width = "50px";
turnRight.style.height = "50px";

if (navigator.userAgent.match(/Android/i) ||
  navigator.userAgent.match(/webOS/i) ||
  navigator.userAgent.match(/iPhone/i) ||
  navigator.userAgent.match(/iPad/i) ||
  navigator.userAgent.match(/iPod/i) ||
  navigator.userAgent.match(/BlackBerry/i) ||
  navigator.userAgent.match(/Windows Phone/i)
) {
  var gerät = "Handy"
  console.log("Handy");
} else {
  var gerät = "PC"
  console.log("PC");
}
textur.style.touchAction = "";
turnLeft.style.display = "none";
turnRight.style.display = "none";
</script>
