<div id="voting">
  <input type="text" id="amountOfGlasses" placeholder="glasses to compare at the same time" value="3">
  <input type="text" id="pointsRequiredT" placeholder="points for win" value="5">
  <br>
  <h2>different shapes</h2>
  <input type="checkbox" id="differentShapesCheck">
  <br>
  <button type="button" id="confirmVoteB" onclick="confirmVote();" name="button">this is my vote!</button>
</div>
<button type="button" id="readyB" onclick="playerReady();" name="button">ready!</button>
<canvas id="textur" width="1844" onclick="canvasClicked();" height="700"></canvas>

<script>
  readyB.style.display = "none";
  window.onbeforeunload = function(){
    console.log("Leave Website");
      sendJson('/guessTheValue/logout', {clientId});
      return 'Are you sure you want to leave?';
  };

  async function sendJson(url = "/", body = {}) {
    const rawResponse = await fetch(url, {
      method: 'POST',
      headers: {
        'Accept': 'application/json',
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(body)
    });
    const content = await rawResponse.json();
    return content;
  }

//  let oldId = localStorage.getItem('CLIENTIDguessTheValue');
  const clientId = /*oldId ? oldId : */makeid(10);
//  localStorage.setItem('CLIENTIDguessTheValue', clientId);

  var messageListener = null;

  async function register() {
    let response = sendJson('/guessTheValue/login', {
      clientId
    });
  }

  register();
  setInterval(getMessages, 100);

  function getMessages() {
    sendJson('/guessTheValue/message-queue', {
      clientId
    }).then(messages => {
      if (messages.length > 0) console.log("MESSAGES", messages);
      messages.forEach(msg => messageListener(msg));
    });
  }

  function sendMessage(obj) {
    sendJson('/guessTheValue/message', {
      clientId,
      content: obj
    });
  }

  function makeid(length) {
    var result = '';
    var characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
    var charactersLength = characters.length;
    for (var i = 0; i < length; i++) {
      result += characters.charAt(Math.floor(Math.random() * charactersLength));
    }
    return result;
  }


  var room = {
    setOnMessageListener(listener) {
      messageListener = listener;
    },
    send(msg) {
      sendMessage(msg);
    }
  };
  var player = {points: []};
  var mode = "";
  var vote = [];
  var canvas = textur.getContext('2d'); //Dimension
  room.setOnMessageListener(function(message) {
    // if (message.type == "Reihenfolge") {
    //   player.aktuell = message.data;
    //  }
    if (message.type == "wrongAnswer") {
      wrongAnswers++;
      if (wrongAnswers == player.total) readyB.style.display = "inline";
    }
    if (message.type == "playerReady") {
      playerReadyList++;
      if (playerReadyList == player.total && player.myNumber == 0) createNewSize();
    }
    if (message.type == "spielerDu") {
      player.myNumber = message.data;
      vote = [];
      mode = "";
      playerReadyList = 0;
      voting.style.display = "inline";
      setTimeout(function () {
        confirmVote();
      }, 30000);
    }
    if (message.type == "AnzahlSpieler") player.total = message.data;
    if (message.type == "onePoint") {
      inRound = false;
      if (!player.points[message.number]) player.points[message.number] = 0;
      player.points[message.number]++;
      for (var i = 0; i < amount; i++) {
        showResults(0, 0, i);
        canvas.fillStyle = "black";
        canvas.font = "30px Georgia";
        if (player.points[i] != undefined) canvas.fillText(player.points[i], 60 + 188*i, 77);
      }
      readyB.style.display = "inline";
      if (player.points[message.number] == player.requiredPoints) showResult(message.number, 0);
    }
    if (message.type == "size") {inRound = true; playerReadyList = 0; wrongAnswers = 0;}
    if (message.type == "size"/* && mode == "normal"*/) {
      size = message.data;
      layout();
    }
    if (message.type == "vote") {
      vote.push(message.data);
      if (vote.length >= player.total) {
        if (vote.length == player.total) {
          amount = 0;
          voting.style.display = "none";
          player.requiredPoints = 0;
          for (var i = 0; i < vote.length; i++) {
            amount += vote[i].amountOfGlasses;
            player.requiredPoints += vote[i].pointsRequired;
          }
          amount = amount/vote.length;
          player.requiredPoints = player.requiredPoints/vote.length;
          if (player.myNumber == 0) {
            setTimeout(function () {
              createNewSize();
            }, 1000);
        }
      }
        var modeCounter = 0;
        for (var i = 0; i < vote.length; i++) {
          if (vote[i].mode) modeCounter++;
          else modeCounter--;
        }
        if (modeCounter > 0) {
          mode = "differentShapes";
          if (mode == "") alert("different shapes wins!");
        }
        else if (modeCounter < 0) {
          mode = "normal";
          if (mode == "") alert("easy shapes wins!");
        }
        else {
          if (mode == "") alert("The vote results in a draw! The Computer will decide, which mode will be placed!");
          if (player.myNumber == 0) {
            room.send({
              message: {
                "type": "vote",
                data: {mode: Math.floor(Math.random() *1), amountOfGlasses: message.data.amountOfGlasses, pointsRequired: message.data.pointsRequired}
              }
            });
          }
        }
      }
    }
  });
  var amount = 0;
  var size = {};
  var wrongAnswers = 0;
  function confirmVote() {
    room.send({
      message: {
        "type": "vote",
        "data": {mode: differentShapesCheck.checked, amountOfGlasses: JSON.parse(amountOfGlasses.value), pointsRequired: JSON.parse(pointsRequiredT.value)}
      }
    });
  }
  function createNewSize() {
    if (mode == "differentShapes") {
      var data = {points: []};
      for (var i = 0; i < amount; i++) {
        data.points.push([]);
      for (var i1 = 0; i1 < 4 + Math.round(Math.random() *3); i1++) {
        data.points[i].push({x: Math.round(Math.random() *100) + 50, y: Math.round(Math.random() *100) + 50});
      }
    }
    }
    else {
      var data = {width: [], height: []}
      var umfang = Math.round(Math.random() *166) + 210;
      for (var i = 0; i < amount; i++) {
        data.width.push(Math.round(Math.random() *122) + 50);
        data.height.push(umfang - data.width[i] - Math.round(Math.random() *22))
        // data.height.push(Math.round(Math.random() *88) + 50);
        // var highest = {width: {number: 0, i: -1}, height: {number: 0, i: -3}}
        // var lowest = {width: {number: 200, i: -2}, height: {number: 200, i: -4}}
        // for (var i1 = 0; i1 < data.width.length; i1++) {
        //   if (data.width[i1] > highest.width.number) {highest.width.number = data.width[i1]; highest.width.i = i1;}
        //   if (data.height[i1] > highest.height.number) {highest.height.number = data.height[i1]; highest.height.i = i1;}
        //   if (data.width[i1] < lowest.width.number) {lowest.width.number = data.width[i1]; lowest.width.i = i1;}
        //   if (data.height[i1] < lowest.height.number) {lowest.height.number = data.height[i1]; lowest.height.i = i1;}
        // }
        // var prettyHigh = {width: [], height: []};
        // for (var i1 = 0; i1 < amount; i1++) {
        //   if ((data.width[i] > highest.width.number - 11 || data.width[i] > highest.width.number + 11) && i1 != highest.width.i) prettyHigh.width.push(i1);
        //   if ((data.height[i] > highest.height.number - 11 || data.height[i] > highest.height.number + 11) && i1 != highest.height.i) prettyHigh.height.push(i1);
        // }
        // if (i > 0 && (highest.width.i == highest.height.i || lowest.width.i == lowest.height.i/* || prettyHigh.width.includes(i) ||prettyHigh.height.includes(i) || (i > 0 && (data.height[i]*data.width[i] - data.height[i - 1]*data.width[i - 1] > 7333 || data.height[i]*data.width[i] - data.height[i - 1]*data.width[i - 1] < -7333))  /*(i > 0 && ((data.width[i] - data.width[i - 1] < 10) && (data.height[i] - data.width[i-1] < 10)))*/)) {i--; data.width.pop(); data.height.pop();};
      }
    }
    room.send({
      message: {
        "type": "size",
        "data": data
      }
    });
  }
  // function spielerwechsel() {
  //   player.aktuell++;
  //   if (player.aktuell == player.total) player.aktuell = 0;
  //   room.send({
  //     message: {
  //       "type": "Reihenfolge",
  //       data: player.aktuell
  //     }
  //   });
  // }
  var filled = 0;
  function showResult(verlierer, times) {
    if (times == 0) {
      room.send({
        message: {
          "type": "endGame"
        }
      });
      setTimeout(function () {
        alert("Please relaod the page to play an other round!");
      }, 3333);
    }
    if (player.myNumber != verlierer) {
      console.log("Du hast gewonnen!!!");
      if (times == 0) {
          var audio = new Audio("https://adi.nicolaiweitkemper.de/Sounds/longEpicVictorySound.mp3");
          audio.currentTime = 9.0;
          audio.play();
      }//audio = new Audio(/*"https://soundbible.com/mp3/Ta Da-SoundBible.com-1884170640.mp3"*/"https://adi.nicolaiweitkemper.de/Sounds/old-victory-sound-roblox-youtubemp3free.org.mp3").play();
        canvas.fillStyle = "green";
        canvas.fillRect(0, 0, 1847, 973);
        var Bild = new Image();
        Bild.src = "https://adi.nicolaiweitkemper.de/Bilder/Gewinnerbildschirm.jpeg";
        canvas.drawImage(Bild, 260, 0);
    } else {
      console.log("Du hast verloren!!!");
      canvas.fillStyle = "red";
      canvas.fillRect(0, 0, 1847, 973)
      var Bild = new Image();
      Bild.src = "https://adi.nicolaiweitkemper.de/Bilder/Verloren%20Bildschirm.jpg"
      canvas.drawImage(Bild, 260, 0);
      if (times == 0)  {var audio = new Audio("https://adi.nicolaiweitkemper.de/Sounds/FAIL%20SOUND%20EFFECT.mp3").play();}
    }
    setTimeout(function () {
      if (times < 5) showResult(verlierer, times + 1);
    }, 500);
    setTimeout(function () {
      makeAudio = false;
    }, 3000);
  }
  var playerReadyList = 0;
  function playerReady() {
    readyB.style.display = "none";
    room.send({
      message: {
        "type": "playerReady"
      }
    });
  }
  function showResult(gewinner, times) {
    if (/*!makeAudio && */times == 0) {
      inRound = true;
      setTimeout(function () {
        inRound = false;
      }, 100);
      room.send({
        message: {
          "type": "endGame"
        }
      });
      setTimeout(function () {
        alert("Please relaod the page to play an other round!");
      }, 3333);
    }
    if (player.myNumber == gewinner) {
      console.log("Du hast gewonnen!!!");
      if (times == 0/* && !makeAudio*/) {
          var audio = new Audio("https://adi.nicolaiweitkemper.de/Sounds/longEpicVictorySound.mp3");
          audio.currentTime = 9.0;
          audio.play();
          // makeAudio = true;
      }//audio = new Audio(/*"https://soundbible.com/mp3/Ta Da-SoundBible.com-1884170640.mp3"*/"https://adi.nicolaiweitkemper.de/Sounds/old-victory-sound-roblox-youtubemp3free.org.mp3").play();
        canvas.fillStyle = "green";
        canvas.fillRect(0, 0, 1847, 973);
        var Bild = new Image();
        Bild.src = "https://adi.nicolaiweitkemper.de/Bilder/Gewinnerbildschirm.jpeg";
        canvas.drawImage(Bild, 260, 0);
    } else {
      console.log("Du hast verloren!!!");
      canvas.fillStyle = "red";
      canvas.fillRect(0, 0, 1847, 973)
      var Bild = new Image();
      Bild.src = "https://adi.nicolaiweitkemper.de/Bilder/Verloren%20Bildschirm.jpg"
      canvas.drawImage(Bild, 260, 0);
      if (times == 0/* && !makeAudio*/)  {/*makeAudio = true; */var audio = new Audio("https://adi.nicolaiweitkemper.de/Sounds/FAIL%20SOUND%20EFFECT.mp3").play();}
    }
    setTimeout(function () {
      if (times < 5) showResult(gewinner, times + 1,);
    }, 500);
    // setTimeout(function () {
    //   makeAudio = false;
    // }, 3000);
  }
  // var makeAudio = false;
  function showResults(time, i1, i) {
    //canvas.fillStyle = "#0B99B6";
    var highestMult = {i: -1, number: 0}
    for (var i2 = 0; i2 < amount; i2++) {
      if (mode == "normal" && highestMult.number < size.height[i2]*size.width[i2]) {highestMult.number = size.height[i2]*size.width[i2]; highestMult.i = i2;}
    }
    if (i == highestMult.i) canvas.fillStyle = "#40FF00";
    else canvas.fillStyle = "red";
    canvas.fillRect(20 + 10 + 188*i + time, 20 + (highest.number - size.height[i]) + size.height[i] - i1, 1, 1);
    time++;
    if (time == size.width[i] - 10) {i1++; time = 0;}
    if (i1 == size.height[i] + 1) console.log("finishedResult " + i);
    else {
      setTimeout(function () {
        if (!inRound) showResults(time, i1, i);
      }, 1);
    }
  }
  var highest;
  function layout() {
    canvas.fillStyle = "#FFBF00";
    canvas.fillRect(0, 0, textur.width, textur.height);
    if (mode == "normal") {
    highest = {i: -1, number: 0}
    for (var i = 0; i < amount; i++) {
      if (highest.number < size.height[i]) {highest.number = size.height[i]; highest.i = i;}
    }
    for (var i = 0; i < amount; i++) {
        canvas.fillStyle = "black";
        canvas.fillRect(20 + 188*i, 20 + (highest.number - size.height[i]), 10, size.height[i]);
        canvas.fillRect(20 + 188*i, 20 + (highest.number - size.height[i]) + size.height[i], size.width[i] + 10, 10);
        canvas.fillRect(20 + 188*i + size.width[i], 20 + (highest.number - size.height[i]), 10, size.height[i]);
      }
    // canvas.fillStyle = "#0B99B6";
    // canvas.fillRect(30, (20 +size.height[i] - filled), 40, filled);
  }
  else {
    canvas.fillStyle = "black";
    for (var i = 0; i < size.points.length; i++) {
    canvas.beginPath();
    canvas.moveTo(20 + 188*i + size.points[i][0].x, size.points[i][0].y);
    for (var i1 = 1; i1 < size.points[i].length - 1; i1++) {
      canvas.lineTo(20 + 188*i + size.points[i][i1].x, size.points[i][i1].y);
    }
    canvas.lineTo(20 + 188*i + size.points[i][0].x, size.points[i][0].y);
    canvas.closePath();
    canvas.fill();
  }
  }
  }
  function readMouseMove(e) {
    xMaus = e.clientX + scrollX;
    yMaus = e.clientY + scrollY + 23;
    //    console.log(xMaus + " - " + yMaus);
  }
  document.onmousemove = readMouseMove
  var inRound = false;
  function canvasClicked() {
    if (mode == "normal" && inRound && checkSelected() != undefined) {
      var biggest = {number: 0, i: -1}
      for (var i = 0; i < amount; i++) {
        if (size.width[i]*size.height[i] > biggest.number) {biggest.number = size.width[i]*size.height[i]; biggest.i = i;}
      }
      if (checkSelected() == biggest.i) {
        room.send({
          message: {
            "type": "onePoint",
            number: player.myNumber
          }
        });
        console.log("right answer!");
      }
      else {
        console.log("wrong answer!");
        room.send({
          message: {
            "type": "wrongAnswer"
          }
        });
      }
      inRound = false;
    }
  }

  function checkSelected() {
      for (var i = 0; i < amount; i++) {
        if (xMaus > 20 + 188*i && xMaus < 20 + 188*i + size.width[i]/* && yMaus > 19 && yMaus */) return i;
      }
  }

</script>
