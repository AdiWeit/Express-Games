<div id="settings" style="display: 'none'">
<h1 id="selectedSensibility">high sensibility</h1>
<button type="button" id="buttonSensibility" onclick="changeSensibility(selectedSensibility.innerHTML);" name="button">change</button>
<button type="button" id="bereitButton" onclick="confirmSetting();" name="button">bereit!</button>
<br>
</div>
<canvas id="textur" width="300" height="300"></canvas>
<div id="ball">
  <style>
    .shape {
 position: absolute;
 width: 20px;
 height: 20px;
 -webkit-radius: 20px;
 margin:0;width
 padding:0;
}
#sphere1{
 border-radius: 20px;
 background-color: blue;
}
</style>
</div>
<div id="content">
  <div class="shape" id="sphere1"></div>
</div>
<script>
  window.onbeforeunload = function(){
    console.log("Leave Website");
      sendJson('/asFastAsYouCan/logout', {clientId});
      return 'Are you sure you want to leave?';
  };

  async function sendJson(url = "/", body = {}) {
    const rawResponse = await fetch(url, {
      method: 'POST',
      headers: {
        'Accept': 'application/json',
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(body)
    });
    const content = await rawResponse.json();
    return content;
  }

  let oldId = localStorage.getItem('CLIENTIDasFastAsYouCan');
  const clientId = oldId ? oldId : makeid(10);
  localStorage.setItem('CLIENTIDasFastAsYouCan', clientId);

  var messageListener = null;

  async function register() {
    let response = sendJson('/asFastAsYouCan/login', {
      clientId
    });
  }

  register();
  setInterval(getMessages, 1000);

  function getMessages() {
    sendJson('/asFastAsYouCan/message-queue', {
      clientId
    }).then(messages => {
      if (messages.length > 0) console.log("MESSAGES", messages);
      messages.forEach(msg => messageListener(msg));
    });
  }

  function sendMessage(obj) {
    sendJson('/asFastAsYouCan/message', {
      clientId,
      content: obj
    });
  }

  function makeid(length) {
    var result = '';
    var characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
    var charactersLength = characters.length;
    for (var i = 0; i < length; i++) {
      result += characters.charAt(Math.floor(Math.random() * charactersLength));
    }
    return result;
  }


  var room = {
    setOnMessageListener(listener) {
      messageListener = listener;
    },
    send(msg) {
      sendMessage(msg);
    }
  };
  settings.style.display = "none";
  var sphere1 = document.getElementById("sphere1");
  var x1 = 10,
  y1 = 177; //window.innerHeight - 150 + 3,
  x2 = 0, y2 = 0,
  vx1 = 0, vy1 = 0,
  vx2 = 0, vy2 = 0,
  ax1 = 0, ay1 = 0;
  var canvas = textur.getContext('2d'); //Dimension
  var spielerIch = "";
  var AnzahlSpieler = -1;
  var player = {};
  var times = {}
  var lowestSize = {x: 3000, y: 2000}
  var sensibility = 0;
  room.setOnMessageListener(function(message) {
    if (message.type == "AnzahlSpieler") {AnzahlSpieler = message.data; localStorage.setItem('AnzahlSpielerAsFastAsYouCan', AnzahlSpieler);}
    if (message.type == "endRound") {
      times[message.sender] = message.time
      if (Object.keys(times).length == AnzahlSpieler) {
        console.log("everybodyFinished");
        showResults();
      }
    }
    if (message.type == "spielerDu") {
      spielerIch = message.data;
      player[spielerIch] = {};
      player[spielerIch].selectedSensibility = "high";
      player[spielerIch].selected = false;
      player[spielerIch].points = 0;
      player.confirmed = 0;
      settings.style.display = "inline";
      if (!message.newRound) localStorage.getItem('AnzahlSpielerAsFastAsYouCan');
      for (var i = 0; i < Object.keys(player).length; i++) {
        if (Object.keys(player)[i] != "confirmed") {
        room.send({
          message: {
            "type": "lowestSize",
            data: lowestSize,
            empfänger: Object.keys(player)[i]
          }
        });
      }
    }
    }
    if (message.type == "lowestSize" && message.empfänger == spielerIch) {
      if (window.innerWidth < lowestSize.x) lowestSize.x = window.innerWidth;
      if (window.innerHeight < lowestSize.y) lowestSize.y = window.innerHeight;
    }
    if (message.type == "endPoint") {
      textur.width = lowestSize.x;
      textur.height = lowestSize.y;
      canvas.fillStyle = "yellow";
      canvas.fillRect(message.data.x, message.data.y, 50, 50);
      x1 = message.playerPosition.x;
      y1 = message.playerPosition.y;
      startPause();
    }
    if (message.type == "ready") {
      player[message.sender] = message.data;
      player.confirmed++;
      if (player.confirmed == AnzahlSpieler && player[spielerIch].selected) {
        settings.style.display = "none";
        window.ondevicemotion = function(e) {
          ax1 = event.accelerationIncludingGravity.x * sensibility;
          ay1 = event.accelerationIncludingGravity.y * sensibility;
        }
        var sensibilityConverter = {low: 0, high: 0};
        for (var i = 0; i < Object.keys(player).length; i++) {
          if (Object.keys(player)[i] != "confirmed") sensibilityConverter[player[Object.keys(player)[i]].selectedSensibility]++;
        }
        if (sensibilityConverter.low > sensibilityConverter.high) sensibility = 15;
        else if (sensibilityConverter.low < sensibilityConverter.high) sensibility = 50;
        else sensibility = Math.floor(Math.random() * (50));
        if (spielerIch == message.sender) {
          room.send({
            message: {
              "type": "endPoint",
              data: {x: Math.floor(Math.random() * (lowestSize.x -100)), y: Math.floor(Math.random() * (lowestSize.y -100))},
              playerPosition: {x: Math.floor(Math.random() * (lowestSize.x -100)), y: Math.floor(Math.random() * (lowestSize.y -100))}
            }
          });
        }
      }
    }
  });
  function changeSensibility(innerHTML) {
    if (innerHTML == "high sensibility") selectedSensibility.innerHTML = "low sensibility";
    else selectedSensibility.innerHTML = "high sensibility";
    player[spielerIch].selectedSensibility = selectedSensibility.innerHTML.toString().split(' sensibility')[0];
  }
  function confirmSetting() {
    if (!player[spielerIch].selected) {
      player[spielerIch].selected = true;
      room.send({
        message: {
          "type": "ready",
          data: player[spielerIch],
          sender: spielerIch,
          width: window.innerWidth,
          height: window.innerHeight
        }
      });
    }
  }
  function showResults() {
    var bestTime = {time: "10:10:09", player: -1};
    for (var i = 0; i < Object.keys(times).length; i++) {
      if (times[Object.keys(times)[i]] < bestTime.time) {bestTime.time = times[Object.keys(times)[i]]; bestTime.player = i};
    }
    for (var i = 0; i < Object.keys(times).length; i++) {
      if (Object.keys(times)[i] == spielerIch) canvas.fillStyle = "blue";
      if (i == bestTime.player) canvas.fillStyle = "red";
      else if (Object.keys(times)[i] != spielerIch) canvas.fillStyle = "black";
      canvas.font = "30px Georgia";
      canvas.fillText("time: " + times[Object.keys(times)[i]], 50, 50 + 70*i);
    }
    player[Object.keys(times)[bestTime.player]].points++;
    setTimeout(function () {
      canvas.clearRect(0, 0, screen.width, screen.height);
      for (var i = 0; i < Object.keys(times).length; i++) {
        if (Object.keys(times)[i] == spielerIch) canvas.fillStyle = "blue";
        if (i == bestTime.player) canvas.fillStyle = "red";
        else if (Object.keys(times)[i] != spielerIch) canvas.fillStyle = "black";
        canvas.font = "30px Georgia";
        canvas.fillText("points: " + player[Object.keys(times)[i]].points, 50, 50 + 70*i);
      }
      player[spielerIch].selected = false;
      player.confirmed = 0;
      settings.style.display = "inline";
      times = {};
    }, 3000);
  }
  if (window.DeviceMotionEvent != undefined) {
  window.ondevicemotion = function(e) {
    ax1 = event.accelerationIncludingGravity.x * 5;
    ay1 = event.accelerationIncludingGravity.y * 5;
  }
  setInterval(function() {
    var landscapeOrientation = screen.width;
    if (landscapeOrientation) {
      vx1 = vx1 + ay1;
      vy1 = vy1 + ax1;
      vx2 = vx2 + ay1;
      vy2 = vy2 + ax1;
    } else {
      vy1 = vy1 - ay1;
      vx1 = vx1 + ax1;
      vy2 = vy2 - ay1;
      vx2 = vx2 + ax1;
    }
    vx1 = vx1 * 0.98;
    vy1 = vy1 * 0.98;
    y1 = parseInt(y1 + vy1 / 50);
    x1 = parseInt(x1 + vx1 / 50);

    vx2 = vx2 * 0.98;
    vy2 = vy2 * 0.98;
    y2 = parseInt(y2 + vy2 / 30);
    x2 = parseInt(x2 + vx2 / 30);
    //  if (scrollY > 0) document.getElementById('sphere1').style.display = "none";
    sphere1.style.width = 20;
    sphere1.style.height = 20;
    boundingBoxCheck();
    sphere1.style.top = y1 + "px";
    sphere1.style.left = x1 + "px";
    var numbers = [
      [x1 + JSON.parse(sphere1.style.width.replace("px", "")) - 7, y1 + JSON.parse(sphere1.style.height.replace("px", "")) / 2],
      [x1 + JSON.parse(sphere1.style.width.replace("px", "")) / 2, y1 - 8],
      [x1 + JSON.parse(sphere1.style.width.replace("px", "")) / 2, y1 + JSON.parse(sphere1.style.height.replace("px", "")) - 7],
      [x1 - 10, y1 + JSON.parse(sphere1.style.height.replace("px", "")) / 2]
    ]
    for (var i = 0; i < 4; i++) {
      data = canvas.getImageData(numbers[i][0], numbers[i][1], 1, 1);
      red = data.data[0];
      green = data.data[1];
      blue = data.data[2];
      alpha = data.data[3];
      if (red == 255 && blue == 0 && alpha == 255 && green == 255) {
        console.log("geschafft!");
        startPause();
        canvas.clearRect(0, 0, lowestSize.x, lowestSize.y);
        room.send({
          message: {
            "type": "endRound",
            sender: spielerIch,
            time: mins + ":" + secs + ":" + "0" + tenths
          }
        });
      }
    }
  }, 25);
}


    function boundingBoxCheck() {
      if (x1 < 0) {
        x1 = 0;
        vx1 = -vx1;
      }
      if (y1 < 0) {
        y1 = 0;
        vy1 = -vy1;
      }
      if (x1 > window.innerWidth - JSON.parse(sphere1.style.width.toString().split('px')[0]) / 2) {
        x1 = window.innerWidth - JSON.parse(sphere1.style.width.toString().split('px')[0]) / 2;
        vx1 = -vx1;
      }
      if (y1 > screen.height - JSON.parse(sphere1.style.height.toString().split('px')[0]) / 2) {
        y1 = screen.height - JSON.parse(sphere1.style.height.toString().split('px')[0]) / 2;
        vy1 = -vy1;
      }
      if (x2 < 0) {
        x2 = 0;
        vx2 = -vx2;
      }
      if (y2 < 0) {
        y2 = 0;
        vy2 = -vy2;
      }
      if (x2 > window.innerWidth - JSON.parse(sphere1.style.width.toString().split('px')[0]) / 2) {
        x2 = window.innerWidth - JSON.parse(sphere1.style.width.toString().split('px')[0]) / 2;
        vx2 = -vx2;
      }
      if (y2 > screen.height - JSON.parse(sphere1.style.height.toString().split('px')[0]) / 2) {
        y2 = screen.height - JSON.parse(sphere1.style.height.toString().split('px')[0]) / 2;
        vy2 = -vy2;
      }
    }

var time = 0;
var running = 0;

function startPause() {
if (running == 0) {
  running = 1;
  time = 0;
  increment();
}
else {
  running = 0;
}
}
function reset() {
running = 0;
timer = 0;
}
var mins = 0;
var secs = 0;
var tenths = 0;
function increment() {
if (running == 1) {
setTimeout(function () {
  time++;
   mins = Math.floor(time/10/60);
   secs = Math.floor(time/10);
   secs -= 60*mins;
   tenths = time % 10;
  if (mins < 10) {
    mins = "0" + mins
  }
  if (secs < 10) {
    secs = "0" + secs;
  }
  increment();
}, 100);
}
}
</script>
