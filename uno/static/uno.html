<canvas id="textur" width="1570" height="750"></canvas>

<script>
  var spielerIch = -1;
  var spielerAktuell = -1;
  var spielerGegner = -1;
  var AnzahlSpieler = -1;
  var canvas = document.getElementById('textur').getContext('2d'); //Dimension
  var koordinaten = [];
  var AblageListe = [];
  var Bild = new Image();
  var sperren = [false];
  // var imgData = canvas.getImageData(0,0,textur.width,textur.height);
  // var imgDataData = imgData.data;

  var red = new Array(); var green = new Array(); var blue = new Array(); var alpha = new Array();
  var redStay = 0; var greenStay = 0; var blueStay = 0; var aphaStay = 0;

  window.onbeforeunload = function() {
    console.log("Leave Website");
    sendJson('/uno/logout', {
      clientId
    });
    return 'Are you sure you want to leave?';
  };

  async function sendJson(url = "/", body = {}) {
    const rawResponse = await fetch(url, {
      method: 'POST',
      headers: {
        'Accept': 'application/json',
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(body)
    });
    const content = await rawResponse.json();
    return content;
  }

  const clientId = makeid(10);
  var messageListener = null;

  async function register() {
    let response = sendJson('/uno/login', {
      clientId
    });
  }

  register();
  setInterval(getMessages, 3000);

  function getMessages() {
    sendJson('/uno/message-queue', {
      clientId
    }).then(messages => {
      console.log("MESSAGES", messages);
      messages.forEach(msg => messageListener(msg));
    });
  }

  function sendMessage(obj) {
    sendJson('/uno/message', {
      clientId,
      content: obj
    });
  }

  function makeid(length) {
    var result = '';
    var characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
    var charactersLength = characters.length;
    for (var i = 0; i < length; i++) {
      result += characters.charAt(Math.floor(Math.random() * charactersLength));
    }
    return result;
  }


  var room = {
    setOnMessageListener(listener) {
      messageListener = listener;
    },
    send(msg) {
      sendMessage(msg);
    }
  };

  function showResults(gewinner, times) {
    sperren[0] = true;
    if (spielerIch == gewinner) {
      console.log("Du hast gewonnen!!!");
      if (times == 0) audio = new Audio("http://soundbible.com/mp3/Ta Da-SoundBible.com-1884170640.mp3").play();
        canvas.fillStyle = "green";
        canvas.fillRect(0, 0, 1847, 973);
        Bild.src = "http://adi.nicolaiweitkemper.de/Bilder/Gewinnerbildschirm.jpeg";
        canvas.drawImage(Bild, 260, 0);
    } else {
      console.log("Du hast verloren!!!");
      canvas.fillStyle = "red";
      canvas.fillRect(0, 0, 1847, 973)
      Bild.src = "http://adi.nicolaiweitkemper.de/Bilder/Verloren%20Bildschirm.jpg"
      canvas.drawImage(Bild, 260, 0);
      if (times == 0)  audio = new Audio("http://adi.nicolaiweitkemper.de/Sounds/FAIL%20SOUND%20EFFECT.mp3").play();
    }
    setTimeout(function () {
      if (times < 5) showResults(gewinner, times + 1);
    }, 500);
  }
  // listen to patches coming from the server
  room.setOnMessageListener(function(message) {
    if (message.type == "AnzahlSpieler") AnzahlSpieler = message.data;
    if (message.type == "kartenAbgelegt") {spieler.kartenAbgelegt = message.data; Layout(0)}
    if (message.type == "plus" && message.empfänger == spielerIch)  getCard(spieler[spielerIch].cards, message.data);
    if (message.type == "gewonnen") showResults(message.data, 0);
    if (message.type == "spielerIch") {
          if (spieler[spielerIch].cards.length == 0) {
            room.send({
              message: {
              type: "gewonnen",
              data: spielerIch
            }
            });
            sperren[0] = true;
          }
      if (sperren[0] == false) {
      for (var i = 0; i < Object.keys(message.data[0]).length; i++) {
        spieler[message.sender][Object.keys(message.data[0])[i]] = message.data[0][Object.keys(message.data[0])[i]];
      }
      for (var i = 0; i + 4 < Object.keys(spieler).length; i++) {
        spieler[Object.keys(spieler)[i+4]] = message.data[1][i];
      }
      spielerAktuell = nextPlayer(spielerAktuell);
      if (spieler.kartenAbgelegt[spieler.kartenAbgelegt.length - 1][1] == "aussetzen") spielerAktuell = nextPlayer(spielerAktuell);
      Layout(0)
      if (spielerAktuell == spielerIch) {
      new Audio("https://adi.nicolaiweitkemper.de/Sounds/Elevator-ding-dong-sound-effect%20(Spielerwechsel).mp3").play();
      var notification = new Notification("It's your turn again! ", {
        icon: 'https://proxy.duckduckgo.com/iu/?u=http%3A%2F%2Fthumbs.dreamstime.com%2Fz%2Fcheerful-man-pointing-towards-camera-young-caucasian-you-isolated-white-32991170.jpg&f=1&nofb=1',
        body: "Come back to destroy the enemy(s)!",
      });
      autoZiehen();
    }
  }
    }
    if (message.type == "spielerDu") {
      spielerIch = message.data;
      spieler[spielerIch].cards = [];
      getCard(spieler[spielerIch].cards, 5);
      if (spielerIch == AnzahlSpieler - 1) {getCard(spieler.kartenAbgelegt, 1);
        room.send({
          message: {
          type: "kartenAbgelegt",
          data: spieler.kartenAbgelegt
        }
        });
      }
      Layout(0)
    }
    if (message.type == "Reihenfolge") {
      spielerAktuell = message.data;
      if (AnzahlSpieler == 2 && spielerIch == 0) {
        spielerGegner = 1;
      } else if (AnzahlSpieler == 2) {
        spielerGegner = 0;
      }
      if (spielerAktuell == spielerIch) new Audio("https://adi.nicolaiweitkemper.de/Sounds/Elevator-ding-dong-sound-effect%20(Spielerwechsel).mp3").play();
    }
  });

  class player {
    constructor() {
      this.cards = [];
    }
  }
  function autoZiehen() {
    AblageListe[0] = 0;
    for (var i = 0; i < spieler[spielerIch].cards.length; i++) {
      if ((spieler[spielerIch].cards[i][0] == spieler.kartenAbgelegt[spieler.kartenAbgelegt.length - 1][0] || spieler[spielerIch].cards[i][1] == spieler.kartenAbgelegt[spieler.kartenAbgelegt.length - 1][1] || spieler[spielerIch].cards[i][0] == "silver" || spieler.kartenAbgelegt[spieler.kartenAbgelegt.length - 1][0] == "silver")) AblageListe[0]++;
    }
    if (AblageListe[0] == 0) {
    new Audio("https://adi.nicolaiweitkemper.de/Sounds/Fail%20-%20N%C3%B6%C3%B6t.mp3").play();
    getCard(spieler[spielerIch].cards, 1);
    if (spieler[spielerIch].cards[spieler[spielerIch].cards.length - 1][0] == spieler.kartenAbgelegt[spieler.kartenAbgelegt.length - 1][0] || spieler[spielerIch].cards[spieler[spielerIch].cards.length - 1][1] == spieler.kartenAbgelegt[spieler.kartenAbgelegt.length - 1][1] || spieler[spielerIch].cards[spieler[spielerIch].cards.length - 1][0] == "silver" || spieler.kartenAbgelegt[spieler.kartenAbgelegt.length - 1][0] == "silver") {playCard(spieler[spielerIch].cards[spieler[spielerIch].cards.length - 1], spieler[spielerIch].cards.length - 1)
    }
    else spielerwechsel();
    }
  }
  function spielerwechsel() {
    AblageListe[0] = [];
    for (var i = 4; i < Object.keys(spieler).length; i++) {
      AblageListe[0].push(spieler[Object.keys(spieler)[i]]);
    }
      room.send({
        message: {
        type: "spielerIch",
        data: [spieler[spielerIch], AblageListe[0]],
        sender: spielerIch
      }
      });
  }
  function Layout(times) {
    canvas.fillStyle = "brown"
    canvas.fillRect(0,0,2000,1000)
    for (var i = 0; i < AnzahlSpieler; i++) {
      if (!(i == spielerIch)) {
        canvas.fillStyle = "white";
        canvas.fillRect(33 + 177*i, 33, 111, 133);
        canvas.fillStyle = "brown";
        canvas.font = "77px Georgia";
        canvas.fillText(spieler[i].cards.length, 66 + 177*i, 122);
      }
    }
    canvas.fillStyle = "white";
    canvas.fillRect(33 + 177*spielerAktuell, 33 + 177, 111, 33);
    spieler[spielerIch].cards.sort();
    for (var i = 0; i < spieler[spielerIch].cards.length; i++) {
      showCard(55 + 177*i, 555, spieler[spielerIch].cards[i]);
    }
    showCard(700, 277, spieler.kartenAbgelegt[spieler.kartenAbgelegt.length - 1]);
    if (times < 5) {
      setTimeout(function () {
        Layout(times + 1)
      }, 500);
    }
    }
  // get card player me: getCard(spieler[spielerIch].cards, 1);
  function getCard(who, times) {
    for (var i = 0; i < times; i++) {
    AblageListe[0] = [];
    AblageListe[0][0] = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, "plus2", "aussetzen", "Richtungswechsel", "plus4", "wunschFarbe"];
    AblageListe[0][1] = ["green", "blue", "red", "yellow"];
    AblageListe[2] = Math.round(Math.random() * (AblageListe[0][0].length - 1));
    console.log(AblageListe[2]);
    if (AblageListe[2] < 13) who.push([AblageListe[0][1][Math.round(Math.random() * (AblageListe[0][1].length - 1))], AblageListe[0][0][AblageListe[2]]]);
    else who.push(["silver", AblageListe[0][0][AblageListe[2]]]);
    console.log("karteGezogen: " + who[who.length - 1]);
  }
  }
  function showCard(x,y,data) {
  if (!(isNaN(data[1])) || !(data[0] == "silver")) {
    if (!(data[1] == "plus4" || data[1] == "wunschFarbe")) {
    canvas.fillStyle = "white";
    canvas.fillRect(x - 22, y - 22, 100 + 44, 144 + 44);
    canvas.fillStyle = data[0];
    canvas.fillRect(x, y, 100, 144);
    if (!(isNaN(data[1]))) {
    canvas.fillStyle = "white";
    canvas.font = "77px Georgia";
    canvas.fillText(data[1], x + 27, y + 99);
  }
  else {
    Bild = new Image();
    Bild.src = "https://adi.nicolaiweitkemper.de/Bilder/Uno/" + data[1] + ".png";
    canvas.drawImage(Bild, x + 11, y + 22, 666, 500);
  }
}
  else {
    canvas.fillStyle = data[0];
    canvas.fillRect(x - 22, y - 20, 100 + 44 - 20, 144 + 37);
    Bild = new Image();
    Bild.src = "https://adi.nicolaiweitkemper.de/Bilder/Uno/" + data[1] + "Farbwunsch.png";
    canvas.drawImage(Bild, x - 22, y - 22, 188*4 - 99, 188*2);
  }
  }
  else if (data[0] == "silver") {
    Bild = new Image();
    Bild.src = "https://adi.nicolaiweitkemper.de/Bilder/Uno/" + data[1] + ".png";
    canvas.drawImage(Bild, x - 22, y - 22, 188*4 - 99, 188*2);
  }
  }
// showCard(700, 333, spieler.kartenAbgelegt);
// showCard(55, 555, spieler.kartenAbgelegt);
function nextPlayer(NextPlayer) {
  if (spieler.playDirection == "right") NextPlayer++;
  else NextPlayer--;
  if (spieler.playDirection == "right" && NextPlayer == AnzahlSpieler) NextPlayer = 0;
  else if (NextPlayer == -1) NextPlayer = AnzahlSpieler - 1;
  return NextPlayer;
}
function playCard(data, card) {
  if (data[0] == spieler.kartenAbgelegt[spieler.kartenAbgelegt.length - 1][0] || data[1] == spieler.kartenAbgelegt[spieler.kartenAbgelegt.length - 1][1] || data[0] == "silver" || spieler.kartenAbgelegt[spieler.kartenAbgelegt.length - 1][0] == "silver") {
    console.log("cardOK");
    // "plus2", "aussetzen", "Richtungswechsel", "plus4", "wunschFarbe"
    if (isNaN(data[1]) && data[1].includes("plus")) {
      room.send({
        message: {
        type: "plus",
        data: data[1].toString().split('plus')[1],
        empfänger: nextPlayer(spielerAktuell)
      }
      });
    }
    AblageListe[0] = {right: "left", left: "right"};
    // if (data[1] == "Richtungswechsel") {
    //   if (AnzahlSpieler == 2) spielerAktuell--;
    //   else spieler.playDirection = AblageListe[0][spieler.playDirection];
    //   if (spielerAktuell < 0) spielerAktuell = 1;
    // };
    if (data[1] == "wunschFarbe" || data[1] == "plus4") data[0] = farbwunsch();
    spieler.kartenAbgelegt.push(data);
    spieler[spielerIch].cards.splice([card], 1);
    if (!(data[1] == "aussetzen" || (AnzahlSpieler == 2 && data[1] == "Richtungswechsel")))  spielerwechsel();
    else {
      Layout(0);
      autoZiehen();
    }
  }
  else {
    console.log("wrong card");
  }
}
function farbwunsch() {
  AblageListe[0] = prompt("Welche Farbe wünschen sie sich? (bitte in Englisch eingeben)");
  if (AblageListe[0] == "red" || AblageListe[0] == "green" || AblageListe[0] == "blue" || AblageListe[0] == "yellow") return AblageListe[0];
  else {
    alert("Eingabe ungültig! Bitte erneut eingeben!");
    farbwunsch();
  }
}
var spieler = [];
for (var i = 0; i < 4; i++) {
  spieler[i] = new player;
}
spieler.kartenAbgelegt = [];
spieler.playDirection = "right";
// var f = function() {
//   var eventHandler = function(event) {
//     //    console.log(window.scrollX + " - " + window.scrollY);
//     hinzufügenX = window.scrollX;
//     hinzufügenY = window.scrollY;
//   };
//   window.addEventListener('scroll', eventHandler, false)
// };
// window.addEventListener('DOMContentLoaded', f, false)
function readMouseMove(e) {
  xMaus = e.clientX + window.scrollX;;
  yMaus = e.clientY + window.scrollY;
  //  console.log(xMaus + " - " + yMaus);
}
document.onmousemove = readMouseMove
window.addEventListener('mousedown', function() {
  for (var i = 0; i < spieler[spielerIch].cards.length; i++) {
    // (55 + 177*i - 22, 555 - 22, 100 + 44, 144 + 44);
    if (xMaus > 55 + 177*i - 22 && xMaus < 55 + 177*i - 22 + 144 && yMaus > 555 - 22 && yMaus < 555 - 22 + 188 && spielerIch == spielerAktuell) {
      console.log(i);
      playCard(spieler[spielerIch].cards[i], i);
    }
  }
});

</script>
