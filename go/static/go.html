<meta charset="utf-8">
<div class="" id="fieldSelection">
  <h1 id="field size">field size</h1>
  <input type="text" placeholder="x" value="8" id="fieldSizeX"></input>
  <input type="text" placeholder="y" value="8" id="fieldSizeY""></input>
  <input type="text" placeholder="points required for win" value="5" id="pointsRequiredForWin"></input>
</div>
<br>
<canvas id="textur" width="2570" height="888" style="touch-action: none" onclick="canvasClicked();"></canvas>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script>
  if (navigator.userAgent.match(/Android/i) ||
  navigator.userAgent.match(/webOS/i) ||
  navigator.userAgent.match(/iPhone/i) ||
  navigator.userAgent.match(/iPad/i) ||
  navigator.userAgent.match(/iPod/i) ||
  navigator.userAgent.match(/BlackBerry/i) ||
  navigator.userAgent.match(/Windows Phone/i)
) {
  var gerät = "Handy"
  console.log("Handy");
} else {
  var gerät = "PC"
  console.log("PC");
}
  async function sendJson(url = "/", body = {}) {
    const rawResponse = await fetch(url, {
      method: 'POST',
      headers: {
        'Accept': 'application/json',
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(body)
    });
    const content = await rawResponse.json();
    return content;
  }
  // sendJson('/logout', {
  //   clientId
  // });

  const clientId = makeid(10);
  var messageListener = null;

  async function register() {
    let response = sendJson('/go/login', {
      clientId
    });
  }

  register();
  setInterval(getMessages, 3000);

  function getMessages() {
    sendJson('/go/message-queue', {
      clientId
    }).then(messages => {
      if (messages.length > 0) console.log("MESSAGES", messages);
      messages.forEach(msg => messageListener(msg));
    });
  }

  function sendMessage(obj) {
    sendJson('/go/message', {
      clientId,
      content: obj
    });
  }

  function makeid(length) {
    var result = '';
    var characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
    var charactersLength = characters.length;
    for (var i = 0; i < length; i++) {
      result += characters.charAt(Math.floor(Math.random() * charactersLength));
    }
    return result;
  }


  var room = {
    setOnMessageListener(listener) {
      messageListener = listener;
    },
    send(msg) {
      sendMessage(msg);
    }
  };
  window.onbeforeunload = function() {
    console.log("Leave Website");
    sendJson('/go/logout', {
      clientId
    });
    return 'Are you sure you want to leave?';
  };
  var ids = [];
  var id = "";
  var idGegner = "";
  var fieldParameters = [];
  var field = [];
  var canvas = textur.getContext('2d'); //Dimension
  var AblageListe = [];
  var points = {};
  var audio;
  var Bild;

  room.setOnMessageListener(function(message) {
    console.log(message);
    if (message.type == undefined) {
      console.log(message);
    }
    if (message.type == "map") {field = message.data; Layout();}
    else if (message.type == "points") {points[idGegner] = message.data[idGegner];}
    else if (message.type == "Reihenfolge") {
      ids = message.data;
      if (name == ids[0] && idGegner == "") {
        idGegner = ids[1];
      } else if (idGegner == "") {
        idGegner = ids[0];
      }
    }
    else if (message.type == "settings" && message.sender != id) {
      document.getElementById('fieldSelection').style.display = "none";
      fieldParameters[0] = Math.round((JSON.parse(document.getElementById('fieldSizeX').value) + JSON.parse(message.data.map[0]))/2);
      fieldParameters[1] =  Math.round((JSON.parse(document.getElementById('fieldSizeY').value) + JSON.parse(message.data.map[1]))/2);
      points.required = Math.round((JSON.parse(document.getElementById('pointsRequiredForWin').value) + JSON.parse(message.data.points))/2);
      console.log(fieldParameters);
      for (var i = 0; i < fieldParameters[1]; i++) {
        for (var i1 = 0; i1 < fieldParameters[0]; i1++) {
          if (field[i] == undefined) field[i] = [];
          field[i][i1] = "none";
        }
      }
      console.log(field);
      Layout();
    }
    else if (message.type == "name") {
      id = message.data;
      points[id] = 0;
      points[idGegner] = 0;
      alert("You have 5 more seconds to change your settings! After it, the middle between the settings of the two players will be chosen.");
      setTimeout(function () {
        room.send({
          message: {
          type: "settings",
          data: {map: [document.getElementById('fieldSizeX').value, document.getElementById('fieldSizeY').value], points:  document.getElementById('pointsRequiredForWin').value},
          sender: id
        }
        });
      }, 5000);
    }
    else if (message.type == undefined && message.includes("wins") && !(message.includes(id))) {
      console.log("verloren :(");
      showResults("https://adi.nicolaiweitkemper.de/Bilder/Verloren%20Bildschirm.jpg", "https://adi.nicolaiweitkemper.de/Sounds/FAIL%20SOUND%20EFFECT.mp3", "red", 0);
    }
    else if (message.type == undefined && message.includes("wins") && message.includes(id)) {
      console.log("gewonnen :)");
      showResults("https://adi.nicolaiweitkemper.de/Bilder/Gewinnerbildschirm.jpeg", "https://soundbible.com/mp3/Ta Da-SoundBible.com-1884170640.mp3", "green", 0);
    }
  });
  if (gerät == "Handy") {
  $('head').append('<link rel="stylesheet" href="https://adi.nicolaiweitkemper.de/von2Zu4Handy.css" type="text/css" />');
}
/*
if (Zustand[Zustand.length - 1] == SpielerId + "gewonnen") {
  Sperren[2] = true;
  console.log("Du hast gewonnen!!!");
  clearInterval(koordinatenCheck);
  audio = new Audio("http://soundbible.com/mp3/Ta Da-SoundBible.com-1884170640.mp3").play();
  setTimeout(function() {
    canvas.fillStyle = "green";
    canvas.fillRect(0, 0, 1847, 973)
    Bild.src = "http://adi.nicolaiweitkemper.de/Bilder/Gewinnerbildschirm.jpeg"
    canvas.drawImage(Bild, 260, 0);
    setTimeout(function() {
      canvas.drawImage(Bild, 260, 0);
      Sperren[2] = true;
    }, 100);
  }, 700);
} else if (Zustand[Zustand.length - 1].includes("gewonnen")) {
  console.log("Du hast verloren!!!");
  Sperren[2] = true;
  clearInterval(koordinatenCheck);
  canvas.fillStyle = "red";
  canvas.fillRect(0, 0, 1847, 973)
  Bild.src = "http://adi.nicolaiweitkemper.de/Bilder/Verloren%20Bildschirm.jpg"
  canvas.drawImage(Bild, 260, 0);
  audio = new Audio("http://adi.nicolaiweitkemper.de/Sounds/FAIL%20SOUND%20EFFECT.mp3").play();
  setTimeout(function() {
    canvas.drawImage(Bild, 260, 0);
    Sperren[2] = true;
  }, 100);
}
*/
function showResults(picture, sounds, colour, time) {
  if (time == 0) audio = new Audio(sounds).play();
  canvas.fillStyle = colour;
  canvas.fillRect(0, 0, 1847, 973);
  Bild = new Image();
  Bild.src = picture;
  canvas.drawImage(Bild, 260, 0);
  if (time < 5) showResults(picture, sounds, colour, time + 1);
}
function Layout() {
  canvas.fillStyle = "#B45F04";
  canvas.fillRect(0, 0, 10 + fieldParameters[1]*70, 10 + fieldParameters[0]*70);
  for (var i = 0; i < fieldParameters[1]; i++) {
    for (var i1 = 0; i1 < fieldParameters[0]; i1++) {
      canvas.fillStyle = "#FF8000";
      canvas.fillRect(10 + 70*i1, 10 + 70*i, 60, 60);
      if (field[i1][i] != "none") {
        if (field[i1][i] == id) canvas.fillStyle = "black";
        else                    canvas.fillStyle = "white";
        canvas.beginPath();
        canvas.arc(10 + 70*i1 + 30, 10 + 70*i + 30,30,0,Math.PI*2, false);
        canvas.fill();
      }
    }
  }
}

function canvasClicked() {
  fieldClicked();
  if (ids[0] == id && AblageListe[0] != "none" && field[AblageListe[0][0]][AblageListe[0][1]] == "none") {
    field[AblageListe[0][0]][AblageListe[0][1]] = id;
    checkUmzingelt();
    room.send({
      message: {
      type: "map",
      data: field,
      sender: id
    }
    });
    console.log(points.required + " - " + points[id]);
    room.send({
      message: {
      type: "points",
      data: points,
      sender: id,
      requiredPoints: points.required
    }
    });
    room.send({
      message: {
      type: "Reihenfolge",
      data: [ids[1], ids[0]]
    }
    });
    Layout();
  }
}
function checkUmzingelt() {
  for (var i = 0; i < fieldParameters[1]; i++) {
    for (var i1 = 0; i1 < fieldParameters[0]; i1++) {
      if (field[i1][i] != id && i1 > 0 && i1 + 1 < fieldParameters[0] && i > 0 && i + 1 < fieldParameters[1] && field[i1 - 1][i] == id && field[i1][i + 1] == id && field[i1 + 1][i] == id && field[i1][i - 1] == id) {
        field[i1][i] = "none";
        points[id]++;
      }
    }
  }
  // TODO: muteble fields "umzingelt" (zur Vorstellung: )
  /*
  xxxxx xxxxxxx
x     x       x
 xxxxx xxxxxxx
  */
}
function fieldClicked() {
  AblageListe[0] = "none";
  for (var i = 0; i < fieldParameters[1]; i++) {
    for (var i1 = 0; i1 < fieldParameters[0]; i1++) {
      if (mausx > 9 + 10 + 70*i && mausx < 9 + 10 + 70*i + 70 && mausy > 28 + 10 + 70*i1 && mausy < 28 + 10 + 70*i1 + 70) {console.log(i + " - " + i1); AblageListe[0] = [i, i1];}
    }
  }
}
function readMouseMove(e) {
  mausx = e.clientX + scrollX;
  mausy = e.clientY + scrollY;
  //  console.log(mausx + " - " + mausy);
}
document.onmousemove = readMouseMove
</script>
